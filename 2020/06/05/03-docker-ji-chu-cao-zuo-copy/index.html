<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="03-k8s集群的安装, 自然语言处理 深度学习 算法码上来">
    <meta name="baidu-site-verification" content="fmlEuI34ir">
    <meta name="google-site-verification" content="yCy2azpds5XSuGZvis6OuA-XIGF5GuGpYRAaGfD6o48">
    <meta name="360-site-verification" content="b7c11a830ef90fd1464ad6206bb7b6e7">
    <meta name="description" content="1:k8s集群的安装1.1 k8s的架构通常我们都是通过 kubectl 对 Kubernetes 下命令的，它通过 APIServer 去调用各个进程来完成对 Node 的部署和控制。

APIServer 的核心功能是对核心对象（例如：">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>03-k8s集群的安装 | 小明同学</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?46e79e71af0709a5b9106bf20cecc493";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

    
        <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
        </script>
    

    <script>
        (function(){
        var src = "https://jspassport.ssl.qhimg.com/11.0.1.js?d182b3f28525f2db83acfaaf6e696dba";
        document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">小明同学</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <i class="fa fa-comments"></i>
            
            <span>留言板</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">小明同学</div>
        <div class="logo-desc">
            
            计算机科学与技术 | 自然语言处理
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-comments"></i>
                
                留言板
            </a>
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/29.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        03-k8s集群的安装
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                        <a href="/tags/leetcode/" target="_blank">
                            <span class="chip bg-color">leetcode</span>
                        </a>
                        
                        <a href="/tags/云计算/" target="_blank">
                            <span class="chip bg-color">云计算</span>
                        </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                        <a href="/categories/k8s/" class="post-category" target="_blank">
                            k8s
                        </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-06-05
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                    小明
                    
                </div>

                
                
                <div class="info-break-policy">
                    <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                    13.7k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    69 分
                </div>
                
                

                
                <div id="busuanzi_container_page_pv" class="info-break-policy">
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv"></span>
                </div>
                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="1-k8s集群的安装"><a href="#1-k8s集群的安装" class="headerlink" title="1:k8s集群的安装"></a>1:k8s集群的安装</h2><h3 id="1-1-k8s的架构"><a href="#1-1-k8s的架构" class="headerlink" title="1.1 k8s的架构"></a>1.1 k8s的架构</h3><pre class="line-numbers language-powershell"><code class="language-powershell">通常我们都是通过 kubectl 对 Kubernetes 下命令的，它通过 APIServer 去调用各个进程来完成对 Node 的部署和控制。

APIServer 的核心功能是对核心对象（例如：Pod，Service，RC）的增删改查操作，同时也是集群内模块之间数据交换的枢纽。

etcd 包含在 APIServer 中，用来存储资源信息。接下来就是 Controller Manager 了，如果说 Kubernetes 是一个自动化运行的系统，那么就需要有一套管理规则来控制这套系统。


Controller Manager 就是这个管理者，或者说是控制者。它包括 8 个 Controller，分别对应着副本，节点，资源，命名空间，服务等等

紧接着，Scheduler 会把 Pod 调度到 Node 上，调度完以后就由 kubelet 来管理 Node 了。


kubelet 用于处理 Master 下发到 Node 的任务（即 Scheduler 的调度任务），同时管理 Pod 及 Pod 中的容器。


在完成资源调度以后，kubelet 进程也会在 APIServer 上注册 Node 信息，定期向 Master 汇报 Node 信息，并通过 cAdvisor 监控容器和节点资源。


由于，微服务的部署都是分布式的，所以对应的 Pod 以及容器的部署也是。为了能够方便地找到这些 Pod 或者容器，引入了 Service（kube<span class="token operator">-</span>proxy）进程，它来负责反向代理和负载均衡的实施。

参考文献
https:<span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>cnblogs<span class="token punctuation">.</span>com<span class="token operator">/</span>Tao9<span class="token operator">/</span>p<span class="token operator">/</span>12026232<span class="token punctuation">.</span>html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>除了核心组件，还有一些推荐的Add-ons：</p>
<table>
<thead>
<tr>
<th><strong>组件名称</strong></th>
<th align="center"><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>kube-dns</strong></td>
<td align="center">负责为整个集群提供DNS服务</td>
</tr>
<tr>
<td><strong>Ingress Controller</strong></td>
<td align="center">为服务提供外网入口</td>
</tr>
<tr>
<td><strong>Heapster</strong></td>
<td align="center">提供资源监控</td>
</tr>
<tr>
<td><strong>Dashboard</strong></td>
<td align="center">提供GUI</td>
</tr>
<tr>
<td><strong>Federation</strong></td>
<td align="center">提供跨可用区的集群</td>
</tr>
<tr>
<td><strong>Fluentd-elasticsearch</strong></td>
<td align="center">提供集群日志采集、存储与查询</td>
</tr>
</tbody></table>
<h3 id="1-2：修改IP地址、主机名和host解析"><a href="#1-2：修改IP地址、主机名和host解析" class="headerlink" title="1.2：修改IP地址、主机名和host解析"></a>1.2：修改IP地址、主机名和host解析</h3><pre class="line-numbers language-powershell"><code class="language-powershell">10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11  k8s<span class="token operator">-</span>master
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12  k8s<span class="token operator">-</span>node<span class="token operator">-</span>1
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>13  k8s<span class="token operator">-</span>node<span class="token operator">-</span>2

scp  <span class="token operator">/</span>etc<span class="token operator">/</span>hosts  10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>13:<span class="token operator">/</span>etc<span class="token operator">/</span>hosts <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>所有节点需要做hosts解析</p>
<h3 id="1-3：master节点安装-etcd"><a href="#1-3：master节点安装-etcd" class="headerlink" title="1.3：master节点安装==etcd=="></a>1.3：master节点安装==etcd==</h3><blockquote>
<p><strong>etcd的官方将它定位成一个可信赖的分布式键值存储服务，它能够为整个分布式集群存储</strong></p>
<p><strong>-一些关键数据，协助分布式集群的正常运转</strong></p>
</blockquote>
<pre class="line-numbers language-CQL"><code class="language-CQL">https://www.cnblogs.com/linuxws/p/11194403.html 参数介绍文档<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token function">rm</span> <span class="token operator">-</span>fr <span class="token operator">/</span>etc<span class="token operator">/</span>yum<span class="token punctuation">.</span>repos<span class="token punctuation">.</span>d<span class="token operator">/</span>local<span class="token punctuation">.</span>repo
curl <span class="token operator">-</span>o <span class="token operator">/</span>etc<span class="token operator">/</span>yum<span class="token punctuation">.</span>repos<span class="token punctuation">.</span>d<span class="token operator">/</span>CentOS<span class="token operator">-</span>Base<span class="token punctuation">.</span>repo http:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>repo<span class="token operator">/</span>Centos<span class="token operator">-</span>7<span class="token punctuation">.</span>repo

<span class="token namespace">[root@k8s-matser /etc/yum.repos.d]</span> <span class="token comment" spellcheck="true"># yum install etcd -y</span>

<span class="token namespace">[root@k8s-matser /k8s_yaml]</span><span class="token comment" spellcheck="true"># vim /etc/etcd/etcd.conf</span>
<span class="token operator">--</span>储存的目录 <span class="token operator">--</span>类似于mangge数据库
3 ETCD_DATA_DIR=<span class="token string">"/var/lib/etcd/default.etcd"</span>

<span class="token operator">--</span>etcd 对外提供服务的地址。
6行：ETCD_LISTEN_CLIENT_URLS=<span class="token string">"http://0.0.0.0:2379"</span>

<span class="token operator">--</span>对外公告的该节点客户端监听地址。也就是连接本地地址<span class="token operator">-</span>集群名字<span class="token operator">-</span>不可相同
21行：ETCD_ADVERTISE_CLIENT_URLS=<span class="token string">"http://10.0.0.11:2379"</span>

<span class="token namespace">[root@k8s-matser /k8s_yaml]</span> <span class="token comment" spellcheck="true"># systemctl start etcd.service</span>
<span class="token namespace">[root@k8s-matser /k8s_yaml]</span> <span class="token comment" spellcheck="true"># systemctl enable etcd.service</span>
<span class="token operator">--</span>2379<span class="token operator">-</span>端口 <span class="token operator">--</span>2380  端口集群同步

<span class="token operator">--</span>数据库演示一个值<span class="token operator">-</span>get key <span class="token function">set</span><span class="token operator">-</span>key 
<span class="token namespace">[root@k8s-matser /k8s_yaml]</span> <span class="token comment" spellcheck="true"># etcdctl set testdir/testkey0 0</span>
<span class="token namespace">[root@k8s-matser /k8s_yaml]</span> <span class="token comment" spellcheck="true"># etcdctl get testdir/testkey0</span>

<span class="token operator">--</span>检查集群监控状态
<span class="token namespace">[root@k8s-matser /k8s_yaml]</span> <span class="token comment" spellcheck="true"># etcdctl -C http://10.0.0.11:2379 cluster-health</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>==etcd原==生支持做集群，</p>
<p>作业1：安装部署etcd集群，要求三个节点</p>
<h3 id="1-4：master节点安装kubernetes"><a href="#1-4：master节点安装kubernetes" class="headerlink" title="1.4：master节点安装kubernetes"></a>1.4：master节点安装kubernetes</h3><pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@k8s-matser /k8s_yaml]</span> <span class="token comment" spellcheck="true">#  yum install kubernetes-master.x86_64 -y</span>

<span class="token namespace">[root@k8s-matser /k8s_yaml]</span> <span class="token comment" spellcheck="true">#  vim /etc/kubernetes/apiserver </span>

8行:  KUBE_API_ADDRESS=<span class="token string">"--insecure-bind-address=0.0.0.0"</span> <span class="token comment" spellcheck="true">#监听端口</span>
11行：KUBE_API_PORT=<span class="token string">"--port=8080"</span>    <span class="token comment" spellcheck="true"># 端口</span>
14行: KUBELET_PORT=<span class="token string">"--kubelet-port=10250"</span> <span class="token comment" spellcheck="true">#kubelet-随从监听端口</span>
17行：KUBE_ETCD_SERVERS=<span class="token string">"--etcd-servers=http://10.0.0.11:2379"</span> <span class="token comment" spellcheck="true"># ecd 集群位置，号隔开 http,</span>
23行：KUBE_ADMISSION_CONTROL=<span class="token string">"--admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ResourceQuota"</span>
<span class="token comment" spellcheck="true">#管理控制删除了ser账号控制</span>

<span class="token namespace">[root@k8s-matser /etc/yum.repos.d]</span> <span class="token comment" spellcheck="true"># vim /etc/kubernetes/config</span>
22行：KUBE_MASTER=<span class="token string">"--master=http://10.0.0.11:8080"</span> <span class="token comment" spellcheck="true">#apiser地址</span>

systemctl enable kube<span class="token operator">-</span>apiserver<span class="token punctuation">.</span>service
systemctl restart kube<span class="token operator">-</span>apiserver<span class="token punctuation">.</span>service
systemctl enable kube<span class="token operator">-</span>controller<span class="token operator">-</span>manager<span class="token punctuation">.</span>service
systemctl restart kube<span class="token operator">-</span>controller<span class="token operator">-</span>manager<span class="token punctuation">.</span>service
systemctl enable kube<span class="token operator">-</span>scheduler<span class="token punctuation">.</span>service
systemctl restart kube<span class="token operator">-</span>scheduler<span class="token punctuation">.</span>service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>检查服务是否安装正常</p>
<pre class="line-numbers language-scss"><code class="language-scss">[root<span class="token atrule"><span class="token rule">@k8s-master</span> ~]# kubectl get componentstatus 
NAME                 STATUS    MESSAGE             ERROR
scheduler            Healthy   ok                  
controller-manager   Healthy   ok                  
etcd-<span class="token number">0</span>               Healthy</span>   <span class="token punctuation">{</span><span class="token string">"health"</span><span class="token punctuation">:</span><span class="token string">"true"</span><span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="1-5：node节点安装kubernetes"><a href="#1-5：node节点安装kubernetes" class="headerlink" title="1.5：node节点安装kubernetes"></a>1.5：node节点安装kubernetes</h3><pre class="line-numbers language-scss"><code class="language-scss">[root@k<span class="token number">8</span>s-node-<span class="token number">1</span> ~] # yum install kubernetes-node<span class="token number">.</span>x<span class="token number">86</span>_<span class="token number">64</span> -y

[root@k<span class="token number">8</span>s-node-<span class="token number">1</span> ~] # vim /etc/kubernetes/config 
<span class="token number">22</span>行：KUBE_MASTER=<span class="token string">"--master=http://10.0.0.11:8080"</span> #指向apiser的地址

[root@k<span class="token number">8</span>s-node-<span class="token number">1</span> ~] # vim /etc/kubernetes/kubelet
<span class="token number">5</span>行：KUBELET_ADDRESS=<span class="token string">"--address=0.0.0.0"</span>  # 监听地址
<span class="token number">8</span>行：KUBELET_PORT=<span class="token string">"--port=10250"</span>    # 端口跟服务端一直
<span class="token number">11</span>行：KUBELET_HOSTNAME=<span class="token string">"--hostname-override=10.0.0.12"</span> #每个节点名字唯一
<span class="token number">14</span>行：KUBELET_API_SERVER=<span class="token string">"--api-servers=http://10.0.0.11:8080"</span> # 找apiser地址
KUBELET_POD_INFRA_CONTAINER="--pod-infra-container-image=<span class="token number">10.0.0.</span><span class="token property">11</span><span class="token punctuation">:</span><span class="token number">5000</span>/<span class="token property">pod-infrastructure</span><span class="token punctuation">:</span>latest   重哪里拿容器镜像

[root@k<span class="token number">8</span>s-node-<span class="token number">1</span> ~] # systemctl enable kubelet<span class="token number">.</span>service
[root@k<span class="token number">8</span>s-node-<span class="token number">1</span> ~] # systemctl restart kubelet<span class="token number">.</span>service
[root@k<span class="token number">8</span>s-node-<span class="token number">1</span> ~] # systemctl enable kube-proxy<span class="token number">.</span>service
[root@k<span class="token number">8</span>s-node-<span class="token number">1</span> ~] # systemctl restart kube-proxy<span class="token number">.</span>service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在master节点检查</p>
<pre class="line-numbers language-CQL"><code class="language-CQL">[root@k8s-master ~]# kubectl get nodes
NAME        STATUS    AGE
10.0.0.12   Ready     6m
10.0.0.13   Ready     3s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="6：所有节点配置flannel网络"><a href="#6：所有节点配置flannel网络" class="headerlink" title="6：所有节点配置flannel网络"></a>6：所有节点配置flannel网络</h3><p>插件-实现容器跨主机访问–</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">所有节点安装网络插件<span class="token operator">-</span>实现容器跨主机访问<span class="token operator">--</span>

flannel  需要数据库 etcd
overlay  需要数据库 consul

<span class="token punctuation">[</span>所有节点<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum install flannel -y</span>
<span class="token punctuation">[</span>所有节点<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># sed -i 's#http://127.0.0.1:2379#http://10.0.0.11:2379#g' /etc/sysconfig/flanneld</span>


<span class="token comment" spellcheck="true">##master节点：</span>
<span class="token operator">--</span>创建key 必须的   tailf  <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>messages
<span class="token namespace">[root@k8s-matser /k8s_yaml]</span> <span class="token comment" spellcheck="true">#  etcdctl mk /atomic.io/network/config   '{ "Network": "172.18.0.0/16" }'</span>
<span class="token namespace">[root@k8s-matser /etc/yum.repos.d]</span> <span class="token comment" spellcheck="true"># systemctl  restart  flanneld.service </span>

<span class="token namespace">[root@k8s-matser /]</span> <span class="token comment" spellcheck="true"># yum install docker -y</span>
<span class="token namespace">[root@k8s-matser /]</span> <span class="token comment" spellcheck="true"># systemctl enable flanneld.service </span>
<span class="token namespace">[root@k8s-matser /]</span> <span class="token comment" spellcheck="true"># systemctl restart flanneld.service </span>
<span class="token namespace">[root@k8s-matser /]</span> <span class="token comment" spellcheck="true"># cat /usr/lib/systemd/system/docker.service.d/flannel.conf </span>
<span class="token namespace">[root@k8s-node-2 /]</span> <span class="token comment" spellcheck="true"># ifconfig  </span>
<span class="token namespace">[root@k8s-matser /]</span> <span class="token comment" spellcheck="true"># systemctl  restart  docker</span>
<span class="token namespace">[root@k8s-matser /]</span> <span class="token comment" spellcheck="true"># systemctl  enable  docker</span>
<span class="token namespace">[root@k8s-matser /]</span> <span class="token comment" spellcheck="true"># systemctl restart kube-apiserver.service</span>
<span class="token namespace">[root@k8s-matser /]</span> <span class="token comment" spellcheck="true"># systemctl restart kube-controller-manager.service</span>
<span class="token namespace">[root@k8s-matser /]</span> <span class="token comment" spellcheck="true"># systemctl restart kube-scheduler.service</span>
<span class="token operator">--</span>-<span class="token operator">-</span>测试夸主机访问
<span class="token comment" spellcheck="true">##node节点：</span>

systemctl enable flanneld<span class="token punctuation">.</span>service 
systemctl restart flanneld<span class="token punctuation">.</span>service 
systemctl  restart  docker
systemctl restart kubelet<span class="token punctuation">.</span>service
systemctl restart kube<span class="token operator">-</span>proxy<span class="token punctuation">.</span>service

<span class="token operator">--</span>端口设置iptables  docker 启动 docker 之后改动 iptable 规则 <span class="token operator">--</span><span class="token operator">-</span>所有的节点
<span class="token namespace">[root@k8s-node-2 /]</span> <span class="token comment" spellcheck="true"># vim /usr/lib/systemd/system/docker.service</span>
<span class="token comment" spellcheck="true">#在[Service]区域下增加一行</span>
ExecStartPost=<span class="token operator">/</span>usr<span class="token operator">/</span>sbin<span class="token operator">/</span>iptables <span class="token operator">-</span>P FORWARD ACCEPT
<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span><span class="token operator">-</span>

从启
systemctl daemon<span class="token operator">-</span>reload 
systemctl restart docker

启动容器ping 网络查看<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="7：配置master为镜像仓库"><a href="#7：配置master为镜像仓库" class="headerlink" title="7：配置master为镜像仓库"></a>7：配置master为镜像仓库</h3><pre class="line-numbers language-scss"><code class="language-scss">#所有节点  或者cp 

[root<span class="token atrule"><span class="token rule">@k8s-matser</span> /] # vi /etc/docker/daemon<span class="token number">.</span>json</span>
<span class="token punctuation">{</span>
<span class="token string">"registry-mirrors"</span><span class="token punctuation">:</span> [<span class="token string">"https://registry.docker-cn.com"</span>],
<span class="token string">"insecure-registries"</span><span class="token punctuation">:</span> [<span class="token string">"10.0.0.11:5000"</span>]
<span class="token punctuation">}</span>
---
信任加速
---
[root@k<span class="token number">8</span>s-node-<span class="token number">2</span> /] # systemctl restart docker

#master节点
[root@k<span class="token number">8</span>s-matser /] #   sz   registry<span class="token number">.</span>tar<span class="token number">.</span>gz
[root@k<span class="token number">8</span>s-matser /] #  docker load  -i   registry<span class="token number">.</span>tar<span class="token number">.</span>gz


[root@k<span class="token number">8</span>s-node-<span class="token number">2</span> /] # docker run -d -p <span class="token property">5000</span><span class="token punctuation">:</span><span class="token number">5000</span> --restart=always --name registry -v /opt/<span class="token property">myregistry</span><span class="token punctuation">:</span>/var/lib/registry  registry

   测试-打标签<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-什么是k8s-k8s有什么功能"><a href="#2-什么是k8s-k8s有什么功能" class="headerlink" title="2:什么是k8s,k8s有什么功能?"></a>2:什么是k8s,k8s有什么功能?</h2><p>k8s是一个docker集群的管理工具 </p>
<p>k8s是容器的编排工具</p>
<h3 id="2-1-k8s的核心功能"><a href="#2-1-k8s的核心功能" class="headerlink" title="2.1 k8s的核心功能"></a>2.1 k8s的核心功能</h3><p>==自愈:  重新==启动失败的容器，在节点不可用时，替换和重新调度节点上的容器，对用户定义的健康检查不响应的容器会被中止，并且在容器准备好服务之前不会把其向客户端广播。</p>
<p>==弹性伸缩:  通过监控容==器的cpu的负载值,如果这个平均高于80%,增加容器的数量,如果这个平均低于10%,减少容器的数量</p>
<p>服务的自动发现和负载均衡: 不需要修改您的应用程序来使用不熟悉的服务发现机制，Kubernetes 为容器提供了自己的 IP 地址和一组容器的单个 DNS 名称，并可以在它们之间进行负载均衡。</p>
<p>==滚动升级和一键回滚:==    Kubernetes 逐渐部署对应用程序或其配置的更改，同时监视应用程序运行状况，以确保它不会同时终止所有实例。 如果出现问题，Kubernetes会为您恢复更改，利用日益增长的部署解决方案的生态系统。</p>
<p>私密配置文件管理. web容器里面,数据库的账户密码(测试库密码)</p>
<h3 id="2-2-k8s的历史"><a href="#2-2-k8s的历史" class="headerlink" title="2.2 k8s的历史"></a>2.2 k8s的历史</h3><p>2014年  docker容器编排工具，立项</p>
<p>2015年7月  发布kubernetes 1.0, 加入cncf基金会   孵化</p>
<p>2016年，kubernetes干掉两个对手，docker swarm，mesos marathon  1.2版</p>
<p>2017年   1.5  -1.9</p>
<p>2018年   k8s 从cncf基金会  毕业项目1.10 1.11 1.12</p>
<p>2019年： 1.13, 1.14 ，1.15,1.16  1.17</p>
<p>cncf :cloud  native  compute  foundation 孵化器</p>
<p>kubernetes （k8s）: 希腊语 舵手，领航者  容器编排领域，</p>
<p>谷歌15年容器使用经验，borg容器管理平台，使用golang重构borg，kubernetes </p>
<h3 id="2-3-k8s的安装方式"><a href="#2-3-k8s的安装方式" class="headerlink" title="2.3 k8s的安装方式"></a>2.3 k8s的安装方式</h3><p>yum安装    1.5    最容易安装成功，最适合学习的</p>
<p>源码编译安装—难度最大  可以安装最新版</p>
<p>二进制安装—步骤繁琐    可以安装最新版       shell,ansible,saltstack</p>
<p>kubeadm    安装最容易, 网络    可以安装最新版</p>
<p>minikube    适合开发人员体验k8s,  网络</p>
<h3 id="2-4-k8s的应用场景"><a href="#2-4-k8s的应用场景" class="headerlink" title="2.4 k8s的应用场景"></a>2.4 k8s的应用场景</h3><pre class="line-numbers language-javascript"><code class="language-javascript">qcr<span class="token punctuation">.</span>io
# https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>oldqiang<span class="token punctuation">.</span>com<span class="token operator">/</span>archives<span class="token operator">/</span><span class="token number">624</span><span class="token punctuation">.</span>html  kubeadm     <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>k8s最==适合跑微服务项目==!</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">k8s最适合运行微服务。

软件的开发架构：
mvc：
<span class="token operator">-</span> <span class="token punctuation">[</span>秒杀<span class="token punctuation">]</span><span class="token punctuation">(</span>https:<span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>jd<span class="token punctuation">.</span>com<span class="token operator">/</span>miaosha
<span class="token operator">-</span> <span class="token punctuation">[</span>优惠券<span class="token punctuation">]</span><span class="token punctuation">(</span>https:<span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>jd<span class="token punctuation">.</span>com<span class="token operator">/</span>a
<span class="token operator">-</span> <span class="token namespace">[PLUS会员]</span><span class="token punctuation">(</span>https:<span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>jd<span class="token punctuation">.</span>com<span class="token operator">/</span>plus
<span class="token operator">-</span> <span class="token punctuation">[</span>品牌闪购<span class="token punctuation">]</span><span class="token punctuation">(</span>https:<span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>jd<span class="token punctuation">.</span>com<span class="token operator">/</span>red
<span class="token operator">-</span> <span class="token punctuation">[</span>拍卖<span class="token punctuation">]</span><span class="token punctuation">(</span>https:<span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>jd<span class="token punctuation">.</span>com<span class="token operator">/</span>paimai
<span class="token operator">-</span> <span class="token punctuation">[</span>京东家电<span class="token punctuation">]</span><span class="token punctuation">(</span>https:<span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>jd<span class="token punctuation">.</span>com<span class="token operator">/</span>jiadian
<span class="token operator">-</span> <span class="token punctuation">[</span>京东超市<span class="token punctuation">]</span><span class="token punctuation">(</span>https:<span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>jd<span class="token punctuation">.</span>com<span class="token operator">/</span>chaoshi
一个站点，实现所有功能，运行一套架构   10G

微服务：
<span class="token operator">-</span> <span class="token punctuation">[</span>秒杀<span class="token punctuation">]</span><span class="token punctuation">(</span>https:<span class="token operator">/</span><span class="token operator">/</span>miaosha<span class="token punctuation">.</span>jd<span class="token punctuation">.</span>com<span class="token operator">/</span>    运行一套架构  200M
<span class="token operator">-</span> <span class="token punctuation">[</span>优惠券<span class="token punctuation">]</span><span class="token punctuation">(</span>https:<span class="token operator">/</span><span class="token operator">/</span>a<span class="token punctuation">.</span>jd<span class="token punctuation">.</span>com<span class="token operator">/</span>        运行一套架构  200M
<span class="token operator">-</span> <span class="token namespace">[PLUS会员]</span><span class="token punctuation">(</span>https:<span class="token operator">/</span><span class="token operator">/</span>plus<span class="token punctuation">.</span>jd<span class="token punctuation">.</span>com    运行一套架构
<span class="token operator">-</span> <span class="token punctuation">[</span>品牌闪购<span class="token punctuation">]</span><span class="token punctuation">(</span>https:<span class="token operator">/</span><span class="token operator">/</span>red<span class="token punctuation">.</span>jd<span class="token punctuation">.</span>com<span class="token operator">/</span>    运行一套架构
<span class="token operator">-</span> <span class="token punctuation">[</span>拍卖<span class="token punctuation">]</span><span class="token punctuation">(</span>https:<span class="token operator">/</span><span class="token operator">/</span>paimai<span class="token punctuation">.</span>jd<span class="token punctuation">.</span>com<span class="token operator">/</span>     运行一套架构
<span class="token operator">-</span> <span class="token punctuation">[</span>京东家电<span class="token punctuation">]</span><span class="token punctuation">(</span>https:<span class="token operator">/</span><span class="token operator">/</span>jiadian<span class="token punctuation">.</span>jd<span class="token punctuation">.</span>com<span class="token operator">/</span>运行一套架构
<span class="token operator">-</span> <span class="token punctuation">[</span>京东超市<span class="token punctuation">]</span><span class="token punctuation">(</span>https:<span class="token operator">/</span><span class="token operator">/</span>chaoshi<span class="token punctuation">.</span>jd<span class="token punctuation">.</span>com<span class="token operator">/</span>运行一套架构
<span class="token operator">-</span> <span class="token punctuation">[</span>首页<span class="token punctuation">]</span> https:<span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>jd<span class="token punctuation">.</span>com<span class="token operator">/</span>  导航


一个功能一个站点，一个功能一个域名

微服务的好处：
支持更大的用户访问量
业务的稳定性更强
代码的更新和发布更加快捷

微服务对运维的影响：
工作量变大，ansible，自动化代码上线，ELK日志处理

k8s最适合运行微服务。

物理机 装系统，装运行环境，放入代码，维护，工作量变大<span class="token operator">*</span>4

开发环境 一套微服务
测试环境 一套微服务
预生产环境 一套微服务
生产环境   一套微服务<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="3-k8s常用的资源"><a href="#3-k8s常用的资源" class="headerlink" title="3:k8s常用的资源"></a>3:k8s常用的资源</h2><h3 id="3-1-创建pod资源"><a href="#3-1-创建pod资源" class="headerlink" title="3.1 创建pod资源"></a>3.1 创建pod资源</h3><p>==pod是最小资源单==位.</p>
<p>任何的一个k8s资源都可以由yml清单文件来定义</p>
<p>k8s yaml的主要组成</p>
<pre class="line-numbers language-scss"><code class="language-scss"><span class="token property">apiVersion</span><span class="token punctuation">:</span> v<span class="token number">1</span>  api版本
<span class="token property">kind</span><span class="token punctuation">:</span> pod   资源类型
<span class="token property">metadata</span><span class="token punctuation">:</span>   属性
<span class="token property">spec</span><span class="token punctuation">:</span>       详细<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>k8s_pod.yaml</p>
<pre class="line-numbers language-cassandra"><code class="language-cassandra">[root@k8s-node-2 /] # docker load  -i docker_nginx1.13.tar.gz <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-yml"><code class="language-yml">[root@k8s-matser /] # mkdir  k8s_yaml
[root@k8s-matser /] # cd k8s_yaml/
[root@k8s-matser /k8s_yaml] # mkdir  pod

apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    app: web 
spec:
  containers:
    - name: nginx
      image: 10.0.0.11:5000/nginx:1.13
      ports:
        - containerPort: 80


[root@k8s-matser /k8s_yaml/pod] # vi k8s_pod.yml
[root@k8s-matser /k8s_yaml/pod] # cat k8s_pod.yml
[root@k8s-matser /k8s_yaml/pod] # kubectl create -f k8s_pod.yml
[root@k8s-matser /k8s_yaml/pod] # kubectl get pod 
[root@k8s-matser /k8s_yaml/pod] # kubectl describe pod nginx

  51m       51m     1   {default-scheduler }            Normal      Scheduled   Successfully assigned nginx to 10.0.0.13
  51m       45m     6   {kubelet 10.0.0.13}         Warning     FailedSync  Error syncing pod, skipping: failed to "StartContainer" for "POD" with ErrImagePull: "image pull failed for registry.access.redhat.com/rhel7/pod-infrastructure:latest, this may be because there are no credentials on this request.  details: (open /etc/docker/certs.d/registry.access.redhat.com/redhat-ca.crt: no such file or directory)"

  51m   43m 33  {kubelet 10.0.0.13}     Warning FailedSync  Error syncing pod, skipping: failed to "StartContainer" for "POD" with ImagePullBackOff: "Back-off pulling image \"registry.access.redhat.com/rhel7/pod-infrastructure:latest\""


  #--原因是红帽地址改变成私有地址-上传镜像  pod-infrastructure-latest.tar.gz <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>node节点:所有</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">vim <span class="token operator">/</span>etc<span class="token operator">/</span>kubernetes<span class="token operator">/</span>kubelet
KUBELET_POD_INFRA_CONTAINER=<span class="token string">"--pod-infra-container-image=10.0.0.11:5000/pod-infrastructure:latest"</span>


systemctl restart kubelet<span class="token punctuation">.</span>service
<span class="token namespace">[root@k8s-matser /k8s_yaml/pod]</span> <span class="token comment" spellcheck="true"># curl  -I  172.18.2.2</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>==pod资源:至==少由两个容器==组成,pod基础容器和==业务容器组成(最多1+4)</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">为什么创建一个pod资源，需要至少启动两个容器？
pod基础容器 实现k8s的高级功能<span class="token operator">+</span>
nginx容器   实现业务功能
pod资源中，业务容器的端口不能冲突

只要创建一个pod资源，都会启动一个pod基础容器<span class="token operator">+</span>pod资源中的业务容器

curl <span class="token operator">-</span>I 172<span class="token punctuation">.</span>18<span class="token punctuation">.</span>78<span class="token punctuation">.</span>2 访问pod的ip地址，pod里面的nginx可以被访问，nginx容器和pod<span class="token operator">-</span>infrastructure 
172<span class="token punctuation">.</span>18<span class="token punctuation">.</span>78<span class="token punctuation">.</span>2 究竟是哪一个容器的ip地址？
172<span class="token punctuation">.</span>18<span class="token punctuation">.</span>78<span class="token punctuation">.</span>2是pod基础容器的ip
nginx容器和pod基础容器共用ip地址<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>pod配置文件2：</p>
<pre class="line-numbers language-CQL"><code class="language-CQL">apiVersion: v1
kind: Pod
metadata:
  name: test
  labels:
    app: web
spec:
  containers:
    - name: nginx
      image: 10.0.0.11:5000/nginx:1.13
      ports:
        - containerPort: 80
    - name: alpine
      image: 10.0.0.11:5000/alpine:latest
      command: ["sleep","1000"]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>pod是k8s最小的资源单位</p>
<h3 id="3-2-Repl-icationCo-ntroller资源"><a href="#3-2-Repl-icationCo-ntroller资源" class="headerlink" title="3.2 Repl==icationCo==ntroller资源"></a>3.2 Repl==icationCo==ntroller资源</h3><p>rc:保证指定数量的pod始终存活,rc通 过标签选择器来关联pod</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">k8s资源的常见操作:
1-<span class="token operator">-</span>创建资源
<span class="token namespace">[root@k8s-matser /k8s_yaml/rc]</span> <span class="token comment" spellcheck="true"># kubectl   create  -f   xxx.yaml</span>

2-<span class="token operator">-</span>查看某一个资源
<span class="token namespace">[root@k8s-matser /k8s_yaml/rc]</span> <span class="token comment" spellcheck="true">#kubectl   get  pod|rc</span>

3-<span class="token operator">-</span>查看某一个资源详细信息
<span class="token namespace">[root@k8s-matser /k8s_yaml/rc]</span> <span class="token comment" spellcheck="true"># kubectl  describe  pod  nginx</span>
kubectl  delete   pod  nginx   或者kubectl delete  <span class="token operator">-</span>f  xxx<span class="token punctuation">.</span>yaml

<span class="token namespace">[root@k8s-matser /k8s_yaml/rc]</span> <span class="token comment" spellcheck="true"># kubectl  get pod   -o wide --show-labels  </span>

4-<span class="token operator">-</span>修改标签
<span class="token operator">--</span>查看某一个资源<span class="token namespace">[root@k8s-matser /k8s_yaml/rc]</span> <span class="token comment" spellcheck="true"># kubectl  edit pod nginx</span>



5-<span class="token operator">-</span>删除 某一个资源 
<span class="token namespace">[root@k8s-matser /k8s_yaml]</span> <span class="token comment" spellcheck="true"># kubectl  delete   pod  nginx </span>
<span class="token namespace">[root@k8s-matser /k8s_yaml/rc]</span> <span class="token comment" spellcheck="true"># kubectl  delete   node  10.0.0.12</span>
<span class="token namespace">[root@k8s-matser /k8s_yaml/deployment]</span> <span class="token comment" spellcheck="true"># kubectl delete  -f .</span>



6-<span class="token operator">-</span>编辑某一个具体资源的配置文件
<span class="token namespace">[root@k8s-matser /k8s_yaml]</span> <span class="token comment" spellcheck="true">#  kubectl  edit  pod   nginx  </span>

7<span class="token operator">-</span>获取apiversion版本信息
<span class="token namespace">[root@k8s-matser /k8s_yaml/rc]</span> <span class="token comment" spellcheck="true"># kubectl api-versions</span>


8<span class="token operator">-</span>获取资源的apiVersion版本信息
<span class="token namespace">[root@k8s-matser /k8s_yaml/rc]</span> <span class="token comment" spellcheck="true"># kubectl  explain  pod</span>
<span class="token namespace">[root@k8s-matser /k8s_yaml/tomcat_demo]</span> <span class="token comment" spellcheck="true"># kubectl  explain  pod.spec.volumes.nfs</span>

9<span class="token operator">-</span>在线修改支援
<span class="token namespace">[root@k8s-matser /k8s_yaml/svc]</span> <span class="token comment" spellcheck="true"># kubectl  scale  rc nginx2  --replicas=2</span>



10<span class="token operator">-</span>进去容器
<span class="token namespace">[root@k8s-matser /k8s_yaml/svc]</span> <span class="token comment" spellcheck="true"># kubectl  exec  -it  nginx2-9xxzc </span>

11<span class="token operator">-</span>查看日志
<span class="token namespace">[root@k8s-matser /k8s_yaml/tomcat_demo]</span> <span class="token comment" spellcheck="true"># kubectl  logs  mysql-1pjwk</span>

12<span class="token operator">-</span>调整资源数
<span class="token namespace">[root@k8s-matser /k8s_yaml/svc]</span> <span class="token comment" spellcheck="true"># kubectl  scale  rc  nginx2 --replicas=3</span>



13-<span class="token operator">-</span>自动发现
<span class="token namespace">[root@k8s-matser /k8s_yaml/svc]</span> <span class="token comment" spellcheck="true"># kubectl  describe  svc </span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建一个rc</p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@k8s-matser /k8s_yaml/rc]</span> <span class="token comment" spellcheck="true"># mkdir rc </span>


apiVersion: v1
kind: ReplicationController
metadata:
  name: nginx
spec:
  replicas: 5  <span class="token comment" spellcheck="true">#副本5</span>
  selector:
    app: myweb
  template:  <span class="token comment" spellcheck="true">#模板</span>
    metadata:
      labels:
        app: myweb
    spec:
      containers:
      <span class="token operator">-</span> name: myweb
        image: 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>nginx:1<span class="token punctuation">.</span>13
        ports:
        <span class="token operator">-</span> containerPort: 80


        节点挂了自动切换 

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>rc的滚动升级 新建一个nginx-rc1.15.yaml <img src="https://www.qstack.com.cn/wp-content/uploads/2019/08/1563093237250.png" alt="1563093237250"></p>
<pre class="line-numbers language-spreadsheet"><code class="language-spreadsheet">升级 kubectl rolling-update nginx -f nginx-rc1.15.yaml --update-period=10s

回滚 kubectl rolling-update nginx2 -f nginx-rc.yaml --update-period=1s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>==rc  升级更换了标签，中途网络无法访问==使用deployment</p>
<h3 id="3-3-service资源"><a href="#3-3-service资源" class="headerlink" title="3.3 service资源"></a>3.3 service资源</h3><pre class="line-numbers language-powershell"><code class="language-powershell">ClusterIP Service：这是默认的 Service 类型，该类型 Service 对外暴露一个集群内部 IP，可以用于集群内部服务间的通信
NodePort Service：该类型 Service 对外暴露集群上所有节点的固定端口，支持外部通过 &lt;NodeIP>:&lt;NodePort> 进行访问
LoadBalancer：该类 Service 通过云平台提供的 load balancer 向外提供服务
ExternalName：将服务映射到一个 externalName （比如 http:<span class="token operator">/</span><span class="token operator">/</span>foo<span class="token punctuation">.</span>bar<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200602194941261-1591358629106.png" alt="image-20200602194941261"></p>
<p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200603090027500-1591358629106.png" alt="image-20200603090027500"></p>
<p>service帮助pod暴露端口</p>
<p>创建一个service</p>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/svc<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># mkdir svc </span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service   <span class="token comment" spellcheck="true">#简称svc</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> myweb
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token comment" spellcheck="true">#默认ClusterIP  </span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80          </span><span class="token comment" spellcheck="true">#clusterIP  vip 端口</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30000   </span><span class="token comment" spellcheck="true">#node port  宿主机端口</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80    </span><span class="token comment" spellcheck="true">#pod port   容器端口</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> myweb2



<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/svc<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># kubectl  get svc   -o wide </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@k8s-matser /k8s_yaml/svc]</span> <span class="token comment" spellcheck="true"># kubectl  scale  rc  nginx2 --replicas=3</span>

<span class="token namespace">[root@k8s-matser /k8s_yaml/svc]</span> <span class="token comment" spellcheck="true">#  kubectl  exec  -it  nginx2-4pw6m  /bin/bash   #进入pod容器</span>

 <span class="token operator">--</span><span class="token operator">-</span>测试负载均衡  
<span class="token namespace">[root@k8s-matser /k8s_yaml/svc]</span> <span class="token comment" spellcheck="true"># curl  10.0.0.13:30000</span>
we01
<span class="token namespace">[root@k8s-matser /k8s_yaml/svc]</span> <span class="token comment" spellcheck="true"># curl  10.0.0.13:30000</span>
web02

<span class="token operator">--</span>自动发现
<span class="token namespace">[root@k8s-matser /k8s_yaml/svc]</span> <span class="token comment" spellcheck="true"># kubectl  describe  svc </span>
删除自动添加<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改nodePort范围</p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@k8s-matser /k8s_yaml/svc]</span> <span class="token comment" spellcheck="true"># vim  /etc/kubernetes/apiserver</span>
KUBE_API_ARGS=<span class="token string">"--service-node-port-range=3000-50000"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>命令行创建service资源</p>
<pre class="line-numbers language-scss"><code class="language-scss">--给rc 创建  svc 

[root@k<span class="token number">8</span>s-matser] # kubectl  expose  rc  deployment      nginx<span class="token number">2</span>  --port=<span class="token number">80</span>  --target-port=<span class="token number">80</span> --type=NodePort

nginx<span class="token number">2</span>  网络                 vip 端口  后端容器端口

命令行非交互式创建service资源，不能自定义nodeport   宿主机端口<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>service默认使用iptables来实现负载均衡, k8s 1.8新版本中推荐使用lvs(四层负载均==衡 传输层tcp,udp)==</p>
<h3 id="3-4-deployment资源"><a href="#3-4-deployment资源" class="headerlink" title="3.4 deployment资源"></a>3.4 deployment资源</h3><p>有rc在滚动升级之后,会造成服务访问中断,于是k8s引入了deployment资源</p>
<p>创建deployment</p>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/deployment<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># kubectl  create  -f deploy.yaml </span>


<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>   
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> <span class="token number">1   </span><span class="token comment" spellcheck="true">#多启动pod</span>
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1  </span><span class="token comment" spellcheck="true">#最多不可访问的pod</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate
  <span class="token key atrule">minReadySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> 10.0.0.11<span class="token punctuation">:</span>5000/nginx<span class="token punctuation">:</span><span class="token number">1.13</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>  
          <span class="token key atrule">limits</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m




创建ser访问    
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/deployment<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># kubectl  edit  deployment nginx</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-powershell"><code class="language-powershell">deployment升级和回滚  命令行 

1-<span class="token operator">-</span>命令行创建deployment
kubectl run   nginx  <span class="token operator">--</span>image=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>nginx:1<span class="token punctuation">.</span>13 <span class="token operator">--</span>replicas=3 <span class="token operator">--</span>record
                资源名字             容器的名字                            副本3 个   方便记录升级回滚

2-<span class="token operator">-</span>命令行升级版本
kubectl <span class="token function">set</span> （资源，镜像）  image   deployment    nginx nginx=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>nginx:1<span class="token punctuation">.</span>15  

3-<span class="token operator">-</span>查看deployment所有历史版本

kubectl rollout history deployment nginx

4-<span class="token operator">-</span>命令行回滚deployment到上一个版本

kubectl rollout undo deployment nginx

5-<span class="token operator">-</span>命令行回滚deployment到指定版本

kubectl rollout undo deployment nginx <span class="token operator">--</span>to<span class="token operator">-</span>revision=2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<pre class="line-numbers language-powershell"><code class="language-powershell">deployment相对于rc的优势：
1：滚动升级服务不会中断访问
2：滚动升级不依赖配置文件
3：deployment修改配置文件，立即生效
4<span class="token punctuation">.</span> deployment资源的创建，升级，回滚等操作，都可以命令行执行

deployment滚动升级策略
  strategy:   
    rollingUpdate:
      maxSurge: 1          <span class="token comment" spellcheck="true">#多启动pod的数量</span>
      maxUnavailable: 1    <span class="token comment" spellcheck="true">#最多不可访问的pod数量</span>
    <span class="token function">type</span>: RollingUpdate
  minReadySeconds: 30    <span class="token comment" spellcheck="true">#升级间隔</span>
  副本数：3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-5-tomcat-mysql练习"><a href="#3-5-tomcat-mysql练习" class="headerlink" title="3.5 tomcat+mysql练习"></a>3.5 tomcat+mysql练习</h3><p>在k8s中容器之间相互访问,通过VIP地址!</p>
<pre class="line-numbers language-powershell"><code class="language-powershell"> rz <span class="token operator">-</span>E  上传镜像
 <span class="token function">ls</span>
 <span class="token namespace">[root@k8s-node-2 ~]</span> <span class="token comment" spellcheck="true"># docker load -i tomcat-app-v2.tar.gz </span>
 <span class="token namespace">[root@k8s-node-2 ~]</span> <span class="token comment" spellcheck="true">#  docker load -i docker-mysql-5.7.tar.gz </span>
 <span class="token namespace">[root@k8s-node-2 ~]</span> <span class="token comment" spellcheck="true">#  docker tag docker.io/kubeguide/tomcat-app:v2 10.0.0.11:5000/tomcat-app:v2</span>
 <span class="token namespace">[root@k8s-node-2 ~]</span> <span class="token comment" spellcheck="true"># docker tag docker.io/mysql:5.7 10.0.0.11:5000/mysql:5.7</span>
<span class="token namespace">[root@k8s-node-2 ~]</span> <span class="token comment" spellcheck="true">#  docker push 10.0.0.11:5000/mysql:5.7</span>
 <span class="token namespace">[root@k8s-node-2 ~]</span> <span class="token comment" spellcheck="true">#  docker push 10.0.0.11:5000/tomcat-app:v2</span>


kodexplorer：
rc<span class="token operator">+</span>svc
deploy<span class="token operator">+</span>svc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://www.qstack.com.cn/wp-content/uploads/2019/08/1563102568377.png" alt="1563102568377"></p>
<p> <img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200602211801421-1591358629107.png" alt="image-20200602211801421"></p>
<pre><code>http://10.0.0.12:30008/demo

[root@k8s-matser /k8s_yaml/tomcat_demo] # kubectl  exec  -it mysql-mxctm   /bin/bash
root@mysql-mxctm:/# mysql -uroot -p123456


mysql&gt; select * from T_USERS   
</code></pre><pre class="line-numbers language-yaml"><code class="language-yaml">启动 
注意svc 地址：
rename  tomcat wordpress *


<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/tomcat_demo<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># kubectl  create  -f mysql-rc.yml  </span>

<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/tomcat_demo<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># cat mysql-rc.yml </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicationController
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
          <span class="token key atrule">image</span><span class="token punctuation">:</span> 10.0.0.11<span class="token punctuation">:</span>5000/mysql<span class="token punctuation">:</span><span class="token number">5.7</span>
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'123456'</span>



<span class="token punctuation">---</span><span class="token punctuation">---</span>
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/tomcat_demo<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># kubectl create  -f mysql-svc.yml </span>

<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/tomcat_demo<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># cat mysql-svc.yml </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql


<span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/tomcat_demo<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># kubectl create  -f tomcat-rc.yml  </span>
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/tomcat_demo<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># cat tomcat-rc.yml </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicationController
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> myweb
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> myweb
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> myweb
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myweb
          <span class="token key atrule">image</span><span class="token punctuation">:</span> 10.0.0.11<span class="token punctuation">:</span>5000/tomcat<span class="token punctuation">-</span>app<span class="token punctuation">:</span>v2
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_HOST
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'10.254.9.254'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_PORT
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'3306'</span>


<span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/tomcat_demo<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># kubectl create  -f tomcat-svc.yml </span>

<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/tomcat_demo<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># cat tomcat-svc.yml  </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> myweb
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30008</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> myweb
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-5-w-ordpr-ess-改下comps"><a href="#3-5-w-ordpr-ess-改下comps" class="headerlink" title="3.5-w==ordpr==ess 改下comps"></a>3.5-w==ordpr==ess 改下comps</h3><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3"</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">db</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> <span class="token number">123456</span>
      <span class="token key atrule">MYSQL_DATABASE</span><span class="token punctuation">:</span> wordpress
      <span class="token key atrule">MYSQL_USER</span><span class="token punctuation">:</span> tom
      <span class="token key atrule">MYSQL_PASSWORD</span><span class="token punctuation">:</span> <span class="token number">123456</span>

  <span class="token key atrule">wordpress</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> 10.30.12.55/docker/wordpress
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"8000:80"</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">WORDPRESS_DB_NAME</span><span class="token punctuation">:</span> wordpress
      <span class="token key atrule">WORDPRESS_DB_HOST</span><span class="token punctuation">:</span> db
      <span class="token key atrule">WORDPRESS_DB_USER</span><span class="token punctuation">:</span> tom
      <span class="token key atrule">WORDPRESS_DB_PASSWORD</span><span class="token punctuation">:</span> <span class="token number">123456</span>



<span class="token punctuation">---</span><span class="token punctuation">-</span>
上传镜像 
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/wordpress<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># kubectl  create  -f mysql-rc.yml  </span>
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/wordpress<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># cat mysql-rc.yml </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicationController
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>mysql
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>mysql
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>mysql
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
          <span class="token key atrule">image</span><span class="token punctuation">:</span> 10.0.0.11<span class="token punctuation">:</span>5000/mysql<span class="token punctuation">:</span><span class="token number">5.7</span>
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'123456'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_DATABASE
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'wordpress'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span>  MYSQL_USER
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'tom'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span>   MYSQL_PASSWORD
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'123456'</span>

<span class="token punctuation">---</span><span class="token punctuation">-</span>
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/wordpress<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># kubectl  create  -f mysql-svc.yml </span>
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/wordpress<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># cat mysql-svc.yml </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>mysql
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>mysql


<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/wordpress<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># kubectl  create  -f wordpress-rc.yml </span>

<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/wordpress<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># cat wordpress-rc.yml </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicationController
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress
          <span class="token key atrule">image</span><span class="token punctuation">:</span> 10.0.0.11<span class="token punctuation">:</span>5000/wordpress<span class="token punctuation">:</span>v1 
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_NAME
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'wordpress'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_HOST
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'10.254.14.33'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_USER
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'tom'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_PASSWORD
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'123456'</span>


<span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/wordpress<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># kubectl   create  -f wordpress-svc.yml</span>
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/wordpress<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># cat wordpress-svc.yml </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress 
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30009</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress 


http<span class="token punctuation">:</span>//10.0.0.12<span class="token punctuation">:</span>30009/wp<span class="token punctuation">-</span>admin/install.php<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-5-zabbix-comps"><a href="#3-5-zabbix-comps" class="headerlink" title="3.5_zabbix-comps"></a>3.5_zabbix-comps</h3><pre class="line-numbers language-mysql"><code class="language-mysql">[root@k8s-matser /k8s_yaml/zabbix/zabbix_yam] # cat zabbix-rc.yml 
apiVersion: v1
kind: ReplicationController
metadata:
  name: mysql-server
spec:
  replicas: 1
  selector:
    app: mysql-server
  template:
    metadata:
      labels:
        app: mysql-server
    spec:
      nodeName: 10.0.0.13
      containers:
        - name: mysql
          image: 10.0.0.11:5000/mysql:5.7
          imagePullPolicy: IfNotPresent
          ports:
          - containerPort: 3306
          args: ["--character-set-server=utf8","--collation-server=utf8_bin"]
          env:
          - name: MYSQL_ROOT_PASSWORD
            value: 'root_pwd'
          - name: MYSQL_DATABASE
            value: 'zabbix'
          - name: MYSQL_USER
            value: 'zabbix'
          - name: MYSQL_PASSWORD
            value: 'zabbix_pwd'
---
apiVersion: v1
kind: ReplicationController
metadata:
  name: zabbix-java-gateway
spec:
  replicas: 1
  selector:
    app: zabbix-java-gateway
  template:
    metadata:
      labels:
        app: zabbix-java-gateway
    spec:
      nodeName: 10.0.0.13
      containers:
        - name: zabbix-java-gateway
          imagePullPolicy: IfNotPresent
          image: 10.0.0.11:5000/zabbix-java-gateway:latest
---
apiVersion: v1
kind: ReplicationController
metadata:
  name: zabbix-server
spec:
  replicas: 1
  selector:
    app: zabbix-server
  template:
    metadata:
      labels:
        app: zabbix-server
    spec:
      nodeName: 10.0.0.13
      containers:
        - name: zabbix-server
          imagePullPolicy: IfNotPresent
          image: 10.0.0.11:5000/zabbix-server-mysql:latest
          ports:
          - containerPort: 10051
          env:
          - name: DB_SERVER_HOST
            value: 'mysql-server'
          - name: MYSQL_DATABASE
            value: 'zabbix'
          - name: MYSQL_USER
            value: 'zabbix'
          - name: MYSQL_PASSWORD
            value: 'zabbix_pwd'
          - name: MYSQL_ROOT_PASSWORD
            value: 'root_pwd'
          - name: ZBX_JAVAGATEWAY 
            value: 'zabbix-java-gateway'
---
apiVersion: v1
kind: ReplicationController
metadata:
  name: zabbix-web-nginx-mysql
spec:
  replicas: 1
  selector:
    app: zabbix-web-nginx-mysql
  template:
    metadata:
      labels:
        app: zabbix-web-nginx-mysql
    spec:
      nodeName: 10.0.0.13
      containers:
        - name: zabbix-web-nginx-mysql
          imagePullPolicy: IfNotPresent
          image: 10.0.0.11:5000/zabbix-web-nginx-mysql:latest
          ports:
          - containerPort: 80
          env:
          - name: DB_SERVER_HOST
            value: 'mysql-server'
          - name: MYSQL_DATABASE
            value: 'zabbix'
          - name: MYSQL_USER
            value: 'zabbix'
          - name: MYSQL_PASSWORD
            value: 'zabbix_pwd'
          - name: MYSQL_ROOT_PASSWORD
            value: 'root_pwd'

----

[root@k8s-matser /k8s_yaml/zabbix/zabbix_yam] # cat zabbix-svc.yml 
apiVersion: v1
kind: Service
metadata:
  name: mysql-server
spec:
  ports:
    - port: 3306
      targetPort: 3306
  selector:
    app: mysql-server
---
apiVersion: v1
kind: Service
metadata:
  name: zabbix-java-gateway
spec:
  ports:
    - port: 10052
      targetPort: 10052
  selector:
    app: zabbix-java-gateway
---
apiVersion: v1
kind: Service
metadata:
  name: zabbix-server
spec:
  type: NodePort
  ports:
    - port: 10051
      nodePort: 10051
      targetPort: 10051
  selector:
    app: zabbix-server
---
apiVersion: v1
kind: Service
metadata:
  name: zabbix-web-nginx-mysql
spec:
  type: NodePort
  ports:
    - port: 80
      nodePort: 30007
      targetPort: 80
  selector:
    app: zabbix-web-nginx-mysql

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-powershell"><code class="language-powershell">注意 默认内型
  <span class="token function">type</span>: NodePort
  ports:
    <span class="token operator">-</span> port: 80
      nodePort: 30007
      targetPort: 80
  selector:
<span class="token operator">--</span><span class="token operator">-</span>
imagePullPolicy: IfNotPresent  本地有就不从仓库拉取镜像
 imagePullPolicy Always 总是从镜像仓库pull 镜像
 Nevet 从不从私有仓库拉取镜像   


 docker<span class="token operator">-</span>compose迁移到k8s中运行：
mysql<span class="token operator">-</span>server 
将docker<span class="token operator">-</span>compose中服务的名字，作为service的名字

k8s：容器的初始命令
command：   <span class="token comment" spellcheck="true">#不能被替换</span>
args：      <span class="token comment" spellcheck="true">#容易被替换</span>

args: <span class="token punctuation">[</span><span class="token string">"--character-set-server=utf8"</span><span class="token punctuation">,</span><span class="token string">"--collation-server=utf8_bin"</span><span class="token punctuation">]</span>
args:
  <span class="token operator">-</span> <span class="token operator">--</span>character<span class="token operator">-</span><span class="token function">set</span><span class="token operator">-</span>server=utf8
  <span class="token operator">-</span> <span class="token operator">--</span>collation<span class="token operator">-</span>server=utf8_bin

dockerfile 容器的初始命令
entrypoint：
cmd：<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="4-k8s的附加组件"><a href="#4-k8s的附加组件" class="headerlink" title="4:k8s的附加组件"></a>4:k8s的附加组件</h2><p>k8s集群中dns服务的作用,==就是将svc的名称解析成对应VIP地址==</p>
<h3 id="4-1-dns服务"><a href="#4-1-dns服务" class="headerlink" title="4.1 dns服务"></a>4.1 dns服务</h3><p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200602215809049-1591358629107.png" alt="image-20200602215809049"></p>
<p>安装dns服务</p>
<pre><code>导入DNS包</code></pre><p>1:下载dns_docker镜像包(node2节点10.0.0.13)</p>
<p>wget <a href="http://192.168.37.200/191127/docker_k8s_dns.tar.gz" target="_blank" rel="noopener">http://192.168.37.200/191127/docker_k8s_dns.tar.gz</a></p>
<p>2:导入dns_docker镜像包(node2节点10.0.0.13)</p>
<p>3:创建dns服务</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">vi  skydns<span class="token operator">-</span><span class="token punctuation">.</span>yaml
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   spec:
 50       nodeName: 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>13
 51       containers:
 52       <span class="token operator">-</span> name: kubedns
 53         image: gcr<span class="token punctuation">.</span>io<span class="token operator">/</span>google_containers<span class="token operator">/</span>kubedns<span class="token operator">-</span>amd64:1<span class="token punctuation">.</span>9

 固定节点 无法调度

kubectl  create  <span class="token operator">-</span>f   skydns<span class="token operator">-</span>rc<span class="token punctuation">.</span>yaml
kubectl create <span class="token operator">-</span>f skydns<span class="token operator">-</span>svc<span class="token punctuation">.</span>yaml

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>4:检查</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">kubectl get all <span class="token operator">--</span>namespace=kube<span class="token operator">-</span>system
<span class="token namespace">[root@k8s-matser /k8s_yaml/dns]</span> <span class="token comment" spellcheck="true"># kubectl get all -n kube-system </span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>5:修改所有node节点kubelet的配置文件</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">vim  <span class="token operator">/</span>etc<span class="token operator">/</span>kubernetes<span class="token operator">/</span>kubelet
KUBELET_ARGS=<span class="token string">"--cluster_dns=10.254.230.254 --cluster_domain=cluster.local"</span>

systemctl   restart kubelet<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>6：修改tomcat-rc.yml</p>
<pre class="line-numbers language-scss"><code class="language-scss">          <span class="token property">env</span><span class="token punctuation">:</span>
          <span class="token operator">-</span> <span class="token property">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_HOST
            <span class="token property">value</span><span class="token punctuation">:</span> <span class="token string">'mysql'</span>   #修改前值是VIP

kubectl delete -f <span class="token number">.</span>
kubectl create -f <span class="token number">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>7：验证</p>
<p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200603101342963-1591358629107.png" alt="image-20200603101342963"></p>
<pre class="line-numbers language-powershell"><code class="language-powershell">如何将rc转换成deployment

apiVersion: extensions<span class="token operator">/</span>v1beta1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 3
  strategy:   
    rollingUpdate:
      maxSurge: 1   <span class="token comment" spellcheck="true">#多启动pod</span>
      maxUnavailable: 1  <span class="token comment" spellcheck="true">#最多不可访问的pod</span>
    <span class="token function">type</span>: RollingUpdate
  minReadySeconds: 30
  template:
    metadata:
      labels:
        app: nginx

  <span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>      
apiVersion: v1   <span class="token comment" spellcheck="true">#修改</span>
kind: ReplicationController    <span class="token comment" spellcheck="true">#修改</span>
metadata:
  name: mysql
spec:
  replicas: 1  
  selector:    <span class="token comment" spellcheck="true">#删除标签选择器</span>
    app: mysql   <span class="token comment" spellcheck="true">#删除标签选择器</span>
  template:
<span class="token comment" spellcheck="true">##</span>
apiVersion: extensions<span class="token operator">/</span>v1beta1
kind: Deployment
metadata:
  name: mysql
spec:
  replicas: 1
  template:



k8s的namespace：资源隔离
一个业务，一个namespace  mysql 
rc<span class="token operator">+</span>svc 必须处于同一namespace
deploy<span class="token operator">+</span>svc 必须处于同一namespace



initialDelaySeconds: 25    <span class="token comment" spellcheck="true">#第一次检查开始时间</span>

mysql pod  启动需要10秒

tomcat 

容器，状态running  ，程序已经卡死了
readiness
ready

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200603125929628-1591358629107.png" alt="image-20200603125929628"></p>
<h3 id="4-2-namespace命令空间"><a href="#4-2-namespace命令空间" class="headerlink" title="4.2 namespace命令空间"></a>4.2 namespace命令空间</h3><p>namespace做资源隔离</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">1-<span class="token operator">-</span>查看namespace  
<span class="token namespace">[root@k8s-matser /k8s_yaml/tomcat_demo]</span> <span class="token comment" spellcheck="true"># kubectl   get  namespace  </span>

2-<span class="token operator">-</span>创建一个 
<span class="token namespace">[root@k8s-matser /k8s_yaml/tomcat_demo]</span> <span class="token comment" spellcheck="true"># kubectl  create  namespace    wordpress</span>

3-<span class="token operator">-</span>启动一个指定 namespace 
<span class="token namespace">[root@k8s-matser]</span> <span class="token comment" spellcheck="true"># kubectl run   nginx    --image=10.0.0.11:5000/nginx:1.13 --replicas=3 --record  --namespace=xiaohe  </span>
deployment <span class="token string">"nginx"</span> created


4-<span class="token operator">-</span>删除资源空间
<span class="token namespace">[root@k8s-matser /k8s_yaml/tomcat_demo]</span> <span class="token comment" spellcheck="true"># kubectl delete    -n xiaohe   pod --all</span>

5-<span class="token operator">-</span>删除资源名字
<span class="token namespace">[root@k8s-matser /k8s_yaml/wordpress]</span> <span class="token comment" spellcheck="true"># kubectl  delete   namespace   xoapming </span>

6-<span class="token operator">-</span>资源申明 namespace

piVersion: extensions<span class="token operator">/</span>v1beta1
kind: Deployment
metadata:
  name: mysql
  namespace: tomcat  <span class="token comment" spellcheck="true"># 申明所属资源</span>
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: mysql

<span class="token operator">--</span><span class="token operator">-</span> 方案二
kubectl create <span class="token operator">-</span>f <span class="token punctuation">.</span> <span class="token operator">-</span>n web
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-3-健康检查和可用性检查"><a href="#4-3-健康检查和可用性检查" class="headerlink" title="4.3 健康检查和可用性检查"></a>4.3 健康检查和可用性检查</h3><h4 id="4-3-1-探针的种类"><a href="#4-3-1-探针的种类" class="headerlink" title="4.3.1 探针的种类"></a>4.3.1 探针的种类</h4><p>livenessProbe：健康状态检查，周期性检查服务是否存活，检查结果失败，将重启容器</p>
<p>readiness==Probe：可用性检查，周期性检查服务是否可用，不可用将从service的endpoints==中移除</p>
<h4 id="4-3-2-探针的检测方法"><a href="#4-3-2-探针的检测方法" class="headerlink" title="4.3.2 探针的检测方法"></a>4.3.2 探针的检测方法</h4><ul>
<li>==exec：执行==一段命令 返回值为0, 非0</li>
<li>htt==pGet：检测某==个 http 请求的返回状态码 2xx,3xx正常, 4xx,5xx错误</li>
<li>tcpSocket：测试某个端口是否能够连接</li>
</ul>
<h4 id="4-3-3-liveness探针的exec使用"><a href="#4-3-3-liveness探针的exec使用" class="headerlink" title="4.3.3 liveness探针的exec使用"></a>4.3.3 liveness探针的exec使用</h4><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/check<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># mkdir check</span>
<span class="token punctuation">---</span>
状态检查
<span class="token punctuation">---</span>

vi  nginx_pod_exec.yaml 
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> exec
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">image</span><span class="token punctuation">:</span> 10.0.0.11<span class="token punctuation">:</span>5000/nginx<span class="token punctuation">:</span><span class="token number">1.13</span>
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> /bin/sh
        <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
        <span class="token punctuation">-</span> touch /tmp/healthy; sleep 30; rm <span class="token punctuation">-</span>rf /tmp/healthy; sleep 600
      <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
        <span class="token key atrule">exec</span><span class="token punctuation">:</span>
          <span class="token key atrule">command</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> cat
            <span class="token punctuation">-</span> /tmp/healthy
        <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5   </span><span class="token comment" spellcheck="true">#启动5s后检查给容器启动时间</span>
        <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5         </span><span class="token comment" spellcheck="true">#检查周期5s</span>
        <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5        </span><span class="token comment" spellcheck="true">#超时时间</span>
        <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1     </span><span class="token comment" spellcheck="true">#检查成功次数1次成功</span>
        <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">1     </span><span class="token comment" spellcheck="true">#检查1次就是失败</span>


<span class="token punctuation">---</span>创建文件30 秒之前在 过了30s 失败
<span class="token punctuation">---</span> 给容器时间
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/check<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># kubectl  describe  pod exec  </span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="4-3-4-liveness探-针的httpGet使-用"><a href="#4-3-4-liveness探-针的httpGet使-用" class="headerlink" title="4.3.4 liveness探==针的httpGet使==用"></a>4.3.4 liveness探==针的httpGet使==用</h4><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>发起http 请求
<span class="token punctuation">---</span> 失败kill pod 从新启动
<span class="token punctuation">-</span><span class="token punctuation">-</span>

vi   nginx_pod_httpGet.yaml 
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpget
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">image</span><span class="token punctuation">:</span> 10.0.0.11<span class="token punctuation">:</span>5000/nginx<span class="token punctuation">:</span><span class="token number">1.13</span>
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
        <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> /index.html   <span class="token comment" spellcheck="true">#检查文件首页  127.0.0.1</span>
          <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80  </span>
        <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">3</span>
        <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span>

<span class="token punctuation">---</span>
删除首页测试
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/check<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># kubectl  exec  -it httpget  /bin/bash</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="4-3-5-liveness探针的tcpSocket使用"><a href="#4-3-5-liveness探针的tcpSocket使用" class="headerlink" title="4.3.5 liveness探针的tcpSocket使用"></a>4.3.5 liveness探针的tcpSocket使用</h4><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>判断端口通不通 
<span class="token punctuation">---</span>少 <span class="token comment" spellcheck="true"># teneat</span>

vi   nginx_pod_tcpSocket.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tcpSocket
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">image</span><span class="token punctuation">:</span> 10.0.0.11<span class="token punctuation">:</span>5000/nginx<span class="token punctuation">:</span><span class="token number">1.13</span>
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> /bin/sh
        <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
        <span class="token punctuation">-</span> tail <span class="token punctuation">-</span>f /etc/hosts
      <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
        <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>
          <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
        <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="4-3-6-readiness探针的h-ttpGet使用"><a href="#4-3-6-readiness探针的h-ttpGet使用" class="headerlink" title="4.3.6 ==readiness探针的h==ttpGet使用"></a>4.3.6 ==readiness探针的h==ttpGet使用</h4><pre class="line-numbers language-yaml"><code class="language-yaml">vi   nginx<span class="token punctuation">-</span>rc<span class="token punctuation">-</span>httpGet.yaml
<span class="token key atrule">iapiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicationController
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> readiness
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> readiness
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> readiness
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> readiness
        <span class="token key atrule">image</span><span class="token punctuation">:</span> 10.0.0.11<span class="token punctuation">:</span>5000/nginx<span class="token punctuation">:</span><span class="token number">1.13</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /xiaoming.html  <span class="token comment" spellcheck="true">#检查</span>
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">3   </span><span class="token comment" spellcheck="true">#初试话3s</span>
          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">3   </span><span class="token comment" spellcheck="true"># 周期3s </span>


<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/tomcat_demo<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># kubectl  expose  rc readiness  --port=80 --target-port=80   --type=NodePort</span>

<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/tomcat_demo<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># kubectl  get  svc       </span>
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/tomcat_demo<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># curl  -i 10.0.12:29094</span>
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/check<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># kubectl  exec  -it   readiness-wx8q9  /bin/bash</span>
修改 xiaoming.htm
<span class="token punctuation">---</span> 检查通过负载均衡就会有地址
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/tomcat_demo<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># kubectl  describe  svc readiness </span>


 readiness<span class="token punctuation">-</span>wx8q9   0/1       Running   0          14s
<span class="token punctuation">---</span> 可用性检查不通过<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-4-dashboard服务"><a href="#4-4-dashboard服务" class="headerlink" title="4.4 dashboard服务"></a>4.4 dashboard服务</h3><p>1:上传并导入镜像,打标签</p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@k8s-node-2 /]</span> <span class="token comment" spellcheck="true"># docker images |grep 10.0.0.11:5000/heapster</span>
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>heapster                                            canary              0a56f7040da5        3 years ago         971 MB
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>heapster_grafana                                    v2<span class="token punctuation">.</span>6<span class="token punctuation">.</span>0              4fe73eb13e50        4 years ago         267 MB
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>heapster_influxdb                                   v0<span class="token punctuation">.</span>5                a47993810aac        4 years ago         251 MB
<span class="token namespace">[root@k8s-node-2 /]</span> <span class="token comment" spellcheck="true"># </span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2:创建dashborad的deployment和service</p>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/dashbord<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># cat dashboard.yaml </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
<span class="token comment" spellcheck="true"># Keep the name in sync with image version and</span>
<span class="token comment" spellcheck="true"># gce/coreos/kube-manifests/addons/dashboard counterparts</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>latest
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
        <span class="token key atrule">version</span><span class="token punctuation">:</span> latest
        <span class="token key atrule">kubernetes.io/cluster-service</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> 10.0.0.13
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
        <span class="token key atrule">image</span><span class="token punctuation">:</span> 10.0.0.11<span class="token punctuation">:</span>5000/kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>amd64<span class="token punctuation">:</span>v1.4.1
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token comment" spellcheck="true"># keep request = limit to keep this container in guaranteed class</span>
          <span class="token key atrule">limits</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 50Mi
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 50Mi
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9090</span>
        <span class="token key atrule">args</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span>  <span class="token punctuation">-</span><span class="token punctuation">-</span>apiserver<span class="token punctuation">-</span>host=http<span class="token punctuation">:</span>//10.0.0.11<span class="token punctuation">:</span><span class="token number">8080</span>
        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9090</span>
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>


<span class="token punctuation">---</span><span class="token punctuation">-</span>
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/dashbord<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># cat dashboard-svc.yaml </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
    <span class="token key atrule">kubernetes.io/cluster-service</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9090</span>


<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3:访问<a href="http://10.0.0.11:8080/ui/" target="_blank" rel="noopener">http://10.0.0.11:8080/ui/</a></p>
<p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200603215019969-1591358629107.png" alt="image-20200603215019969"></p>
<p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200603214727714-1591358629107.png" alt="image-20200603214727714"></p>
<pre class="line-numbers language-powershell"><code class="language-powershell">daemon sets ：监控node节点宿主机的资源
 pod 不指定副本数 根据node节点的数量，创建pod

 一个节点一个挂掉就没有了


deploy，rc，daemonset：畜牲应用  创建pod-<span class="token operator">-</span>随机名称  没有数据的应用  web站点
pet sets：宠物应用    创建pod-<span class="token operator">-</span>固定名字  01，02     有数据的应用  redis，mysql
StatefulSet： 有状态的应用，有数据的应用
数据库，运行在docker容器，不方便调优，容器是共用宿主机内核，涉及内核参数优化

mysql 调优  内核参数优化
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-5-通过apiservicer反向代理访问service"><a href="#4-5-通过apiservicer反向代理访问service" class="headerlink" title="4.5 通过apiservicer反向代理访问service"></a>4.5 通过apiservicer反向代理访问service</h3><pre class="line-numbers language-powershell"><code class="language-powershell">第一种：NodePort类型 
  <span class="token function">type</span>: NodePort
  ports:
    <span class="token operator">-</span> port: 80
      targetPort: 80
      nodePort: 30008

第二种：ClusterIP类型
  <span class="token function">type</span>: ClusterIP
  ports:
    <span class="token operator">-</span> port: 80
      targetPort: 80

http:<span class="token operator">/</span><span class="token operator">/</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:8080<span class="token operator">/</span>api<span class="token operator">/</span>v1<span class="token operator">/</span>proxy<span class="token operator">/</span>namespaces<span class="token operator">/</span>命令空间<span class="token operator">/</span>services<span class="token operator">/</span>service的名字<span class="token operator">/</span>
<span class="token comment" spellcheck="true">#例子:</span>
http:<span class="token operator">/</span><span class="token operator">/</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:8080<span class="token operator">/</span>api<span class="token operator">/</span>v1<span class="token operator">/</span>proxy<span class="token operator">/</span>namespaces<span class="token operator">/</span>qiangge<span class="token operator">/</span>services<span class="token operator">/</span>wordpress





job 执行一次性的任务：每周进行一次备份

dashboard<span class="token operator">-</span>svc没有做端口映射，但是可以访问
http:<span class="token operator">/</span><span class="token operator">/</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:8080<span class="token operator">/</span>api<span class="token operator">/</span>v1<span class="token operator">/</span>proxy<span class="token operator">/</span>namespaces<span class="token operator">/</span>kube<span class="token operator">-</span>system<span class="token operator">/</span>services<span class="token operator">/</span>kubernetes<span class="token operator">-</span>dashboard<span class="token operator">/</span>
http:<span class="token operator">/</span><span class="token operator">/</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12:30008<span class="token operator">/</span>

<span class="token comment" spellcheck="true">#锚点 定位符</span>
所有的svc都可以通过api<span class="token operator">-</span>server反向代理访问
http:<span class="token operator">/</span><span class="token operator">/</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:8080<span class="token operator">/</span>api<span class="token operator">/</span>v1<span class="token operator">/</span>proxy<span class="token operator">/</span>namespaces<span class="token operator">/</span>tomcat<span class="token operator">/</span>services<span class="token operator">/</span>myweb
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="5-k8s弹性伸缩"><a href="#5-k8s弹性伸缩" class="headerlink" title="5: k8s弹性伸缩"></a>5: k8s弹性伸缩</h2><p>k8s弹性伸缩,需要附加插件heapster监控</p>
<h3 id="5-1-安装heapster监控"><a href="#5-1-安装heapster监控" class="headerlink" title="5.1 安装heapster监控"></a>5.1 安装heapster监控</h3><p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200603220556282-1591358629107.png" alt></p>
<p>1:上传并导入镜像,打标签</p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token function">ls</span> <span class="token operator">*</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
<span class="token keyword">for</span> n in `<span class="token function">ls</span> <span class="token operator">*</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz`<span class="token punctuation">;</span><span class="token keyword">do</span> docker load <span class="token operator">-</span>i <span class="token variable">$n</span> <span class="token punctuation">;</span>done
docker tag docker<span class="token punctuation">.</span>io<span class="token operator">/</span>kubernetes<span class="token operator">/</span>heapster_grafana:v2<span class="token punctuation">.</span>6<span class="token punctuation">.</span>0 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>heapster_grafana:v2<span class="token punctuation">.</span>6<span class="token punctuation">.</span>0

docker tag  docker<span class="token punctuation">.</span>io<span class="token operator">/</span>kubernetes<span class="token operator">/</span>heapster_influxdb:v0<span class="token punctuation">.</span>5 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>heapster_influxdb:v0<span class="token punctuation">.</span>5

docker tag docker<span class="token punctuation">.</span>io<span class="token operator">/</span>kubernetes<span class="token operator">/</span>heapster:canary 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>heapster:canary<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2:上传配置文件,kubectl create   -f   .</p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@k8s-matser /k8s_yaml/heapster/heapster-influxdb]</span> <span class="token comment" spellcheck="true"># ls -l</span>
total 20
<span class="token operator">-</span>rw<span class="token operator">-</span>r-<span class="token operator">-</span>r-<span class="token operator">-</span> 1 root root  414 Sep 14  2016 grafana<span class="token operator">-</span>service<span class="token punctuation">.</span>yaml
<span class="token operator">-</span>rw<span class="token operator">-</span>r-<span class="token operator">-</span>r-<span class="token operator">-</span> 1 root root  648 Jun  3 16:05 heapster<span class="token operator">-</span>controller<span class="token punctuation">.</span>yaml
<span class="token operator">-</span>rw<span class="token operator">-</span>r-<span class="token operator">-</span>r-<span class="token operator">-</span> 1 root root  249 Sep 14  2016 heapster<span class="token operator">-</span>service<span class="token punctuation">.</span>yaml
<span class="token operator">-</span>rw<span class="token operator">-</span>r-<span class="token operator">-</span>r-<span class="token operator">-</span> 1 root root 1499 Jun  3 16:06 influxdb<span class="token operator">-</span>grafana<span class="token operator">-</span>controller<span class="token punctuation">.</span>yaml
<span class="token operator">-</span>rw<span class="token operator">-</span>r-<span class="token operator">-</span>r-<span class="token operator">-</span> 1 root root  259 Sep 14  2016 influxdb<span class="token operator">-</span>service<span class="token punctuation">.</span>yaml
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-spreadsheet"><code class="language-spreadsheet">
修改配置文件:
#heapster-controller.yaml
    spec:
      nodeName: 10.0.0.13
      containers:
      - name: heapster
        image: 10.0.0.11:5000/heapster:canary
        imagePullPolicy: IfNotPresent
#influxdb-grafana-controller.yaml
    spec:
      nodeName: 10.0.0.13
      containers:
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3:打开dashboard验证</p>
<p><img src="https://www.qstack.com.cn/wp-content/uploads/2019/08/1563681008909.png" alt="1563681008909"></p>
<h3 id="5-2-弹性伸缩"><a href="#5-2-弹性伸缩" class="headerlink" title="5.2 弹性伸缩"></a>5.2 弹性伸缩</h3><p>1:修改rc的配置文件</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">弹性伸缩：动态调整pod的数量
压力大，平均cpu使用率高，增加pod数量
压力小，平均cpu使用率低，减少pod数量

依赖监控，监控cpu的使用率
弹性伸缩：扩容的最大值，缩容的最小值，扩容的触发条件cpu=10<span class="token operator">%</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-yaml"><code class="language-yaml"> <span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/tomcat_demo<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># docker stats </span>

CONTAINER           CPU %               MEM USAGE / LIMIT   MEM %               NET I/O             BLOCK I/O           PIDS
8db9aa946ca9        <span class="token punctuation">-</span><span class="token punctuation">-</span>                  <span class="token punctuation">-</span><span class="token punctuation">-</span> / <span class="token punctuation">-</span><span class="token punctuation">-</span>             <span class="token punctuation">-</span><span class="token punctuation">-</span>                  <span class="token punctuation">-</span><span class="token punctuation">-</span>                  <span class="token punctuation">-</span><span class="token punctuation">-</span>                  <span class="token punctuation">-</span><span class="token punctuation">-</span>

<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/tanxing<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># vim k8s_tanxin.yaml </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> 10.0.0.11<span class="token punctuation">:</span>5000/nginx<span class="token punctuation">:</span><span class="token number">1.13</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">limits</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 10Mi
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 5Mi


 <span class="token punctuation">---</span>
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/tanxing<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># kubectl  expose  deployment  nginx  --port=80 --target-port=80  --type=NodePort</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2:创建弹性伸缩规则</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">kubectl  autoscale deployment   nginx<span class="token operator">-</span>deployment  <span class="token operator">--</span>max=8  <span class="token operator">--</span>min=1 <span class="token operator">--</span>cpu<span class="token operator">-</span>percent=5
hpa 

<span class="token namespace">[root@k8s-matser /k8s_yaml/tanxing]</span> <span class="token comment" spellcheck="true"># kubectl  autoscale  deployment   nginx  --max=8  --min=1 --cpu-percent=5</span>

<span class="token operator">--</span>     创建规则     最多副本  最小副本时常    cpu 达到5 

<span class="token operator">--</span>kubectl autoscale 
HPA简介HPA<span class="token punctuation">(</span>Horizontal Pod Autoscaler<span class="token punctuation">)</span>

NAME        REFERENCE          TARGET    CURRENT   MINPODS   MAXPODS   AGE
hpa<span class="token operator">/</span>nginx   Deployment<span class="token operator">/</span>nginx   5<span class="token operator">%</span>        0<span class="token operator">%</span>        1         8         2m

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3:测试</p>
<pre class="line-numbers language-spreadsheet"><code class="language-spreadsheet">ab -n 1000000 -c 40  http://10.0.0.12:33218/index.html
  yum install httpd-tools -y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>扩容截图</p>
<p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200603223613379-1591358629107.png" alt></p>
<p>缩容:</p>
<p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200603223855743-1591358629107.png" alt></p>
<h2 id="6-持久化存储"><a href="#6-持久化存储" class="headerlink" title="6:持久化存储"></a>6:持久化存储</h2><p>数据持久化类型:</p>
<h3 id="6-1-emptyDir"><a href="#6-1-emptyDir" class="headerlink" title="6.1 emptyDir:"></a>6.1 emptyDir:</h3><pre class="line-numbers language-powershell"><code class="language-powershell">emptyDir：跟随pod创建一个空目录，会随着pod的删除而删除     2 nginx pod，2个空目录，调整pod数量为1，删除一个pod

hostpath：多个pod共用一个目录，前提多个pod都在同一个node节点，否则数据不共享

不能调整   pod 会删除  目录 数据  

没有用<span class="token operator">--</span><span class="token operator">-</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> tomcat
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
        <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
          <span class="token key atrule">image</span><span class="token punctuation">:</span> 10.0.0.11<span class="token punctuation">:</span>5000/mysql<span class="token punctuation">:</span><span class="token number">5.7</span>
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'123456'</span>
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/mysql
            <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql

~        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> alpine
           <span class="token key atrule">image</span><span class="token punctuation">:</span> 10.0.0.11<span class="token punctuation">:</span>5000/alpine<span class="token punctuation">:</span>latest
           <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
           <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /tmp
             <span class="token key atrule">name</span><span class="token punctuation">:</span> tmp
           <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"sleep"</span><span class="token punctuation">,</span><span class="token string">"1000"</span><span class="token punctuation">]</span>    
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<pre class="line-numbers language-powershell"><code class="language-powershell">    spec:
      nodeName: 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>13
      volumes:
      <span class="token operator">-</span> name: mysql
        emptyDir: <span class="token punctuation">{</span><span class="token punctuation">}</span>     <span class="token comment" spellcheck="true"># 可以持久化多个-申明方式</span>
      containers:
        <span class="token operator">-</span> name: wp<span class="token operator">-</span>mysql
          image: 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>mysql:5<span class="token punctuation">.</span>7
          imagePullPolicy: IfNotPresent
          ports:
          <span class="token operator">-</span> containerPort: 3306
          volumeMounts:         <span class="token comment" spellcheck="true">#持久化的目录</span>
          <span class="token operator">-</span> mountPath: <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>mysql     <span class="token comment" spellcheck="true">#容器的路径 </span>
            name: mysql    <span class="token comment" spellcheck="true">#目录的名字</span>

            <span class="token comment" spellcheck="true"># 可以持久化多个-目录多个容器</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="6-2-HostPath"><a href="#6-2-HostPath" class="headerlink" title="6.2 HostPath:"></a>6.2 HostPath:</h3><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token punctuation">[</span>root@k8s<span class="token operator">-</span>matser <span class="token operator">/</span>k8s_yaml<span class="token operator">/</span>tomcat_demo<span class="token punctuation">]</span> # kubectl explain  pod<span class="token punctuation">.</span>spec<span class="token punctuation">.</span>volumes<span class="token punctuation">.</span>hostPath

FIELDS<span class="token punctuation">:</span>
   path    <span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span> <span class="token operator">-</span>required<span class="token operator">-</span>
     Path of the directory on the host<span class="token punctuation">.</span> More info<span class="token punctuation">:</span>
     http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>io<span class="token operator">/</span>docs<span class="token operator">/</span>user<span class="token operator">-</span>guide<span class="token operator">/</span>volumes#hostpath

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> tomcat
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/mysql
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
          <span class="token key atrule">image</span><span class="token punctuation">:</span> 10.0.0.11<span class="token punctuation">:</span>5000/mysql<span class="token punctuation">:</span><span class="token number">5.7</span>
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'123456'</span>
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/mysql
            <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
~                                 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-powershell"><code class="language-powershell">    spec:
      nodeName: 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12
      volumes:
      <span class="token operator">-</span> name: mysql
        hostPath:
          path: <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>wp_mysql
      containers:
        <span class="token operator">-</span> name: wp<span class="token operator">-</span>mysql
          image: 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>mysql:5<span class="token punctuation">.</span>7
          imagePullPolicy: IfNotPresent
          ports:
          <span class="token operator">-</span> containerPort: 3306
          volumeMounts:
          <span class="token operator">-</span> mountPath: <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>mysql
            name: mysql


           <span class="token operator">--</span>-<span class="token operator">-</span>缺点判断当另外的节点没有会从新创建数据
           hostpath：多个pod共用一个目录，前提多个pod都在同一个node节点，否则数据不共享
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<pre><code>wordpress-svc.yml
</code></pre><h3 id="6-3-nfs"><a href="#6-3-nfs" class="headerlink" title="6.==3 nfs:=="></a>6.==3 nfs:==</h3><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/tomcat_demo<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># mkdir  /data/tomcat-mysql</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> tomcat
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> 10.0.0.13
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
        <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/tomcat<span class="token punctuation">-</span>mysql
          <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.0.0.11
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
          <span class="token key atrule">image</span><span class="token punctuation">:</span> 10.0.0.11<span class="token punctuation">:</span>5000/mysql<span class="token punctuation">:</span><span class="token number">5.7</span>
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'123456'</span>
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/mysql
            <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
~                                                     <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200604194209528-1591358629107.png" alt="image-20200604194209528"></p>
<pre class="line-numbers language-powershell"><code class="language-powershell">      volumes:
      <span class="token operator">-</span> name: mysql
        nfs:
          path: <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>wp_mysql
          server: 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11


  <span class="token namespace">[root@k8s-matser /k8s_yaml/tomcat_demo]</span> <span class="token comment" spellcheck="true"># kubectl  explain  pod.spec.volumes.nfs</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="6-4-pv和pvc"><a href="#6-4-pv和pvc" class="headerlink" title="6.4 pv和pvc:"></a>6.4 pv和pvc:</h3><p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200604194911006-1591358629107.png" alt="image-20200604194911006"></p>
<p>pv: persistent volume    ==全局资源,k8s集群==</p>
<p>pvc: persistent ==volume==  claim,   ==局部资源属于==某一个namespace</p>
<h4 id="6-4-1-安装nfs服务端-10-0-0-11"><a href="#6-4-1-安装nfs服务端-10-0-0-11" class="headerlink" title="6.4.1:安装nfs服务端(10.0.0.11)"></a>6.4.1:安装nfs服务端(10.0.0.11)</h4><pre class="line-numbers language-spreadsheet"><code class="language-spreadsheet">yum install nfs-utils.x86_64 -y
mkdir /data
vim /etc/exports
/data  10.0.0.0/24(rw,async,no_root_squash,no_all_squash)
systemctl start rpcbind
systemctl start nfs
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="6-4-2-在node节点安装nfs客户端"><a href="#6-4-2-在node节点安装nfs客户端" class="headerlink" title="6.4.2:在node节点安装nfs客户端"></a>6.4.2:在node节点安装nfs客户端</h4><pre class="line-numbers language-powershell"><code class="language-powershell">yum install nfs<span class="token operator">-</span>utils<span class="token punctuation">.</span>x86_64 <span class="token operator">-</span>y
showmount <span class="token operator">-</span>e 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="6-4-3-创建pv和pvc"><a href="#6-4-3-创建pv和pvc" class="headerlink" title="6.4.3:创建pv和pvc"></a>6.4.3:创建pv和pvc</h4><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/tomcat_demo<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># vim mysql_pv2.yaml </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv2
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> nfs002
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 20Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Recycle <span class="token comment" spellcheck="true">#回收策略</span>
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"/data/pv2"</span>
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.0.0.11
    <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>



<span class="token punctuation">---</span><span class="token punctuation">-</span>
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/tomcat_demo<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># cat  mysql_pvc.yaml</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>mysql
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> tomcat
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 15Gi  <span class="token comment" spellcheck="true">#需求的资源</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/tomcat_demo<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># vim mysql-rc.yml </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> tomcat
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> 10.0.0.13
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
        <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
          <span class="token key atrule">claimName</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>mysql

      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
          <span class="token key atrule">image</span><span class="token punctuation">:</span> 10.0.0.11<span class="token punctuation">:</span>5000/mysql<span class="token punctuation">:</span><span class="token number">5.7</span>
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/mysql
            <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD
            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'123456'</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上传yaml配置文件,创建pv和pvc</p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@k8s-matser /k8s_yaml/tomcat_demo]</span> <span class="token comment" spellcheck="true"># kubectl  get  pv</span>



apiVersion：v1
kind: persistentVolumeClaim
metadata：
   name: xxx
   namespace: xxxx
spec:
  accessModes:
    <span class="token operator">-</span> ReadWriteMany
  resources:
    requests:
      storage: 10Gi


pvc挑选pv的时候，1根据存储容量，2：根据标签选择器

pvc回收的时候，需要修改回收pod的镜像地址
gcr<span class="token punctuation">.</span>io<span class="token operator">/</span>google_containers<span class="token operator">/</span>busybox
registry<span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com<span class="token operator">/</span>google_containers<span class="token operator">/</span>busybox<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="6-4-4-创建mysql-rc-pod模板里使用volume"><a href="#6-4-4-创建mysql-rc-pod模板里使用volume" class="headerlink" title="6.4.4:创建mysql-rc,pod模板里使用volume"></a>6.4.4:创建mysql-rc,pod模板里使用volume</h4><pre class="line-numbers language-yaml"><code class="language-yaml">      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
        <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span> 
          <span class="token key atrule">claimName</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>mysql
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="6-4-5-验证持久化"><a href="#6-4-5-验证持久化" class="headerlink" title="6.4.5: 验证持久化"></a>6.4.5: 验证持久化</h4><p>验证方法1:删除mysql的pod,数据库不丢</p>
<p>kubectl delete pod mysql-gt054</p>
<p>验证方法2:查看nfs服务端,是否有mysql的数据文件</p>
<p>!<img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200604203809876-1591358629107.png" alt="image-20200604203809876"></p>
<h3 id="6-5-分布式存储-glusterfs"><a href="#6-5-分布式存储-glusterfs" class="headerlink" title="6.5: 分布式存储==glusterfs=="></a>6.5: 分布式存储==glusterfs==</h3><hr>
<h4 id="a-什么是glusterfs"><a href="#a-什么是glusterfs" class="headerlink" title="a: 什么是glusterfs"></a>a: 什么是glusterfs</h4><p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200604204529946-1591358629107.png" alt></p>
<p>Glusterfs是一个开源分布式文件系统，具有强大的横向扩展能力，可支持数PB存储容量和数千客户端，通过网络互联成一个并行的网络文件系统。具有可扩展性、高性能、高可用性等特点。</p>
<h4 id="b-安装glusterfs"><a href="#b-安装glusterfs" class="headerlink" title="b: 安装glusterfs"></a>b: 安装glusterfs</h4><pre class="line-numbers language-powershell"><code class="language-powershell">多个人一起来工服务<span class="token operator">--</span>多个人干一件事<span class="token operator">-</span>坏一个节点数据不完整<span class="token operator">-</span>
使用分布式复制卷<span class="token operator">--</span><span class="token operator">-</span>加冗余   副本数代表复制 几分  生产达到这个项目9 台机器
但是也浪费支援<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-powershell"><code class="language-powershell">群晖nas，web界面  配置的时候 开启nfs   <span class="token function">mount</span> <span class="token operator">-</span>t nfs
无线路由器 web界面 配置的时候<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-powershell"><code class="language-powershell">-<span class="token operator">-</span>加 硬盘或者加集群
6版本
所有节点：
yum install centos<span class="token operator">-</span>release<span class="token operator">-</span>gluster6<span class="token punctuation">.</span>noarch <span class="token operator">-</span>y
yum install  glusterfs<span class="token operator">-</span>server <span class="token operator">-</span>y
systemctl <span class="token function">start</span> glusterd<span class="token punctuation">.</span>service
systemctl enable glusterd<span class="token punctuation">.</span>service
<span class="token comment" spellcheck="true">#为gluster集群增加存储单元brick</span>
<span class="token namespace">[root@k8s-matser /k8s_yaml/tomcat_demo]</span> <span class="token comment" spellcheck="true"># fdisk  -l</span>

<span class="token function">echo</span> <span class="token string">'- - -'</span> ><span class="token operator">/</span>sys<span class="token operator">/</span><span class="token keyword">class</span><span class="token operator">/</span>scsi_host<span class="token operator">/</span>host0<span class="token operator">/</span>scan 
<span class="token function">echo</span> <span class="token string">'- - -'</span> ><span class="token operator">/</span>sys<span class="token operator">/</span><span class="token keyword">class</span><span class="token operator">/</span>scsi_host<span class="token operator">/</span>host1<span class="token operator">/</span>scan 
<span class="token function">echo</span> <span class="token string">'- - -'</span> ><span class="token operator">/</span>sys<span class="token operator">/</span><span class="token keyword">class</span><span class="token operator">/</span>scsi_host<span class="token operator">/</span>host2<span class="token operator">/</span>scan  

格式化
mkfs<span class="token punctuation">.</span>xfs <span class="token operator">/</span>dev<span class="token operator">/</span>sdb
mkfs<span class="token punctuation">.</span>xfs <span class="token operator">/</span>dev<span class="token operator">/</span>sdc
mkfs<span class="token punctuation">.</span>xfs <span class="token operator">/</span>dev<span class="token operator">/</span>sdd

<span class="token namespace">[root@k8s-matser /k8s_yaml/tomcat_demo]</span> <span class="token comment" spellcheck="true"># gluster pool  list</span>
创建复制卷
mkdir <span class="token operator">-</span>p <span class="token operator">/</span>gfs<span class="token operator">/</span>test1
mkdir <span class="token operator">-</span>p <span class="token operator">/</span>gfs<span class="token operator">/</span>test2
mkdir <span class="token operator">-</span>p <span class="token operator">/</span>gfs<span class="token operator">/</span>test3
<span class="token function">mount</span> <span class="token operator">/</span>dev<span class="token operator">/</span>sdb <span class="token operator">/</span>gfs<span class="token operator">/</span>test1
<span class="token function">mount</span> <span class="token operator">/</span>dev<span class="token operator">/</span>sdc <span class="token operator">/</span>gfs<span class="token operator">/</span>test2
<span class="token function">mount</span> <span class="token operator">/</span>dev<span class="token operator">/</span>sdd <span class="token operator">/</span>gfs<span class="token operator">/</span>test3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="c-添加存储资源池"><a href="#c-添加存储资源池" class="headerlink" title="c: 添加存储资源池"></a>c: 添加存储资源池</h4><pre class="line-numbers language-powershell"><code class="language-powershell">master节点：

<span class="token namespace">[root@k8s-matser ~]</span> <span class="token comment" spellcheck="true"># gluster pool list</span>
<span class="token namespace">[root@k8s-matser ~]</span> <span class="token comment" spellcheck="true"># gluster peer probe k8s-node1   10.0 .0 .12 </span>
<span class="token namespace">[root@k8s-matser ~]</span> <span class="token comment" spellcheck="true"># gluster peer probe k8s-node2    10.0 .0 .13</span>
<span class="token namespace">[root@k8s-matser ~]</span> <span class="token comment" spellcheck="true"># gluster pool  list </span>
UUID                    Hostname     State
494c6f9e<span class="token operator">-</span>51d2<span class="token operator">-</span>4ad1<span class="token operator">-</span>a651<span class="token operator">-</span>eac071a0e9e4    10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12    Connected 
0ee48fa1<span class="token operator">-</span>6f28<span class="token operator">-</span>4f63<span class="token operator">-</span>b21a<span class="token operator">-</span>7ded3725c4ad    10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>13    Connected 

组成集群 创建卷
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="d-glusterfs卷管理"><a href="#d-glusterfs卷管理" class="headerlink" title="d: glusterfs卷管理"></a>d: glusterfs卷管理</h4><h3 id="参考文献"><a href="#参考文献" class="headerlink" title="==参考文献=="></a>==参考文献==</h3><pre><code>https://www.cnblogs.com/huangyanqi/p/8406534.html</code></pre><pre class="line-numbers language-javascript"><code class="language-javascript">#创建分布式复制卷
<span class="token punctuation">[</span>root@k8s<span class="token operator">-</span>matser <span class="token operator">~</span><span class="token punctuation">]</span> # gluster volume create qiangge replica <span class="token number">2</span> k8s<span class="token operator">-</span>master<span class="token punctuation">:</span><span class="token operator">/</span>gfs<span class="token operator">/</span>test1 k8s<span class="token operator">-</span>node<span class="token number">-1</span><span class="token punctuation">:</span><span class="token operator">/</span>gfs<span class="token operator">/</span>test1 k8s<span class="token operator">-</span>master<span class="token punctuation">:</span><span class="token operator">/</span>gfs<span class="token operator">/</span>test2  k8s<span class="token operator">-</span>node<span class="token number">-1</span><span class="token punctuation">:</span><span class="token operator">/</span>gfs<span class="token operator">/</span>test2    force  强制 

<span class="token punctuation">[</span>root@k8s<span class="token operator">-</span>matser <span class="token operator">~</span><span class="token punctuation">]</span> # gluster volume create qiangge replica <span class="token number">2</span> <span class="token number">10.0</span><span class="token punctuation">.</span><span class="token number">0.11</span><span class="token punctuation">:</span><span class="token operator">/</span>gfs<span class="token operator">/</span>test1 <span class="token number">10.0</span><span class="token punctuation">.</span><span class="token number">0.12</span><span class="token punctuation">:</span><span class="token operator">/</span>gfs<span class="token operator">/</span>test1 <span class="token number">10.0</span><span class="token punctuation">.</span><span class="token number">0.11</span><span class="token punctuation">:</span><span class="token operator">/</span>gfs<span class="token operator">/</span>test2  <span class="token number">10.0</span><span class="token punctuation">.</span><span class="token number">0.12</span><span class="token punctuation">:</span><span class="token operator">/</span>gfs<span class="token operator">/</span>test2    force  强制 

<span class="token operator">--</span> #必须<span class="token number">4</span>个

#启动卷
<span class="token punctuation">[</span>root@k8s<span class="token operator">-</span>matser <span class="token operator">~</span><span class="token punctuation">]</span> #  gluster volume start qiangge
#查看卷
<span class="token punctuation">[</span>root@k8s<span class="token operator">-</span>matser <span class="token operator">~</span><span class="token punctuation">]</span> # gluster volume info qiangge 

<span class="token punctuation">[</span>root@k8s<span class="token operator">-</span>matser <span class="token operator">~</span><span class="token punctuation">]</span> # gluster volume info oldboy 

Volume Name<span class="token punctuation">:</span> oldboy
Type<span class="token punctuation">:</span> Distributed<span class="token operator">-</span>Replicate
Volume ID<span class="token punctuation">:</span> ad39171f<span class="token operator">-</span>0fb0<span class="token number">-454e-8535</span><span class="token operator">-</span>c95eef290cc6
Status<span class="token punctuation">:</span> Started
Snapshot Count<span class="token punctuation">:</span> <span class="token number">0</span>
Number <span class="token keyword">of</span> Bricks<span class="token punctuation">:</span> <span class="token number">3</span> x <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">6</span>
Transport<span class="token operator">-</span>type<span class="token punctuation">:</span> tcp
Bricks<span class="token punctuation">:</span>
Brick1<span class="token punctuation">:</span> <span class="token number">10.0</span><span class="token punctuation">.</span><span class="token number">0.11</span><span class="token punctuation">:</span><span class="token operator">/</span>gfs<span class="token operator">/</span>test1
Brick2<span class="token punctuation">:</span> <span class="token number">10.0</span><span class="token punctuation">.</span><span class="token number">0.12</span><span class="token punctuation">:</span><span class="token operator">/</span>gfs<span class="token operator">/</span>test1
Brick3<span class="token punctuation">:</span> <span class="token number">10.0</span><span class="token punctuation">.</span><span class="token number">0.11</span><span class="token punctuation">:</span><span class="token operator">/</span>gfs<span class="token operator">/</span>test2
Brick4<span class="token punctuation">:</span> <span class="token number">10.0</span><span class="token punctuation">.</span><span class="token number">0.12</span><span class="token punctuation">:</span><span class="token operator">/</span>gfs<span class="token operator">/</span>test2
Brick5<span class="token punctuation">:</span> <span class="token number">10.0</span><span class="token punctuation">.</span><span class="token number">0.13</span><span class="token punctuation">:</span><span class="token operator">/</span>gfs<span class="token operator">/</span>test1
Brick6<span class="token punctuation">:</span> <span class="token number">10.0</span><span class="token punctuation">.</span><span class="token number">0.13</span><span class="token punctuation">:</span><span class="token operator">/</span>gfs<span class="token operator">/</span>test2
Options Reconfigured<span class="token punctuation">:</span>
performance<span class="token punctuation">.</span>client<span class="token operator">-</span>io<span class="token operator">-</span>threads<span class="token punctuation">:</span> off
nfs<span class="token punctuation">.</span>disable<span class="token punctuation">:</span> on
transport<span class="token punctuation">.</span>address<span class="token operator">-</span>family<span class="token punctuation">:</span> inet
<span class="token punctuation">[</span>root@k8s<span class="token operator">-</span>matser <span class="token operator">~</span><span class="token punctuation">]</span> # 


#挂载卷
<span class="token punctuation">[</span>root@k8s<span class="token operator">-</span>matser <span class="token operator">~</span><span class="token punctuation">]</span> # mount <span class="token operator">-</span>t glusterfs <span class="token number">10.0</span><span class="token punctuation">.</span><span class="token number">0.11</span><span class="token punctuation">:</span><span class="token operator">/</span>qiangge <span class="token operator">/</span>mnt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="e-分布式复制卷讲解"><a href="#e-分布式复制卷讲解" class="headerlink" title="e:  分布式复制卷讲解"></a>e:  分布式复制卷讲解</h4><p><img src="https://www.qstack.com.cn/wp-content/uploads/2019/08/1564406847973.png" alt="1564406847973"></p>
<h4 id="f-分布式复制卷扩容"><a href="#f-分布式复制卷扩容" class="headerlink" title="f: 分布式复制卷扩容"></a>f: 分布式复制卷扩容</h4><pre class="line-numbers language-javascript"><code class="language-javascript">#扩容前查看容量：
df   <span class="token operator">-</span>h

#扩容命令：
<span class="token punctuation">[</span>root@k8s<span class="token operator">-</span>matser <span class="token operator">~</span><span class="token punctuation">]</span> #gluster volume add<span class="token operator">-</span>brick qiangge <span class="token number">10.0</span><span class="token punctuation">.</span><span class="token number">0.13</span><span class="token punctuation">:</span><span class="token operator">/</span>gfs<span class="token operator">/</span>test1 <span class="token number">10.0</span><span class="token punctuation">.</span><span class="token number">0.13</span><span class="token punctuation">:</span><span class="token operator">/</span>gfs<span class="token operator">/</span>test2 force

#扩容后查看容量<span class="token punctuation">:</span>
df   <span class="token operator">-</span>h<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="6-6-k8s-对接-glusterfs存储"><a href="#6-6-k8s-对接-glusterfs存储" class="headerlink" title="6.6 k8s 对接==glusterfs存储=="></a>6.6 k8s 对接==glusterfs存储==</h3><p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200604210353294-1591358629107.png" alt="image-20200604210353294"></p>
<h4 id="a：创建endpoint"><a href="#a：创建endpoint" class="headerlink" title="==a：创建endpoint=="></a>==a：创建endpoint==</h4><pre class="line-numbers language-scss"><code class="language-scss">不能直接对借创建资源
[root@k<span class="token number">8</span>s-matser /k<span class="token number">8</span>s_yaml/glusterfs] # ll
total <span class="token number">40</span>
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">198</span> Jun  <span class="token number">4</span> <span class="token property">21</span><span class="token punctuation">:</span><span class="token number">07</span> glusterfs-ep<span class="token number">.</span>yaml
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">287</span> Jun  <span class="token number">4</span> <span class="token property">21</span><span class="token punctuation">:</span><span class="token number">10</span> mysql_pv<span class="token number">2.</span>yaml
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">287</span> Jun  <span class="token number">4</span> <span class="token property">21</span><span class="token punctuation">:</span><span class="token number">10</span> mysql_pv<span class="token number">3.</span>yaml
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">182</span> Jun  <span class="token number">4</span> <span class="token property">21</span><span class="token punctuation">:</span><span class="token number">10</span> mysql_pvc<span class="token number">.</span>yaml
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">287</span> Jun  <span class="token number">4</span> <span class="token property">21</span><span class="token punctuation">:</span><span class="token number">10</span> mysql_pv<span class="token number">.</span>yaml
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">635</span> Jun  <span class="token number">4</span> <span class="token property">21</span><span class="token punctuation">:</span><span class="token number">10</span> mysql-rc<span class="token number">.</span>yml
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">166</span> Jun  <span class="token number">4</span> <span class="token property">21</span><span class="token punctuation">:</span><span class="token number">10</span> mysql-svc<span class="token number">.</span>yml
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">2132</span> Jun  <span class="token number">4</span> <span class="token property">21</span><span class="token punctuation">:</span><span class="token number">10</span> tomcat_demo<span class="token number">.</span>zip
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">481</span> Jun  <span class="token number">4</span> <span class="token property">21</span><span class="token punctuation">:</span><span class="token number">10</span> tomcat-rc<span class="token number">.</span>yml
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">183</span> Jun  <span class="token number">4</span> <span class="token property">21</span><span class="token punctuation">:</span><span class="token number">10</span> tomcat-svc<span class="token number">.</span>yml
[root@k<span class="token number">8</span>s-matser /k<span class="token number">8</span>s_yaml/glusterfs] # kubectl  create  -f <span class="token number">.</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-yaml"><code class="language-yaml">vi  glusterfs<span class="token punctuation">-</span>ep.yaml

<span class="token key atrule">iapiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Endpoints
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> glusterfs
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> tomcat
<span class="token key atrule">subsets</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">addresses</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 10.0.0.11
  <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 10.0.0.12
  <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 10.0.0.13
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">49152</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="b-创建service（用于外部服务映射的svc，不需要标签选择器）"><a href="#b-创建service（用于外部服务映射的svc，不需要标签选择器）" class="headerlink" title="b:  创建service（用于外部服务映射的svc，不需要标签选择器）"></a>b:  创建service（用于外部服务映射的svc，不需要标签选择器）</h4><pre class="line-numbers language-mysql"><code class="language-mysql">vi  glusterfs-svc.yaml
iapiVersion: v1
kind: Service
metadata:
  name: glusterfs
  namespace: tomcat
spec:
  ports:
  - port: 49152
    protocol: TCP
    targetPort: 49152
  type: ClusterIP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>方案二修改pod 对接</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">   <span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/glusterfs<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># vim mysql-rc.yml </span>

   <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> 10.0.0.13
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
        <span class="token key atrule">glusterfs</span><span class="token punctuation">:</span>
          <span class="token key atrule">endpoints</span><span class="token punctuation">:</span> glusterfs  <span class="token comment" spellcheck="true">#名字</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> oldboy  <span class="token comment" spellcheck="true">#卷的名字</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql

<span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>

      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> 10.0.0.13
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
        <span class="token key atrule">glusterfs</span><span class="token punctuation">:</span>
          <span class="token key atrule">endpoints</span><span class="token punctuation">:</span> glusterfs
          <span class="token key atrule">path</span><span class="token punctuation">:</span> oldboy
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200604221447141-1591358629107.png" alt="image-20200604221447141"></p>
<h4 id="c-创建gluster类型pv"><a href="#c-创建gluster类型pv" class="headerlink" title="c: 创建gluster类型pv"></a>c: 创建gluster类型pv</h4><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gluster
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> glusterfs
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 50Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">glusterfs</span><span class="token punctuation">:</span>
    <span class="token key atrule">endpoints</span><span class="token punctuation">:</span> <span class="token string">"glusterfs"</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"qiangge"</span>
    <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="d-创建pvc"><a href="#d-创建pvc" class="headerlink" title="d:  创建pvc"></a>d:  创建pvc</h4><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gluster
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 200Gi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="e：在pod中使用gluster"><a href="#e：在pod中使用gluster" class="headerlink" title="e：在pod中使用gluster"></a>e：在pod中使用gluster</h4><pre class="line-numbers language-yaml"><code class="language-yaml">vi  nginx_pod.yaml
…… 
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>vol2
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html
     <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>vol2
       <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
         <span class="token key atrule">claimName</span><span class="token punctuation">:</span> gluster<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="容器连接外部数据库"><a href="#容器连接外部数据库" class="headerlink" title="容器连接外部数据库"></a>容器连接外部数据库</h3><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/glusterfs<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># kubectl   delete  namespace  tomcat</span>
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>node<span class="token punctuation">-</span>2 /mnt<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># yum -y install  mariadb-server</span>
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>node<span class="token punctuation">-</span>2 /mnt<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># systemctl  start  mariadb.service</span>
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>node<span class="token punctuation">-</span>1 ~<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># mysql_secure_installation </span>
MariaDB <span class="token punctuation">[</span>(none)<span class="token punctuation">]</span><span class="token punctuation">></span> grant all  on  *.*  to root@'%' identified by '123456' with grant option;
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>node<span class="token punctuation">-</span>1 ~<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># mysql -uroot -p123456  -h 10.0.0.12</span>
MariaDB <span class="token punctuation">[</span>(none)<span class="token punctuation">]</span><span class="token punctuation">></span> select  user<span class="token punctuation">,</span>host  from  mysql.user;
MariaDB <span class="token punctuation">[</span>(none)<span class="token punctuation">]</span><span class="token punctuation">></span> drop user root@'127.0.0.1';
MariaDB <span class="token punctuation">[</span>(none)<span class="token punctuation">]</span><span class="token punctuation">></span> drop user root@'localhost';
MariaDB <span class="token punctuation">[</span>(none)<span class="token punctuation">]</span><span class="token punctuation">></span> drop user root@'<span class="token punctuation">:</span><span class="token punctuation">:</span>1';




群晖nas，web界面  配置的时候 开启nfs   mount <span class="token punctuation">-</span>t nfs
无线路由器 web界面 配置的时候

k8s可以通过创建endpoint+service为外部服务做负载均衡
k8s 映射

k8s的 tomcat，连接外部 数据库

vi  mysql<span class="token punctuation">-</span>ep.yaml
<span class="token key atrule">iapiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Endpoints
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> tomcat
<span class="token key atrule">subsets</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">addresses</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 10.0.0.13
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP

vi  mysql<span class="token punctuation">-</span>svc.yaml
<span class="token key atrule">iapiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> tomcat
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP


<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>matser /k8s_yaml/duiwai_mysql<span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># kubectl get all   -n tomcat  </span>

http<span class="token punctuation">:</span>//10.0.0.12<span class="token punctuation">:</span>30008/demo/
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200604224722954-1591358629107.png" alt="image-20200604224722954"></p>
<h2 id="7-使用jenkins实现k8s持续更新"><a href="#7-使用jenkins实现k8s持续更新" class="headerlink" title="7:使用jenkins实现k8s持续更新"></a>7:使用jenkins实现k8s持续更新</h2><table>
<thead>
<tr>
<th>ip地址</th>
<th>服务</th>
<th>内存</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.11</td>
<td>kube-apiserver 8080</td>
<td>1G</td>
</tr>
<tr>
<td>10.0.0.12</td>
<td>kube-apiserver 8080</td>
<td>1G</td>
</tr>
<tr>
<td>10.0.0.13</td>
<td>jenkins(tomcat + jdk) 8080</td>
<td>3G</td>
</tr>
</tbody></table>
<p>代码仓库使用gitee托管</p>
<p><img src="https://www.qstack.com.cn/wp-content/uploads/2019/08/1563696106372.png" alt="1563696106372"></p>
<h3 id="7-1-安装gitlab并上传代码"><a href="#7-1-安装gitlab并上传代码" class="headerlink" title="7.1: 安装gitlab并上传代码"></a>7.1: 安装gitlab并上传代码</h3><p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200604225133032-1591358629107.png" alt="image-20200604225133032"></p>
<pre class="line-numbers language-powershell"><code class="language-powershell">单独服务器

<span class="token comment" spellcheck="true">#a:安装</span>
wget https:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>tuna<span class="token punctuation">.</span>tsinghua<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn<span class="token operator">/</span>gitlab<span class="token operator">-</span>ce<span class="token operator">/</span>yum<span class="token operator">/</span>el7<span class="token operator">/</span>gitlab<span class="token operator">-</span>ce<span class="token operator">-</span>11<span class="token punctuation">.</span>9<span class="token punctuation">.</span>11<span class="token operator">-</span>ce<span class="token punctuation">.</span>0<span class="token punctuation">.</span>el7<span class="token punctuation">.</span>x86_64<span class="token punctuation">.</span>rpm
yum localinstall gitlab<span class="token operator">-</span>ce<span class="token operator">-</span>11<span class="token punctuation">.</span>9<span class="token punctuation">.</span>11<span class="token operator">-</span>ce<span class="token punctuation">.</span>0<span class="token punctuation">.</span>el7<span class="token punctuation">.</span>x86_64<span class="token punctuation">.</span>rpm <span class="token operator">-</span>y
<span class="token comment" spellcheck="true">#b:配置</span>
vim <span class="token operator">/</span>etc<span class="token operator">/</span>gitlab<span class="token operator">/</span>gitlab<span class="token punctuation">.</span>rb
external_url <span class="token string">'http://10.0.0.13'</span>
prometheus_monitoring<span class="token punctuation">[</span><span class="token string">'enable'</span><span class="token punctuation">]</span> = false
<span class="token comment" spellcheck="true">#c:应用并启动服务</span>
gitlab<span class="token operator">-</span>ctl reconfigure

<span class="token comment" spellcheck="true">#使用浏览器访问http://10.0.0.13,修改root用户密码,创建project</span>

<span class="token comment" spellcheck="true">#上传代码到git仓库</span>
cd <span class="token operator">/</span>srv<span class="token operator">/</span>
rz <span class="token operator">-</span>E
unzip xiaoniaofeifei<span class="token punctuation">.</span>zip 
<span class="token function">rm</span> <span class="token operator">-</span>fr xiaoniaofeifei<span class="token punctuation">.</span>zip 

git config <span class="token operator">--</span>global user<span class="token punctuation">.</span>name <span class="token string">"Administrator"</span>
git config <span class="token operator">--</span>global user<span class="token punctuation">.</span>email <span class="token string">"admin@example.com"</span>
git init
git remote add origin http:<span class="token operator">/</span><span class="token operator">/</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>13<span class="token operator">/</span>root<span class="token operator">/</span>xiaoniao<span class="token punctuation">.</span>git
git add <span class="token punctuation">.</span>
git commit <span class="token operator">-</span>m <span class="token string">"Initial commit"</span>
git push <span class="token operator">-</span>u origin master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用gitee 仓库</p>
<p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200604225316065-1591358629107.png" alt="image-20200604225316065"></p>
<p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200604225248160-1591358629108.png" alt="image-20200604225248160"></p>
<p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200604225448904-1591358629108.png" alt="image-20200604225448904"></p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@k8s-node-1 ~]</span> <span class="token comment" spellcheck="true">#  git config --global user.name "浅笑痕"</span>
git config <span class="token operator">--</span>global user<span class="token punctuation">.</span>email <span class="token string">"7468467+luhong233@user.noreply.gitee.com"</span>
创建 git 仓库:

mkdir sadas
cd sadas
git init
touch README<span class="token punctuation">.</span>md
git add README<span class="token punctuation">.</span>md
git commit <span class="token operator">-</span>m <span class="token string">"first commit"</span>
git remote add origin https:<span class="token operator">/</span><span class="token operator">/</span>gitee<span class="token punctuation">.</span>com<span class="token operator">/</span>luhong233<span class="token operator">/</span>sadas<span class="token punctuation">.</span>git
git push <span class="token operator">-</span>u origin master
已有仓库?

cd existing_git_repo
git remote add origin https:<span class="token operator">/</span><span class="token operator">/</span>gitee<span class="token punctuation">.</span>com<span class="token operator">/</span>luhong233<span class="token operator">/</span>sadas<span class="token punctuation">.</span>git
git push <span class="token operator">-</span>u origin master
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="7-2-安装jenkins-并自动构建docker镜像"><a href="#7-2-安装jenkins-并自动构建docker镜像" class="headerlink" title="7.2 安装jenkins,并自动构建docker镜像"></a>7.2 安装jenkins,并自动构建docker镜像</h3><h4 id="1-安装jenkins"><a href="#1-安装jenkins" class="headerlink" title="1:安装jenkins"></a>1:安装jenkins</h4><pre class="line-numbers language-powershell"><code class="language-powershell">13 上传
cd <span class="token operator">/</span>opt<span class="token operator">/</span>
wget   http:<span class="token operator">/</span><span class="token operator">/</span>192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>12<span class="token punctuation">.</span>201<span class="token operator">/</span>191216<span class="token operator">/</span>apache<span class="token operator">-</span>tomcat<span class="token operator">-</span>8<span class="token punctuation">.</span>0<span class="token punctuation">.</span>27<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz 
wget   http:<span class="token operator">/</span><span class="token operator">/</span>192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>12<span class="token punctuation">.</span>201<span class="token operator">/</span>191216<span class="token operator">/</span>jdk<span class="token operator">-</span>8u102<span class="token operator">-</span>linux<span class="token operator">-</span>x64<span class="token punctuation">.</span>rpm     
wget   http:<span class="token operator">/</span><span class="token operator">/</span>192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>12<span class="token punctuation">.</span>201<span class="token operator">/</span>191216<span class="token operator">/</span>jenkin<span class="token operator">-</span><span class="token keyword">data</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz       
wget   http:<span class="token operator">/</span><span class="token operator">/</span>192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>12<span class="token punctuation">.</span>201<span class="token operator">/</span>191216<span class="token operator">/</span>jenkins<span class="token punctuation">.</span>war   

 4 16:52 apache<span class="token operator">-</span>tomcat<span class="token operator">-</span>8<span class="token punctuation">.</span>0<span class="token punctuation">.</span>27<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
 4 16:53 jdk<span class="token operator">-</span>8u102<span class="token operator">-</span>linux<span class="token operator">-</span>x64<span class="token punctuation">.</span>rpm
4 16:53 jenkin<span class="token operator">-</span><span class="token keyword">data</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
ROOT<span class="token punctuation">.</span>war


<span class="token namespace">[root@k8s-node-2 /opt]</span> <span class="token comment" spellcheck="true"># rpm -ivh jdk-8u102-linux-x64.rpm </span>
<span class="token namespace">[root@k8s-node-2 /opt]</span> <span class="token comment" spellcheck="true">#mkdir /app -p</span>
<span class="token namespace">[root@k8s-node-2 /opt]</span> <span class="token comment" spellcheck="true">#tar xf apache-tomcat-8.0.27.tar.gz -C /app</span>
<span class="token namespace">[root@k8s-node-2 /opt]</span> <span class="token comment" spellcheck="true">#rm -fr /app/apache-tomcat-8.0.27/webapps/*</span>
<span class="token namespace">[root@k8s-node-2 /opt]</span> <span class="token comment" spellcheck="true">#mv jenkins.war /app/apache-tomcat-8.0.27/webapps/ROOT.war</span>
<span class="token namespace">[root@k8s-node-2 /opt]</span> <span class="token comment" spellcheck="true">#tar xf jenkin-data.tar.gz -C /root</span>
drwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x  13 root root  4096 Jun  4 20:02 <span class="token punctuation">.</span>jenkins

<span class="token namespace">[root@k8s-node-2 /opt]</span> <span class="token comment" spellcheck="true"># /app/apache-tomcat-8.0.27/bin/startup.sh </span>
<span class="token namespace">[root@k8s-node-2 /opt]</span> <span class="token comment" spellcheck="true">#netstat -lntup</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="2-访问jenkins"><a href="#2-访问jenkins" class="headerlink" title="2:访问jenkins"></a>2:访问jenkins</h4><p>访问<a href="http://10.0.0.12:8080/,默认账号密码admin:123456" target="_blank" rel="noopener">http://10.0.0.12:8080/,默认账号密码admin:123456</a></p>
<h4 id="3-配置jenkins拉取gitlab代码凭据"><a href="#3-配置jenkins拉取gitlab代码凭据" class="headerlink" title="3:配置jenkins拉取gitlab代码凭据"></a>3:配置jenkins拉取gitlab代码凭据</h4><p>==如何实现，自动化构建镜像，拉取，自动构建镜像==</p>
<p>==方法1：执行脚本 生产dockerfile文件==<br>==方法2：把dockerfile文件上传代码仓库，==</p>
<hr>
<pre><code>创建

Dockerfile


浅笑痕 提交于 5小时前 . add Dockerfile.

FROM 10.0.0.11:5000/nginx:1.13

ADD . /usr/share/nginx/html

</code></pre><p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200604230845049-1591358629108.png" alt="image-20200604230845049"></p>
<p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200604231047091-1591358629108.png" alt="image-20200604231047091"></p>
<pre><code>填写码云账户密码</code></pre><p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200604232437233-1591358629108.png" alt></p>
<p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200604232410087-1591358629108.png" alt="image-20200604232410087"></p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@k8s-node-2 ~/.jenkins/workspace/yiliao]</span> <span class="token comment" spellcheck="true"># </span>
<span class="token namespace">[root@k8s-node-2 ~/.jenkins]</span> <span class="token comment" spellcheck="true"># docker images  yiliao</span>

<span class="token operator">--</span> 参数化构件
docker build  <span class="token operator">-</span>t yiliao:<span class="token variable">$version</span>   <span class="token punctuation">.</span>
docker tag yiliao:<span class="token variable">$version</span>  10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>yiliao:<span class="token variable">$version</span>
docker push   10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>yiliao:<span class="token variable">$version</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="k8s-实现"><a href="#k8s-实现" class="headerlink" title="k8s 实现-"></a>k8s 实现-</h3><pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@k8s-matser /k8s_yaml]</span> <span class="token comment" spellcheck="true"># kubectl  create  namespace  yiliao</span>

<span class="token namespace">[root@k8s-matser /k8s_yaml]</span> <span class="token comment" spellcheck="true"># kubectl run -n yiliao yiliao --image=10.0.0.11:5000/yiliao:v3 --replicas=2 --record</span>
deployment <span class="token string">"yiliao"</span> created

svc 
<span class="token namespace">[root@k8s-matser /k8s_yaml]</span> <span class="token comment" spellcheck="true"># kubectl expose -n yiliao deployment yiliao --port=80 --target-port=80 --type=NodePort</span>


<span class="token namespace">[root@k8s-matser /k8s_yaml]</span> <span class="token comment" spellcheck="true"># kubectl get all -n yiliao</span>

升级
<span class="token namespace">[root@k8s-matser /k8s_yaml]</span> <span class="token comment" spellcheck="true"># kubectl  set image -n yiliao deployment yiliao yiliao=10.0.0.11:5000/yiliao:v4</span>


<span class="token namespace">[root@k8s-node-2 ~/.jenkins]</span> <span class="token comment" spellcheck="true"># kubectl  -s 10.0.0.11:8080  get  pod</span>

发布更新
kubectl  <span class="token operator">-</span>s 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:8080 <span class="token function">set</span> image <span class="token operator">-</span>n yiliao deployment yiliao yiliao=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>yiliao:<span class="token variable">$version</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200604234048076-1591358629108.png" alt="image-20200604234048076"></p>
<hr>
<p>a:在jenkins上生成秘钥对</p>
<p>ssh-keygen -t rsa</p>
<p>b:复制公钥粘贴gitlab上</p>
<p><img src="https://www.qstack.com.cn/wp-content/uploads/2019/08/1563702364496.png" alt="1563702364496"></p>
<p>c:jenkins上创建全局凭据</p>
<p><img src="https://www.qstack.com.cn/wp-content/uploads/2019/08/1563703546003.png" alt="1563703546003"></p>
<h4 id="4-拉取代码测试"><a href="#4-拉取代码测试" class="headerlink" title="4:拉取代码测试"></a>4:拉取代码测试</h4><p><img src="https://www.qstack.com.cn/wp-content/uploads/2019/08/1563702548557.png" alt="1563702548557"></p>
<h4 id="5-编写dockerfile并测试"><a href="#5-编写dockerfile并测试" class="headerlink" title="5:编写dockerfile并测试"></a>5:编写dockerfile并测试</h4><pre><code>#vim dockerfile
FROM 10.0.0.11:5000/nginx:1.13
add .  /usr/share/nginx/html</code></pre><p>添加docker build构建时不add的文件</p>
<p>vim  .dockerignore dockerfile</p>
<p>docker build -t xiaoniao:v1 . docker run -d -p 88:80 xiaoniao:v1</p>
<p>打开浏览器测试访问xiaoniaofeifei的项目</p>
<h4 id="6-上传dockerfile和-dockerignore到私有仓库"><a href="#6-上传dockerfile和-dockerignore到私有仓库" class="headerlink" title="6:上传dockerfile和.dockerignore到私有仓库"></a>6:上传dockerfile和.dockerignore到私有仓库</h4><p>git add docker  .dockerignore git commit -m “fisrt commit” git push -u origin master</p>
<h4 id="7-点击jenkins立即构建-自动构建docker镜像并上传到私有仓库"><a href="#7-点击jenkins立即构建-自动构建docker镜像并上传到私有仓库" class="headerlink" title="7:点击jenkins立即构建,自动构建docker镜像并上传到私有仓库"></a>7:点击jenkins立即构建,自动构建docker镜像并上传到私有仓库</h4><p>修改jenkins 工程配置</p>
<p><img src="https://www.qstack.com.cn/wp-content/uploads/2019/08/1563702843438.png" alt="1563702843438"></p>
<p>docker  build  -t  10.0.0.11:5000/test:v$BUILD_ID  . docker  push 10.0.0.11:5000/test:v$BUILD_ID</p>
<p>7.3  jenkins自动部署应用到k8s</p>
<p>kubectl -s 10.0.0.11:8080  get nodes</p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">-</span>f <span class="token operator">/</span>tmp<span class="token operator">/</span>xiaoniao<span class="token punctuation">.</span>lock <span class="token punctuation">]</span><span class="token punctuation">;</span>then
    docker  build  <span class="token operator">-</span>t  10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>xiaoniao:v<span class="token variable">$BUILD_ID</span>  <span class="token punctuation">.</span>
    docker  push 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>xiaoniao:v<span class="token variable">$BUILD_ID</span>
    kubectl <span class="token operator">-</span>s 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:8080 <span class="token function">set</span> image  <span class="token operator">-</span>n xiaoniao deploy xiaoniao xiaoniao=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>xiaoniao:v<span class="token variable">$BUILD_ID</span>
    port=`kubectl <span class="token operator">-</span>s 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:8080  get svc <span class="token operator">-</span>n xiaoniao<span class="token punctuation">|</span>grep <span class="token operator">-</span>oP <span class="token string">'(?&lt;=80:)\d+'</span>`
    <span class="token function">echo</span> <span class="token string">"你的项目地址访问是http://10.0.0.13:<span class="token variable">$port</span>"</span>
    <span class="token function">echo</span> <span class="token string">"更新成功"</span>
<span class="token keyword">else</span>
    docker  build  <span class="token operator">-</span>t  10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>xiaoniao:v<span class="token variable">$BUILD_ID</span>  <span class="token punctuation">.</span>
    docker  push 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>xiaoniao:v<span class="token variable">$BUILD_ID</span>
    kubectl  <span class="token operator">-</span>s 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:8080  create  namespace  xiaoniao
    kubectl  <span class="token operator">-</span>s 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:8080  run   xiaoniao  <span class="token operator">-</span>n xiaoniao  <span class="token operator">--</span>image=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>xiaoniao:v<span class="token variable">$BUILD_ID</span> <span class="token operator">--</span>replicas=3 <span class="token operator">--</span>record
    kubectl  <span class="token operator">-</span>s 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:8080   expose <span class="token operator">-</span>n xiaoniao deployment xiaoniao <span class="token operator">--</span>port=80 <span class="token operator">--</span><span class="token function">type</span>=NodePort
    port=`kubectl <span class="token operator">-</span>s 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:8080  get svc <span class="token operator">-</span>n xiaoniao<span class="token punctuation">|</span>grep <span class="token operator">-</span>oP <span class="token string">'(?&lt;=80:)\d+'</span>`
    <span class="token function">echo</span> <span class="token string">"你的项目地址访问是http://10.0.0.13:<span class="token variable">$port</span>"</span>
    <span class="token function">echo</span> <span class="token string">"发布成功"</span>
    touch <span class="token operator">/</span>tmp<span class="token operator">/</span>xiaoniao<span class="token punctuation">.</span>lock
    chattr <span class="token operator">+</span>i <span class="token operator">/</span>tmp<span class="token operator">/</span>xiaoniao<span class="token punctuation">.</span>lock
fi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="jenkins一键回滚"><a href="#jenkins一键回滚" class="headerlink" title="jenkins一键回滚"></a>jenkins一键回滚</h3><p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200605151324420-1591358629108.png" alt="image-20200605151324420"></p>
<p>`</p>
<hr>
<pre class="line-numbers language-powershell"><code class="language-powershell">新的job 回滚 
1-<span class="token operator">-</span>创建新的  创建  新的job  
2-<span class="token operator">-</span> 配置<span class="token operator">--</span><span class="token operator">-</span>参数化构建过程<span class="token operator">--</span><span class="token operator">-</span>宇符参数 <span class="token operator">--</span><span class="token operator">-</span>version
3-<span class="token operator">-</span>构建环境<span class="token operator">--</span><span class="token operator">-</span>执行shell

<span class="token operator">--</span>-<span class="token operator">--</span><span class="token operator">-</span>
kubectl <span class="token operator">-</span>s 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:8080 <span class="token function">set</span> image <span class="token operator">-</span>n yiliao deployment yiliao yiliao=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>yiliao:<span class="token variable">$version</span>
<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span>


kubectl <span class="token operator">-</span>s 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:8080 <span class="token function">set</span> image <span class="token operator">-</span>n yiliao deployment yiliao yiliao=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>yiliao:<span class="token variable">$version</span>


方法1：
kubectl <span class="token operator">-</span>s 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:8080  rollout undo <span class="token operator">-</span>n yiliao deployment yiliao
方法2：
kubectl <span class="token operator">-</span>s 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:8080 <span class="token function">set</span> image <span class="token operator">-</span>n yiliao deployment yiliao yiliao=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:5000<span class="token operator">/</span>yiliao:v2

kubectl  <span class="token operator">-</span>s 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:8080 rollout undo <span class="token operator">-</span>n xiaoniao  deployment xiaoniao
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200605092723070-1591358629108.png" alt="image-20200605092723070"></p>
<p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200605092733107-1591358629108.png" alt="image-20200605092733107"></p>
<h2 id="8-k8s高可用"><a href="#8-k8s高可用" class="headerlink" title="8: k8s高可用"></a>8: k8s高可用</h2><p>8.1: 安装配置etcd高可用集群</p>
<p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/image-20200605152815262-1591358629108.png" alt="image-20200605152815262"></p>
<pre><code>etcd 高科用  </code></pre><hr>
<table>
<thead>
<tr>
<th>root@k8s-matser</th>
<th>10.0.0.0.11</th>
<th>主节点</th>
</tr>
</thead>
<tbody><tr>
<td>root@k8s-matser2</td>
<td>10.0.0.12</td>
<td>主节点</td>
</tr>
<tr>
<td>root@k8s-node</td>
<td>10.0.0.13</td>
<td>node 节点</td>
</tr>
</tbody></table>
<pre class="line-numbers language-powershell"><code class="language-powershell">清理环境重新部署不算

主节点
<span class="token namespace">[root@k8s-matser ~]</span> <span class="token comment" spellcheck="true"># systemctl stop kube-apiserver.service </span>
<span class="token namespace">[root@k8s-matser ~]</span> <span class="token comment" spellcheck="true"># systemctl stop kube-controller-manager.service </span>
<span class="token namespace">[root@k8s-matser ~]</span> <span class="token comment" spellcheck="true"># systemctl stop kube-scheduler.service </span>
<span class="token namespace">[root@k8s-matser ~]</span> <span class="token comment" spellcheck="true"># systemctl stop etcd.service </span>

<span class="token function">cat</span> <span class="token operator">/</span>etc<span class="token operator">/</span>etcd<span class="token operator">/</span>etcd<span class="token punctuation">.</span>conf <span class="token punctuation">|</span>grep <span class="token operator">-</span>v <span class="token string">'^$|#'</span>
<span class="token function">cat</span> <span class="token operator">/</span>etc<span class="token operator">/</span>etcd<span class="token operator">/</span>etcd<span class="token punctuation">.</span>conf <span class="token punctuation">|</span>grep <span class="token operator">-</span>Ev <span class="token string">'^$|#'</span>
<span class="token function">ls</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>etcd<span class="token operator">/</span>
<span class="token function">ls</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>etcd<span class="token operator">/</span>default<span class="token punctuation">.</span>etcd<span class="token operator">/</span>
<span class="token function">ls</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>etcd<span class="token operator">/</span>default<span class="token punctuation">.</span>etcd<span class="token operator">/</span>member<span class="token operator">/</span>
tree <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>etcd<span class="token operator">/</span>default<span class="token punctuation">.</span>etcd<span class="token operator">/</span>member<span class="token operator">/</span>
<span class="token function">rm</span> <span class="token operator">-</span>fr <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>etcd<span class="token operator">/</span>default<span class="token punctuation">.</span>etcd


node

<span class="token namespace">[root@k8s-node-2 ~]</span> <span class="token comment" spellcheck="true"># systemctl stop kubelet.service </span>
<span class="token namespace">[root@k8s-node-2 ~]</span> <span class="token comment" spellcheck="true"># systemctl stop kube-proxy.service </span>
<span class="token namespace">[root@k8s-node-2 ~]</span> <span class="token comment" spellcheck="true"># docker rm -f `docker ps -a -q`</span>

yum install  etcd  <span class="token operator">-</span>y

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-spreadsheet"><code class="language-spreadsheet">#所有节点安装etcd
yum install  etcd  -y

-------
配置etcd 集群
======================
 vim /etc/etcd/etcd.conf 
3:ETCD_DATA_DIR="/var/lib/etcd/"
5:ETCD_LISTEN_PEER_URLS="http://0.0.0.0:2380"
6:ETCD_LISTEN_CLIENT_URLS="http://0.0.0.0:2379"
9:ETCD_NAME="node1"  #节点的名字
20:ETCD_INITIAL_ADVERTISE_PEER_URLS="http://10.0.0.11:2380"   #节点的同步数据的地址
# 初始化加入集群-改为自己的ip 地址 

21:ETCD_ADVERTISE_CLIENT_URLS="http://10.0.0.11:2379"         #节点对外提供服务的地址
# 在集群里面的地址

26:ETCD_INITIAL_CLUSTER="node1=http://10.0.0.11:2380,node2=http://10.0.0.12:2380,node3=http://10.0.0.13:2380"
# 集群有哪些人

27:ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"  #集群口令
28:ETCD_INITIAL_CLUSTER_STATE="new"

[root@k8s-matser ~] # scp /etc/etcd/etcd.conf  10.0.0.13:/etc/etcd/etcd.conf
[root@k8s-matser ~] # scp /etc/etcd/etcd.conf  10.0.0.12:/etc/etcd/etcd.con

修改注释地址  # 12  13   节点名字
9 行   
20 行 
21 行
======================
所有节点---------启动时同时执行
systemctl enable  etcd
systemctl restart  etcd
--------------------------
检查  
[root@k8s-master tomcat_demo]# etcdctl cluster-health
member 9e80988e833ccb43 is healthy: got healthy result from http://10.0.0.11:2379
member a10d8f7920cc71c7 is healthy: got healthy result from http://10.0.0.13:2379
member abdc532bc0516b2d is healthy: got healthy result from http://10.0.0.12:2379
cluster is healthy



#修改flannel
[root@k8s-matser ~] vim  /etc/sysconfig/flanneld  FLANNEL_ETCD_ENDPOINTS="http://10.0.0.11:2379,http://10.0.0.12:2379,http://10.0.0.13:2379"     4行
[root@k8s-matser ~] # scp /etc/sysconfig/flanneld  10.0.0.13:/etc/sysconfig/flanneld
[root@k8s-matser ~] # scp /etc/sysconfig/flanneld  10.0.0.12:/etc/sysconfig/flanneld
节点同步

--任何一节点--网络 ---创建网段
etcdctl mk /atomic.io/network/config   '{ "Network": "172.18.0.0/16" }'
--所有节点
systemctl  restart flanneld
systemctl  restart docker

[root@k8s-matser ~] # ifconfig 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>8.2 安装配置master01的api-server,controller-manager,scheduler(127.0.0.1:8080)</p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@k8s-matser ~]</span> <span class="token comment" spellcheck="true"># vim /etc/kubernetes/apiserver  增加节点 使用etcd 集群</span>
17 KUBE_ETCD_SERVERS=<span class="token string">"--etcd-servers=http://10.0.0.11:2379,http://10.0.0.12:2379,http://10.0.0.13:2379"</span>

<span class="token namespace">[root@k8s-matser ~]</span> <span class="token comment" spellcheck="true"># vim /etc/kubernetes/config   # 找 apiserv 找个字的apiser 可以指向vip</span>
 22 KUBE_MASTER=<span class="token string">"--master=http://127.0.0.1:8080"</span>


<span class="token namespace">[root@k8s-matser ~]</span> <span class="token comment" spellcheck="true">#  systemctl restart kube-apiserver.service </span>
<span class="token namespace">[root@k8s-matser ~]</span> <span class="token comment" spellcheck="true"># systemctl restart kube-controller-manager.service kube-scheduler.service </span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>8.3 安装配置master02的api-server,controller-manager,scheduler(127.0.0.1:8080)</p>
<pre class="line-numbers language-shell"><code class="language-shell">[root@k8s-node-1 ~] # yum install kubernetes-master.x86_64 -y
scp -rp 10.0.0.11:/etc/kubernetes/apiserver /etc/kubernetes/apiserver
scp -rp 10.0.0.11:/etc/kubernetes/config /etc/kubernetes/config 
systemctl stop kubelet.service 
systemctl disable kubelet.service
systemctl stop kube-proxy.service 
systemctl disable kube-proxy.service

systemctl enable kube-apiserver.service
systemctl restart kube-apiserver.service
systemctl enable kube-controller-manager.service
systemctl restart kube-controller-manager.service
systemctl enable kube-scheduler.service
systemctl restart kube-scheduler.service

[root@k8s-node-1 ~] # kubectl  get componentstatus   2个嗲点都要可以 
NAME                 STATUS    MESSAGE             ERROR
etcd-2               Healthy   {"health":"true"}   
etcd-0               Healthy   {"health":"true"}   
scheduler            Healthy   ok                  
controller-manager   Healthy   ok                  
etcd-1               Healthy   {"health":"true"}   
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>8.4 为m==aster01和master02安装配置Keepalived==</p>
<p>使用 ==非抢占  nopreempt==</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">yum install keepalived<span class="token punctuation">.</span>x86_64 <span class="token operator">-</span>y
<span class="token namespace">[root@k8s-matser ~]</span> <span class="token comment" spellcheck="true"># vim /etc/keepalived/keepalived.conf </span>

<span class="token comment" spellcheck="true">#master01配置:</span>
<span class="token operator">!</span> Configuration File <span class="token keyword">for</span> keepalived

global_defs <span class="token punctuation">{</span>
   router_id LVS_DEVEL_11
<span class="token punctuation">}</span>

vrrp_instance VI_1 <span class="token punctuation">{</span>
    state BACKUP
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication <span class="token punctuation">{</span>
        auth_type PASS
        auth_pass 1111
    <span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{</span>
        10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>10
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">#master02配置</span>
<span class="token namespace">[root@k8s-node-1 ~]</span> <span class="token comment" spellcheck="true"># vim /etc/keepalived/keepalived.conf </span>

<span class="token operator">!</span> Configuration File <span class="token keyword">for</span> keepalived

global_defs <span class="token punctuation">{</span>
   router_id LVS_DEVEL_12
<span class="token punctuation">}</span>

vrrp_instance VI_1 <span class="token punctuation">{</span>
    state BACKUP
    interface eth0
    virtual_router_id 51
    priority 80
    advert_int 1
    authentication <span class="token punctuation">{</span>
        auth_type PASS
        auth_pass 1111
    <span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{</span>
        10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>10
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

systemctl  enable  keepalived
systemctl  <span class="token function">start</span>   keepalived<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>8.5: 所有node节点kubelet,kube-proxy指向api-server的vip</p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@k8s-node-2 ~]</span> <span class="token comment" spellcheck="true"># vim /etc/kubernetes/kubelet</span>
14 KUBELET_API_SERVER=<span class="token string">"--api-servers=http://10.0.0.10:8080"</span>     vip 地址


<span class="token namespace">[root@k8s-node-2 ~]</span> <span class="token comment" spellcheck="true"># vim /etc/kubernetes/config </span>
 22 KUBE_MASTER=<span class="token string">"--master=http://10.0.0.10:8080"</span>


<span class="token namespace">[root@k8s-node-2 ~]</span> <span class="token comment" spellcheck="true">#  systemctl restart kubelet.service kube-proxy.service</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="资源控制器"><a href="#资源控制器" class="headerlink" title="资源控制器"></a>资源控制器</h3><pre class="line-numbers language-powershell"><code class="language-powershell">什么是控制器
Kubernetes 中内建了很多 controller（控制器），这些相当于一个状态机，用来控制 Pod 的具体状态和行为
控制器类型
ReplicationController 和 ReplicaSet
Deployment
DaemonSet
StateFulSet
Job<span class="token operator">/</span>CronJob
Horizontal Pod Autoscaling
ReplicationController 和 ReplicaSet
ReplicationController（RC）用来确保容器应用的副本数始终保持在用户定义的副本数，即如果有容器异常退
出，会自动创建新的 Pod 来替代；而如果异常多出来的容器也会自动回收；
在新版本的 Kubernetes 中建议使用 ReplicaSet 来取代 ReplicationController 。ReplicaSet 跟
ReplicationController 没有本质的不同，只是名字不一样，并且 ReplicaSet 支持集合式的 selector；
Deployment
Deployment 为 Pod 和 ReplicaSet 提供了一个声明式定义 <span class="token punctuation">(</span>declarative<span class="token punctuation">)</span> 方法，用来替代以前的
ReplicationController 来方便的管理应用。典型的应用场景包括；
定义 Deployment 来创建 Pod 和 ReplicaSet
滚动升级和回滚应用
扩容和缩容
暂停和继续 Deployment
DaemonSet
DaemonSet 确保全部（或者一些）Node 上运行一个 Pod 的副本。当有 Node 加入集群时，也会为他们新增一个
Pod 。当有 Node 从集群移除时，这些 Pod 也会被回收。删除 DaemonSet 将会删除它创建的所有 Pod
使用 DaemonSet 的一些典型用法：
运行集群存储 daemon，例如在每个 Node 上运行 glusterd 、ceph
在每个 Node 上运行日志收集 daemon，例如fluentd 、logstash
在每个 Node 上运行监控 daemon，例如 Prometheus Node Exporter、collectd 、Datadog 代理、
New Relic 代理，或 Ganglia gmond
Job
Job 负责批处理任务，即仅执行一次的任务，它保证批处理任务的一个或多个 Pod 成功结束
CronJob
Cron Job 管理基于时间的 Job，即：
在给定时间点只运行一次
周期性地在给定时间点运行
使用前提条件：<span class="token operator">*</span><span class="token operator">*</span>当前使用的 Kubernetes 集群，版本 >= 1<span class="token punctuation">.</span>8（对 CronJob）。对于先前版本的集群，版本 &lt;
1<span class="token punctuation">.</span>8，启动 API Server时，通过传递选项 <span class="token operator">--</span>runtime<span class="token operator">-</span>config=batch<span class="token operator">/</span>v2alpha1=true 可以开启 batch<span class="token operator">/</span>v2alpha1
API*<span class="token operator">*</span>
典型的用法如下所示：
在给定的时间点调度 Job 运行
创建周期性运行的 Job，例如：数据库备份、发送邮件
StatefulSet
StatefulSet 作为 Controller 为 Pod 提供唯一的标识。它可以保证部署和 scale 的顺序
StatefulSet是为了解决有状态服务的问题（对应Deployments和ReplicaSets是为无状态服务而设计），其应用
场景包括：
稳定的持久化存储，即Pod重新调度后还是能访问到相同的持久化数据，基于PVC来实现
稳定的网络标志，即Pod重新调度后其PodName和HostName不变，基于Headless Service（即没有
Cluster IP的Service）来实现
有序部署，有序扩展，即Pod是有顺序的，在部署或者扩展的时候要依据定义的顺序依次依次进行（即从0到
N<span class="token operator">-</span>1，在下一个Pod运行之前所有之前的Pod必须都是Running和Ready状态），基于init containers来实
现
有序收缩，有序删除（即从N<span class="token operator">-</span>1到0）
Horizontal Pod Autoscaling
应用的资源使用率通常都有高峰和低谷的时候，如何削峰填谷，提高集群的整体资源利用率，让service中的Pod
个数自动调整呢？这就有赖于Horizontal Pod Autoscaling了，顾名思义，使Pod水平自动缩放<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="9-k8s-1-85-admin-版本"><a href="#9-k8s-1-85-admin-版本" class="headerlink" title="9.k8s _1.85 admin 版本"></a>9.k8s _1.85 admin 版本</h2><pre><code>https://oldqiang.com/archives/624.html</code></pre><h3 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求:"></a>环境要求:</h3><table>
<thead>
<tr>
<th align="left">机器名</th>
<th align="left">ip地址</th>
<th align="left">cpu和内存要求</th>
</tr>
</thead>
<tbody><tr>
<td align="left">kubernetes-master</td>
<td align="left">10.0.0.11</td>
<td align="left">2c2g(关闭swap)</td>
</tr>
<tr>
<td align="left">kubernetes-node1</td>
<td align="left">10.0.0.12</td>
<td align="left">2c2g(关闭swap)</td>
</tr>
</tbody></table>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@kubernetes-master ~]</span> <span class="token comment" spellcheck="true"># cat /etc/hosts</span>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1   localhost localhost<span class="token punctuation">.</span>localdomain localhost4 localhost4<span class="token punctuation">.</span>localdomain4
::1         localhost localhost<span class="token punctuation">.</span>localdomain localhost6 localhost6<span class="token punctuation">.</span>localdomain6

10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11   kubernetes<span class="token operator">-</span>master
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12    kubernetes<span class="token operator">-</span>node1

增加解析<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>###1- 安装指定版本docker</p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token comment" spellcheck="true">#安装docker-ce#</span>
文档地址清华源码
curl <span class="token operator">-</span>o <span class="token operator">/</span>etc<span class="token operator">/</span>yum<span class="token punctuation">.</span>repos<span class="token punctuation">.</span>d<span class="token operator">/</span>CentOS<span class="token operator">-</span>Base<span class="token punctuation">.</span>repo http:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>repo<span class="token operator">/</span>Centos<span class="token operator">-</span>7<span class="token punctuation">.</span>repo
wget <span class="token operator">-</span>O <span class="token operator">/</span>etc<span class="token operator">/</span>yum<span class="token punctuation">.</span>repos<span class="token punctuation">.</span>d<span class="token operator">/</span>docker<span class="token operator">-</span>ce<span class="token punctuation">.</span>repo https:<span class="token operator">/</span><span class="token operator">/</span>download<span class="token punctuation">.</span>docker<span class="token punctuation">.</span>com<span class="token operator">/</span>linux<span class="token operator">/</span>centos<span class="token operator">/</span>docker<span class="token operator">-</span>ce<span class="token punctuation">.</span>repo
sed <span class="token operator">-</span>i <span class="token string">'s+download.docker.com+mirrors.tuna.tsinghua.edu.cn/docker-ce+'</span> <span class="token operator">/</span>etc<span class="token operator">/</span>yum<span class="token punctuation">.</span>repos<span class="token punctuation">.</span>d<span class="token operator">/</span>docker<span class="token operator">-</span>ce<span class="token punctuation">.</span>repo
yum install docker<span class="token operator">-</span>ce <span class="token operator">-</span>y

systemctl enable docker
systemctl <span class="token function">start</span> docker


<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-安装kubeadm"><a href="#2-安装kubeadm" class="headerlink" title="2:安装kubeadm"></a>2:安装kubeadm</h2><pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token comment" spellcheck="true">#所有节点</span>
<span class="token function">cat</span> &lt;&lt;EOF > <span class="token operator">/</span>etc<span class="token operator">/</span>yum<span class="token punctuation">.</span>repos<span class="token punctuation">.</span>d<span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>repo
<span class="token namespace">[kubernetes]</span>
name=Kubernetes
baseurl=https:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>kubernetes<span class="token operator">/</span>yum<span class="token operator">/</span>repos<span class="token operator">/</span>kubernetes<span class="token operator">-</span>el7<span class="token operator">-</span>x86_64<span class="token operator">/</span>
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>kubernetes<span class="token operator">/</span>yum<span class="token operator">/</span>doc<span class="token operator">/</span>yum<span class="token operator">-</span>key<span class="token punctuation">.</span>gpg https:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>kubernetes<span class="token operator">/</span>yum<span class="token operator">/</span>doc<span class="token operator">/</span>rpm<span class="token operator">-</span>package<span class="token operator">-</span>key<span class="token punctuation">.</span>gpg
EOF
​
yum install kubelet<span class="token operator">-</span>1<span class="token punctuation">.</span>15<span class="token punctuation">.</span>5<span class="token operator">-</span>0 kubeadm<span class="token operator">-</span>1<span class="token punctuation">.</span>15<span class="token punctuation">.</span>5<span class="token operator">-</span>0 kubectl<span class="token operator">-</span>1<span class="token punctuation">.</span>15<span class="token punctuation">.</span>5<span class="token operator">-</span>0 <span class="token operator">-</span>y
systemctl enable kubelet &amp;&amp; systemctl <span class="token function">start</span> kubelet





<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span>
最新版<span class="token operator">--</span>-<span class="token operator">--</span><span class="token operator">-</span>

<span class="token function">cat</span> &lt;&lt;EOF > <span class="token operator">/</span>etc<span class="token operator">/</span>yum<span class="token punctuation">.</span>repos<span class="token punctuation">.</span>d<span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>repo
<span class="token namespace">[kubernetes]</span>
name=Kubernetes
baseurl=https:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>kubernetes<span class="token operator">/</span>yum<span class="token operator">/</span>repos<span class="token operator">/</span>kubernetes<span class="token operator">-</span>el7<span class="token operator">-</span>x86_64<span class="token operator">/</span>
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>kubernetes<span class="token operator">/</span>yum<span class="token operator">/</span>doc<span class="token operator">/</span>yum<span class="token operator">-</span>key<span class="token punctuation">.</span>gpg https:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>kubernetes<span class="token operator">/</span>yum<span class="token operator">/</span>doc<span class="token operator">/</span>rpm<span class="token operator">-</span>package<span class="token operator">-</span>key<span class="token punctuation">.</span>gpg
EOF
setenforce 0
yum install <span class="token operator">-</span>y kubelet kubeadm kubectl
systemctl enable kubelet &amp;&amp; systemctl <span class="token function">start</span> kubelet



https:<span class="token operator">/</span><span class="token operator">/</span>developer<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com<span class="token operator">/</span>mirror<span class="token operator">/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-使用kubeadm初始化k8s集群"><a href="#3-使用kubeadm初始化k8s集群" class="headerlink" title="3:使用kubeadm初始化k8s集群"></a>3:使用kubeadm初始化k8s集群</h3><pre class="line-numbers language-powershell"><code class="language-powershell">https:<span class="token operator">/</span><span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>io<span class="token operator">/</span>docs<span class="token operator">/</span>setup<span class="token operator">/</span>production<span class="token operator">-</span>environment<span class="token operator">/</span>tools<span class="token operator">/</span>kubeadm<span class="token operator">/</span>install<span class="token operator">-</span>kubeadm<span class="token operator">/</span>

<span class="token comment" spellcheck="true">#所有节点  优化内核</span>
<span class="token function">cat</span> &lt;&lt;EOF <span class="token punctuation">|</span> sudo <span class="token function">tee</span> <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>d<span class="token operator">/</span>k8s<span class="token punctuation">.</span>conf
net<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>bridge<span class="token operator">-</span>nf<span class="token operator">-</span>call<span class="token operator">-</span>ip6tables = 1
net<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>bridge<span class="token operator">-</span>nf<span class="token operator">-</span>call<span class="token operator">-</span>iptables = 1
EOF
sudo sysctl <span class="token operator">--</span>system


<span class="token operator">--</span>关闭swap 
swapoff <span class="token operator">-</span>a
vim <span class="token operator">/</span>etc<span class="token operator">/</span>fstab
​


<span class="token comment" spellcheck="true">#控制节点</span>
kubeadm init <span class="token operator">--</span>kubernetes<span class="token operator">-</span>version=v1<span class="token punctuation">.</span>15<span class="token punctuation">.</span>0 <span class="token operator">--</span>image<span class="token operator">-</span>repository registry<span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com<span class="token operator">/</span>google_containers  <span class="token operator">--</span>pod<span class="token operator">-</span>network<span class="token operator">-</span>cidr=10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token operator">/</span>16 <span class="token operator">--</span>service<span class="token operator">-</span>cidr=10<span class="token punctuation">.</span>254<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token operator">/</span>16
​
 <span class="token operator">--</span>kubernetes<span class="token operator">-</span>version=v1<span class="token punctuation">.</span>15<span class="token punctuation">.</span>0   指定版本 删掉最新版本
<span class="token operator">--</span>image<span class="token operator">-</span>repository   镜像地址 

<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span>
<span class="token namespace">[root@kubernetes-master ~]</span> <span class="token comment" spellcheck="true">#  kubeadm init --kubernetes-version=v1.18.0 --image-repository registry.aliyuncs.com/google_containers  --pod-network-cidr=10.244.0.0/16 --service-cidr=10.254.0.0/16</span>

<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span>



mkdir <span class="token operator">-</span>p <span class="token variable">$HOME</span><span class="token operator">/</span><span class="token punctuation">.</span>kube
sudo <span class="token function">cp</span> <span class="token operator">-</span>i <span class="token operator">/</span>etc<span class="token operator">/</span>kubernetes<span class="token operator">/</span>admin<span class="token punctuation">.</span>conf <span class="token variable">$HOME</span><span class="token operator">/</span><span class="token punctuation">.</span>kube<span class="token operator">/</span>config
sudo chown $<span class="token punctuation">(</span>id <span class="token operator">-</span>u<span class="token punctuation">)</span>:$<span class="token punctuation">(</span>id <span class="token operator">-</span>g<span class="token punctuation">)</span> <span class="token variable">$HOME</span><span class="token operator">/</span><span class="token punctuation">.</span>kube<span class="token operator">/</span>config

<span class="token namespace">[root@kubernetes-master ~]</span> <span class="token comment" spellcheck="true"># kubectl  get  componentstatus</span>
NAME                 STATUS    MESSAGE             ERROR
scheduler            Healthy   ok                  
controller<span class="token operator">-</span>manager   Healthy   ok                  
etcd<span class="token operator">-</span>0               Healthy   <span class="token punctuation">{</span><span class="token string">"health"</span>:<span class="token string">"true"</span><span class="token punctuation">}</span>   



<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-给k8s集群加入node节点"><a href="#4-给k8s集群加入node节点" class="headerlink" title="4:给k8s集群加入node节点:"></a>4:给k8s集群加入node节点:</h3><pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token comment" spellcheck="true">#node节点  复制主节点的 </span>
kubeadm join 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>11:6443 <span class="token operator">--</span>token 47hq6d<span class="token punctuation">.</span>uvtn5ymfah6egl53 \
    <span class="token operator">--</span>discovery<span class="token operator">-</span>token<span class="token operator">-</span>ca<span class="token operator">-</span>cert<span class="token operator">-</span>hash sha256:ff283c3350b5dfa0ac8c093383416c535485ec18d5cdd6b82273e0d198157605 

    <span class="token operator">--</span>-<span class="token operator">-</span>
<span class="token namespace">[root@kubernetes-node1 ~]</span> <span class="token comment" spellcheck="true"># kubeadm join 10.0.0.11:6443 --token 743fl1.exoyrjn8kcr5ufwz \</span>
>     <span class="token operator">--</span>discovery<span class="token operator">-</span>token<span class="token operator">-</span>ca<span class="token operator">-</span>cert<span class="token operator">-</span>hash sha256:55b61e6c9fda7657d82b8dc7ae47b9492dfd2ed5a2fe2b06ec4c707df1054a5f 

<span class="token namespace">[root@kubernetes-master ~]</span> <span class="token comment" spellcheck="true"># kubectl  get node</span>
NAME                STATUS     ROLES    AGE     VERSION
kubernetes<span class="token operator">-</span>master   NotReady   master   3m14s   v1<span class="token punctuation">.</span>18<span class="token punctuation">.</span>3
kubernetes<span class="token operator">-</span>node1    NotReady   &lt;none>   2m39s   v1<span class="token punctuation">.</span>18<span class="token punctuation">.</span>3
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="5-为k8s集群配置网络插件"><a href="#5-为k8s集群配置网络插件" class="headerlink" title="5:为k8s集群配置网络插件"></a>5:为k8s集群配置网络插件</h3><pre class="line-numbers language-powershell"><code class="language-powershell">wget https:<span class="token operator">/</span><span class="token operator">/</span>raw<span class="token punctuation">.</span>githubusercontent<span class="token punctuation">.</span>com<span class="token operator">/</span>coreos<span class="token operator">/</span>flannel<span class="token operator">/</span>master<span class="token operator">/</span>Documentation<span class="token operator">/</span>kube<span class="token operator">-</span>flannel<span class="token punctuation">.</span>yml

或者上传    
128       <span class="token string">"Network"</span>: <span class="token string">"10.244.0.0/16"</span><span class="token punctuation">,</span>

<span class="token comment" spellcheck="true">#修改网段范围为  网段  --pod-network-cidr=10.244.0.0/16 </span>
<span class="token namespace">[root@kubernetes-master ~]</span> <span class="token comment" spellcheck="true">#   kubectl create -f kube-flannel.yml</span>

<span class="token namespace">[root@kubernetes-master ~]</span> <span class="token comment" spellcheck="true">#  kubectl get all -n kube-system</span>
<span class="token operator">--</span>全部为1 

<span class="token namespace">[root@kubernetes-master ~]</span> <span class="token comment" spellcheck="true"># kubectl get node</span>
NAME                STATUS     ROLES    AGE   VERSION
kubernetes<span class="token operator">-</span>master   Ready      master   13m   v1<span class="token punctuation">.</span>18<span class="token punctuation">.</span>3
kubernetes<span class="token operator">-</span>node1    NotReady   &lt;none>   12m   v1<span class="token punctuation">.</span>18<span class="token punctuation">.</span>3



docker pull quay<span class="token punctuation">.</span>io<span class="token operator">/</span>coreos<span class="token operator">/</span>flannel:v0<span class="token punctuation">.</span>12<span class="token punctuation">.</span>0<span class="token operator">-</span>amd64
<span class="token namespace">[root@kubernetes-master ~]</span> <span class="token comment" spellcheck="true"># docker load  -i  docker_k8s_flannel.tar.gz </span>
两个节点都上传这个镜像
<span class="token namespace">[root@kubernetes-master ~]</span> <span class="token comment" spellcheck="true"># kubectl  get nodes </span>
NAME                STATUS   ROLES    AGE   VERSION
kubernetes<span class="token operator">-</span>master   Ready    master   79m   v1<span class="token punctuation">.</span>18<span class="token punctuation">.</span>3
kubernetes<span class="token operator">-</span>node1    Ready    &lt;none>   78m   v1<span class="token punctuation">.</span>18<span class="token punctuation">.</span>3


测试    Deployment   不会写看系统的怎么写 


<span class="token namespace">[root@kubernetes-master ~]</span> <span class="token comment" spellcheck="true"># vim nginx_k8s_1.80.yaml </span>
apiVersion: apps<span class="token operator">/</span>v1
kind: Deployment
metadata:
  name: nginx
spec:
  selector:
    matchLabels: 
      app: nginx
  replicas: 3
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
    <span class="token function">type</span>: RollingUpdate
  minReadySeconds: 30
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      <span class="token operator">-</span> name: nginx
        image: nginx:1<span class="token punctuation">.</span>13
        ports:
        <span class="token operator">-</span> containerPort: 80
        resources:
          limits:
            cpu: 100m
          requests:
            cpu: 100m
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="补全健"><a href="#补全健" class="headerlink" title="补全健"></a>补全健</h3><pre><code>source &lt;(kubectl completion bash)
echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc</code></pre><pre><code>更多参考
https://oldqiang.com/archives/624.html
</code></pre><h3 id="6-为k8s集群配置dashboard服务"><a href="#6-为k8s集群配置dashboard服务" class="headerlink" title="6:为k8s集群配置dashboard服务"></a>6:为k8s集群配置dashboard服务</h3>
            </div>
            <hr />

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">写作不易，客官能否打赏一杯奶茶？</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《03-k8s集群的安装》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/2020/06/05/03-docker-ji-chu-cao-zuo-copy/" property="cc:attributionName"
               rel="cc:attributionURL">
                小明
            </a> 采用
            <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    
    <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '',
        clientSecret: '',
        repo: 'godweiyang.github.io',
        owner: 'godweiyang',
        admin: "godweiyang",
        id: '2020/06/05/03-docker-ji-chu-cao-zuo-copy/',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    
    <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script> -->

<script>
    new Valine({
        el: '#vcomments',
        appId: '',
        appKey: '',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'false' === 'true',
        avatar: 'wavatar',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '如果你没有GitHub账号，还可以在这里评论啦！'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-dot-circle-o"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/2020/06/05/03-docker-ji-chu-cao-zuo-copy/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/29.jpg" class="responsive-img" alt="03-k8s集群的安装">
                        
                        <span class="card-title">03-k8s集群的安装</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            1:k8s集群的安装1.1 k8s的架构通常我们都是通过 kubectl 对 Kubernetes 下命令的，它通过 APIServer 去调用各个进程来完成对 Node 的部署和控制。

APIServer 的核心功能是对核心对象（例如：
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-06-05
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/k8s/" class="post-category" target="_blank">
                                    k8s
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/leetcode/" target="_blank">
                        <span class="chip bg-color">leetcode</span>
                    </a>
                    
                    <a href="/tags/云计算/" target="_blank">
                        <span class="chip bg-color">云计算</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/05/27/02-docker-ji-chu-cao-zuo/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/2.jpg" class="responsive-img" alt="02-docker基础操作">
                        
                        <span class="card-title">02-docker基础操作</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            1.什么是容器
容器是隔离的环境中运行的一个进程,如果进程结束,容器就会停止,容器的隔离环境,拥有自己的ip地址,系统文件,主机名,进程管理


程序: 代码,软件,命令
进程:正在运行的程序

2:容器和虚拟机的区别虚拟机: 硬件cpu支
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-05-27
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/docker/" class="post-category" target="_blank">
                                    docker
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/leetcode/" target="_blank">
                        <span class="chip bg-color">leetcode</span>
                    </a>
                    
                    <a href="/tags/云计算/" target="_blank">
                        <span class="chip bg-color">云计算</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('5')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 小明同学<br />'
            + '作者: 小明<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
    });
</script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>

<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>


    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            &copy; 2019-2020 小明. 版权所有

            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
            <span class="white-color">103.1k</span>
            

            <br>
            <span id="sitetime"></span>

            
            
            <br>
            
            <span id="busuanzi_container_site_pv" style='display:none'>
                <i class="fa fa-heart-o"></i>
                本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
            <span id="busuanzi_container_site_uv" style='display:none'>
                人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
            </span>
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/xiaoming" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:ye33445200@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="https://zhihu.com/people/xiaoming" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-inverse">知</i>
    </a>



    <a href="http://wpa.qq.com/msgrd?v=3&uin=970740860&site=qq&menu=yes" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>



    <a href="https://weibo.com/xiaoming" class="tooltipped" target="_blank" data-tooltip="关注我的微博" data-position="top" data-delay="50">
        <i class="fa fa-weibo"></i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 不蒜子计数初始值纠正 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);
        var pvcountOffset = 80000;
        var uvcountOffset = 20000;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int);
            }
        }
    });
</script>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2019, 04, 22, 00, 00, 00); //北京时间2020-04-22 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <script type="text/javascript"> var OriginTitile = document.title, st; document.addEventListener("visibilitychange", function () { document.hidden ? (document.title = "Σ(っ °Д °;)っ喔哟，崩溃啦！", clearTimeout(st)) : (document.title = "φ(゜▽゜*)♪咦，又好了！", st = setTimeout(function () { document.title = OriginTitile }, 3e3)) })
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', '');
</script>



    
    <script src="/libs/others/clicklove.js"></script>
    

    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 雪花特效 -->
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":200,"height":400},"mobile":{"show":true},"react":{"opacity":0.7}});</script></body>

</html>