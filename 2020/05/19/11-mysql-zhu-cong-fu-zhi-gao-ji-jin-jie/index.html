<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="11-mysql-主从复制高级进阶, 自然语言处理 深度学习 算法码上来">
    <meta name="baidu-site-verification" content="fmlEuI34ir">
    <meta name="google-site-verification" content="yCy2azpds5XSuGZvis6OuA-XIGF5GuGpYRAaGfD6o48">
    <meta name="360-site-verification" content="b7c11a830ef90fd1464ad6206bb7b6e7">
    <meta name="description" content="1-延时从库1-介绍
普通的主从复制，处理物理故障损坏比较擅长。
如果主库出现了DROP DATABASE操作。
延时从库： 主库做了某项操作之后，从库延时多长时间回放（SQL）。可以处理逻辑损坏。
2-配置mysql&gt;stop slave">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>11-mysql-主从复制高级进阶 | 小明同学</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?46e79e71af0709a5b9106bf20cecc493";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

    
        <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
        </script>
    

    <script>
        (function(){
        var src = "https://jspassport.ssl.qhimg.com/11.0.1.js?d182b3f28525f2db83acfaaf6e696dba";
        document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">小明同学</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <i class="fa fa-comments"></i>
            
            <span>留言板</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">小明同学</div>
        <div class="logo-desc">
            
            计算机科学与技术 | 自然语言处理
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-comments"></i>
                
                留言板
            </a>
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/3.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        11-mysql-主从复制高级进阶
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                        <a href="/tags/leetcode/" target="_blank">
                            <span class="chip bg-color">leetcode</span>
                        </a>
                        
                        <a href="/tags/mysql/" target="_blank">
                            <span class="chip bg-color">mysql</span>
                        </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                        <a href="/categories/mysql/" class="post-category" target="_blank">
                            mysql
                        </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-05-19
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                    小明
                    
                </div>

                
                
                <div class="info-break-policy">
                    <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                    5.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    26 分
                </div>
                
                

                
                <div id="busuanzi_container_page_pv" class="info-break-policy">
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv"></span>
                </div>
                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="1-延时从库"><a href="#1-延时从库" class="headerlink" title="1-延时从库"></a>1-延时从库</h1><h2 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1-介绍"></a>1-介绍</h2><p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/QQ%E5%9B%BE%E7%89%8720200515154534-1590764844473.png" alt="QQ图片20200515154534"></p>
<pre class="line-numbers language-powershell"><code class="language-powershell">普通的主从复制，处理物理故障损坏比较擅长。
如果主库出现了DROP DATABASE操作。
延时从库： 主库做了某项操作之后，从库延时多长时间回放（SQL）。可以处理逻辑损坏。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="2-配置"><a href="#2-配置" class="headerlink" title="2-配置"></a>2-配置</h2><pre class="line-numbers language-mysql"><code class="language-mysql">mysql>stop slave;
mysql>CHANGE MASTER TO MASTER_DELAY = 300;
mysql>start slave;
mysql> show slave status \G
SQL_Delay: 300
SQL_Remaining_Delay: NULL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="3-监控方法"><a href="#3-监控方法" class="headerlink" title="3- 监控方法"></a>3- 监控方法</h2><h3 id="方法一：-有没有延时"><a href="#方法一：-有没有延时" class="headerlink" title="方法一： 有没有延时"></a>方法一： 有没有延时</h3><pre class="line-numbers language-shell"><code class="language-shell">Seconds_Behind_Master: 0
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="方法二：主库："><a href="#方法二：主库：" class="headerlink" title="方法二：主库："></a>方法二：主库：</h3><pre class="line-numbers language-mysql"><code class="language-mysql">mysql> show master status ;
+------------------+----------+--------------+------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+------------------+----------+--------------+------------------+-------------------+
| mysql-bin.000004 |   151847 |              |                  |                   |
+------------------+----------+--------------+------------------+-------------------+
1 row in set (0.00 sec)
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="从库："><a href="#从库：" class="headerlink" title="从库："></a>从库：</h3><pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@db01 data]</span><span class="token comment" spellcheck="true"># mysql -S /tmp/mysql3308.sock -uroot -p123  -e "show slave status \G"|grep "Master_Log"</span>


已经拿到的主库日志量<span class="token punctuation">(</span>master<span class="token punctuation">.</span>info<span class="token punctuation">)</span>：判断传输有没有延时
Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span>000004
Read_Master_Log_Pos: 151847

已经执行的主库日质量<span class="token punctuation">(</span>relay<span class="token operator">-</span>log<span class="token punctuation">.</span>info<span class="token punctuation">)</span>: 判断回放有没有延时
Relay_Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span>000004
Exec_Master_Log_Pos: 141847


计算主从复制延时日志量。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="4-导致延时的主要原因"><a href="#4-导致延时的主要原因" class="headerlink" title="4-导致延时的主要原因"></a>4-导致延时的主要原因</h2><pre class="line-numbers language-powershell"><code class="language-powershell">网络延时  
主从硬件、参数等不一致
从库太多。
主库压力大。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-powershell"><code class="language-powershell">主库 
（1） binlog记录不及时。
mysql> <span class="token function">select</span> @@sync_binlog<span class="token punctuation">;</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span><span class="token operator">+</span>
<span class="token punctuation">|</span> @@sync_binlog <span class="token punctuation">|</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span><span class="token operator">+</span>
<span class="token punctuation">|</span>             1 <span class="token punctuation">|</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span><span class="token operator">+</span>

参数说明： 
       1 ： 每次事务提交都立即刷新binlog到磁盘。 
       0 ： 由操作系统决定，什么刷新磁盘。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="（2）-DUMP线程串行工作。"><a href="#（2）-DUMP线程串行工作。" class="headerlink" title="（2） DUMP线程串行工作。"></a>（2） DUMP线程串行工作。</h3><pre class="line-numbers language-powershell"><code class="language-powershell">大事务、并发事务高、DDL
解决办法： 
    5<span class="token punctuation">.</span>6版本加入GTID复制模式，但手工配置。DUMP在传输日志时可以并发。
    5<span class="token punctuation">.</span>7版本GTID做了增强，不手工开启也自动维护匿名的GTID信息。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="（3）怎么判断是主库导致的延时？"><a href="#（3）怎么判断是主库导致的延时？" class="headerlink" title="（3）怎么判断是主库导致的延时？"></a>（3）怎么判断是主库导致的延时？</h3><pre class="line-numbers language-powershell"><code class="language-powershell">主库： 
mysql> show master status <span class="token punctuation">;</span>
从库： 
mysql <span class="token operator">-</span>S <span class="token operator">/</span>tmp<span class="token operator">/</span>mysql3308<span class="token punctuation">.</span>sock <span class="token operator">-</span>uroot <span class="token operator">-</span>p123  <span class="token operator">-</span>e <span class="token string">"show slave status \G"</span><span class="token punctuation">|</span>grep <span class="token string">"Master_Log"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="从库方面"><a href="#从库方面" class="headerlink" title="从库方面"></a>从库方面</h3><pre class="line-numbers language-powershell"><code class="language-powershell">IO线程： 
从库IO比较慢。relay 落地慢。可以将realy放到 SSD
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="SQL-线程：-串行回放。"><a href="#SQL-线程：-串行回放。" class="headerlink" title="SQL 线程： 串行回放。"></a>SQL 线程： 串行回放。</h4><pre class="line-numbers language-powershell"><code class="language-powershell">主库可以并行事务，从库SQL线程串行回放。
所以：并发事务高、大事务、DDL

解决方法： 
       5<span class="token punctuation">.</span>6 版本： 开启GTID后，可以多SQL线程，只能针对不同的库的事务进行并行SQL恢复。
       5<span class="token punctuation">.</span>7 版本： 做了增强，基于逻辑时钟的并行回放。MTS。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="的从库并发配置方法。开了GTID的前提-前面gutid-后面逻辑时钟"><a href="#的从库并发配置方法。开了GTID的前提-前面gutid-后面逻辑时钟" class="headerlink" title="的从库并发配置方法。开了GTID的前提  前面gutid 后面逻辑时钟"></a>的从库并发配置方法。开了GTID的前提  前面gutid 后面逻辑时钟</h4><pre class="line-numbers language-mysql"><code class="language-mysql">gtid_mode=ON
enforce_gtid_consistency=ON
log_slave_updates=ON
slave-parallel-type=LOGICAL_CLOCK
slave-parallel-workers=16  #线程数量
master_info_repository=TABLE
relay_log_info_repository=TABLE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="已经执行的主库日质量-relay-log-info-判断回放有没有延时"><a href="#已经执行的主库日质量-relay-log-info-判断回放有没有延时" class="headerlink" title="已经执行的主库日质量(relay-log.info): 判断回放有没有延时"></a>已经执行的主库日质量(relay-log.info): 判断回放有没有延时</h3><pre><code>Relay_Master_Log_File: mysql-bin.000004
Exec_Master_Log_Pos: 141847

</code></pre><h2 id="5-延时从库的应用-故障模拟"><a href="#5-延时从库的应用-故障模拟" class="headerlink" title="5-延时从库的应用-故障模拟"></a>5-延时从库的应用-故障模拟</h2><h3 id="1-配置方法："><a href="#1-配置方法：" class="headerlink" title="1-配置方法："></a>1-配置方法：</h3><pre class="line-numbers language-mysql"><code class="language-mysql">mysql>stop slave;
mysql>CHANGE MASTER TO MASTER_DELAY = 300;
·    
change master to master_delay
mysql>start slave;
mysql> show slave status \G
SQL_Delay: 300
SQL_Remaining_Delay: NULL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-恢复思路"><a href="#2-恢复思路" class="headerlink" title="2-恢复思路"></a>2-恢复思路</h3><pre class="line-numbers language-powershell"><code class="language-powershell">1<span class="token punctuation">.</span> 先停业务，挂维护页。    10:10
2<span class="token punctuation">.</span> 停从库SQL线程。
   stop slave sql_thread<span class="token punctuation">;</span>  10:10
   看relay<span class="token punctuation">.</span>info <span class="token operator">--</span>-<span class="token operator">-</span>> 位置点。
   stop slave <span class="token punctuation">;</span>


   <span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>
   主库发生了逻辑损坏（DROP，truncate）时，可以使用延时从库快速恢复数据。


    2小时延时  
    10：00  做的drop database A<span class="token punctuation">;</span>
1<span class="token punctuation">.</span> 及时监控故障： 主库 10:05发现故障，从库此时8:05数据状态
2<span class="token punctuation">.</span> 立即将从库的SQL线程关闭。 需要对A业务挂维护页。
3<span class="token punctuation">.</span> 停止所有线程。
4<span class="token punctuation">.</span> 在延时从。恢复A库数据
   手工模拟SQL线程工作，直到drop之前位置点。
   SQL线程上次执行到的位置<span class="token operator">--</span>-<span class="token operator">--</span><span class="token operator">-</span>》drop之前
   relay<span class="token punctuation">.</span>info   <span class="token operator">--</span>-<span class="token operator">-</span>> 分析drop位置点   <span class="token operator">--</span><span class="token operator">-</span>》 截取relaylog日志<span class="token operator">--</span>-<span class="token operator">-</span>》 source<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-故障模拟及恢复"><a href="#3-故障模拟及恢复" class="headerlink" title="3-故障模拟及恢复"></a>3-故障模拟及恢复</h3><pre class="line-numbers language-powershell"><code class="language-powershell">故障模拟：   主库
create database delaydb charset utf8mb4<span class="token punctuation">;</span>
use delaydb<span class="token punctuation">;</span>
create table t1<span class="token punctuation">(</span>id int<span class="token punctuation">)</span><span class="token punctuation">;</span>
insert into t1 values<span class="token punctuation">(</span>1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>3<span class="token punctuation">)</span><span class="token punctuation">;</span>
commit<span class="token punctuation">;</span>

drop database delaydb<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-恢复过程："><a href="#4-恢复过程：" class="headerlink" title="4-恢复过程："></a>4-恢复过程：</h3><p>==查看 日志是否接收完毕== </p>
<pre><code>1. 
从库：  stop slave sql_thread;
</code></pre><h4 id="2-截取日志："><a href="#2-截取日志：" class="headerlink" title="2-截取日志："></a>2-截取日志：</h4><pre class="line-numbers language-scheme"><code class="language-scheme">>show relaylog   events in <span class="token string">"db01-relay-bin.000002"</span><span class="token comment" spellcheck="true">;   </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-powershell"><code class="language-powershell">起点: SQL上次执行到的位置点，
Relay_Log_File: db01<span class="token operator">-</span>relay<span class="token operator">-</span>bin<span class="token punctuation">.</span>000004
Relay_Log_Pos: 320


终点： drop 之前 
>show relaylog   events in <span class="token string">"db01-relay-bin.000002"</span><span class="token punctuation">;</span>    


db01<span class="token operator">-</span>relay<span class="token operator">-</span>bin<span class="token punctuation">.</span>000004 <span class="token punctuation">|</span> 1006 <span class="token punctuation">|</span> Query          <span class="token punctuation">|</span>         7 <span class="token punctuation">|</span>      152967 <span class="token punctuation">|</span> drop databas<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-shell"><code class="language-shell">[root@db01 tmp]# mysqlbinlog --start-position=320 --stop-position=1006 /data/3309/data/db01-relay-bin.000004 >/tmp/bin.sql
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="3-从库恢复"><a href="#3-从库恢复" class="headerlink" title="3-从库恢复"></a>3-从库恢复</h4><pre class="line-numbers language-powershell"><code class="language-powershell">mysql> reset slave all<span class="token punctuation">;</span>
mysql> <span class="token function">set</span> sql_log_bin=0<span class="token punctuation">;</span>
mysql> source <span class="token operator">/</span>tmp<span class="token operator">/</span>bin<span class="token punctuation">.</span>sql<span class="token punctuation">;</span>
mysql> <span class="token function">set</span> sql_log_bin=1<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-powershell"><code class="language-powershell">mysql> show  tables<span class="token punctuation">;</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>
<span class="token punctuation">|</span> Tables_in_delaydb <span class="token punctuation">|</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>
<span class="token punctuation">|</span> t1                <span class="token punctuation">|</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>
1 row in <span class="token function">set</span> <span class="token punctuation">(</span>0<span class="token punctuation">.</span>00 sec<span class="token punctuation">)</span>

mysql> <span class="token function">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1<span class="token punctuation">;</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span><span class="token operator">+</span>
<span class="token punctuation">|</span> id   <span class="token punctuation">|</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span><span class="token operator">+</span>
<span class="token punctuation">|</span>    1 <span class="token punctuation">|</span>
<span class="token punctuation">|</span>    2 <span class="token punctuation">|</span>
<span class="token punctuation">|</span>    3 <span class="token punctuation">|</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span><span class="token operator">+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="2-过滤复制"><a href="#2-过滤复制" class="headerlink" title="2-过滤复制"></a>2-过滤复制</h1><h2 id="1-配置方法"><a href="#1-配置方法" class="headerlink" title="1-配置方法"></a>1-配置方法</h2><pre class="line-numbers language-powershell"><code class="language-powershell">主库： 
白名单: 
binlog_do_db=world
黑名单： 
binlog_ignore_db 

从库：
库级别： 
replicate_do_db=world  
replicate_ignore_db=xxxx 

表级别：
replicate_do_table=world<span class="token punctuation">.</span>t1
replicate_ignore_table=

表级别： 模糊匹配
replicate_wild_do_table=world<span class="token punctuation">.</span>t<span class="token operator">*</span>  模糊 表
replicate_wild_ignore_table=

例子：  只复制oldboy和oldguo库的数据到3309
vim <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>3309<span class="token operator">/</span>my<span class="token punctuation">.</span>cnf
replicate_do_db=oldguo
replicate_do_db=oldboy
<span class="token namespace">[root@db01 ~]</span><span class="token comment" spellcheck="true"># systemctl restart mysqld3309</span>

mysql> show slave status\G
Replicate_Do_DB: oldguo<span class="token punctuation">,</span>oldboy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-方法一："><a href="#2-方法一：" class="headerlink" title="2-方法一："></a>2-方法一：</h2><pre class="line-numbers language-powershell"><code class="language-powershell">修改配置文件并重启
vim <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>3308<span class="token operator">/</span>my<span class="token punctuation">.</span>cnf 
replicate_do_db=world
replicate_do_db=oldboy

systemctl restart mysqld3308<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="3-方法二："><a href="#3-方法二：" class="headerlink" title="3-方法二："></a>3-方法二：</h2><pre class="line-numbers language-csharp"><code class="language-csharp">db01_5<span class="token number">.7</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">></span>help change<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-mysql"><code class="language-mysql">STOP SLAVE SQL_THREAD;
CHANGE REPLICATION FILTER REPLICATE_DO_DB = (oldguo, oldboy);
START  SLAVE SQL_THREAD;
-------
stop slave sql_thread;
change replication filter replicate_do_db = (oldguo, oldboy);
start  slave sql_thread;

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="3-半同步复制"><a href="#3-半同步复制" class="headerlink" title="3-半同步复制"></a>3-半同步复制</h1><pre class="line-numbers language-powershell"><code class="language-powershell">在 Classic replication : 
    传统异步非GTID复制工作模型下，会导致主从数据不一致情况。
5<span class="token punctuation">.</span>5 版本为了保证主从数据的一致性问题。加入了半同步复制的组件（插件）    
在主从结构中，都加入了半同步复制的插件。
控制从库IO是否将relaylog落盘，一旦落盘通过插件返回ACK给主库ACK_rec。接受到ACK之后，主库的事务才能
提交成功。在默认情况下，如果超过10秒没有返回ACK，此次复制行为会切换为异步复制。
在 5<span class="token punctuation">.</span>6 ，5<span class="token punctuation">.</span>7当中也加入了一些比较好的特性（After commit ， after sync ，无损<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>），
也不能完全保证5个9以上的数据一致。

如果生产业务比较关注主从最终一致（金融类）。我们推荐可以使用MGR的架构，或者PXC等一致性架构。 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="4-GTID复制"><a href="#4-GTID复制" class="headerlink" title="4-GTID复制"></a>4-GTID复制</h1><pre class="line-numbers language-powershell"><code class="language-powershell">作用： 主要保证主从复制中的高级的特性。
GTID：5<span class="token punctuation">.</span>6 版本出现没有默认开启，5<span class="token punctuation">.</span>7 中即使不开启也有匿名的GTID记录。
      DUMP传输可以并性，SQL线程并发回放提供了。5<span class="token punctuation">.</span>7<span class="token punctuation">.</span>17<span class="token operator">+</span>的版本以后几乎都是GTID模式了。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="1-搭建GTID："><a href="#1-搭建GTID：" class="headerlink" title="1-搭建GTID："></a>1-搭建GTID：</h2><pre class="line-numbers language-powershell"><code class="language-powershell">准备三台虚拟机
    IP：      51 52 53   
    hostname: db01  db02 db03
    防火墙关闭
    能够实现远程xshell链接<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="1-清理环境"><a href="#1-清理环境" class="headerlink" title="1-清理环境"></a>1-清理环境</h3><pre class="line-numbers language-powershell"><code class="language-powershell">pkill mysqld
<span class="token function">rm</span> <span class="token operator">-</span>rf <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mysql<span class="token operator">/</span><span class="token keyword">data</span>/<span class="token operator">*</span> 
<span class="token function">rm</span> <span class="token operator">-</span>rf <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>binlog/<span class="token operator">*</span> 
mkdir <span class="token operator">-</span>p <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mysql<span class="token operator">/</span><span class="token keyword">data</span> <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>binlog 


chown <span class="token operator">-</span>R mysql<span class="token punctuation">.</span>mysql <span class="token operator">/</span><span class="token keyword">data</span>/<span class="token operator">*</span>  

2<span class="token punctuation">.</span> 清理环境<span class="token punctuation">(</span>三个节点都做<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-生成配置文件"><a href="#2-生成配置文件" class="headerlink" title="2-生成配置文件"></a>2-生成配置文件</h3><pre class="line-numbers language-powershell"><code class="language-powershell">主库db01：
<span class="token function">mv</span> <span class="token operator">/</span>etc<span class="token operator">/</span>my<span class="token punctuation">.</span>cnf <span class="token operator">/</span>tmp
<span class="token function">cat</span> > <span class="token operator">/</span>etc<span class="token operator">/</span>my<span class="token punctuation">.</span>cnf &lt;&lt;EOF
<span class="token namespace">[mysqld]</span>
basedir=<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>app<span class="token operator">/</span>mysql
datadir=<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mysql<span class="token operator">/</span><span class="token keyword">data</span>
socket=<span class="token operator">/</span>tmp<span class="token operator">/</span>mysql<span class="token punctuation">.</span>sock
server_id=51
port=3306
secure<span class="token operator">-</span>file<span class="token operator">-</span>priv=<span class="token operator">/</span>tmp
autocommit=0
log_bin=<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>binlog<span class="token operator">/</span>mysql<span class="token operator">-</span>bin
binlog_format=row
gtid<span class="token operator">-</span>mode=on
enforce<span class="token operator">-</span>gtid<span class="token operator">-</span>consistency=true
log<span class="token operator">-</span>slave<span class="token operator">-</span>updates=1
<span class="token namespace">[mysql]</span>
prompt=db01 <span class="token punctuation">[</span>\\d<span class="token punctuation">]</span>>
EOF


<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span><span class="token operator">-</span>

slave1<span class="token punctuation">(</span>db02<span class="token punctuation">)</span>：
<span class="token function">mv</span> <span class="token operator">/</span>etc<span class="token operator">/</span>my<span class="token punctuation">.</span>cnf <span class="token operator">/</span>tmp
<span class="token function">cat</span> > <span class="token operator">/</span>etc<span class="token operator">/</span>my<span class="token punctuation">.</span>cnf &lt;&lt;EOF
<span class="token namespace">[mysqld]</span>
basedir=<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>app<span class="token operator">/</span>mysql
datadir=<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mysql<span class="token operator">/</span><span class="token keyword">data</span>
socket=<span class="token operator">/</span>tmp<span class="token operator">/</span>mysql<span class="token punctuation">.</span>sock
server_id=52
port=3306
secure<span class="token operator">-</span>file<span class="token operator">-</span>priv=<span class="token operator">/</span>tmp
autocommit=0
log_bin=<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>binlog<span class="token operator">/</span>mysql<span class="token operator">-</span>bin
binlog_format=row
gtid<span class="token operator">-</span>mode=on
enforce<span class="token operator">-</span>gtid<span class="token operator">-</span>consistency=true
log<span class="token operator">-</span>slave<span class="token operator">-</span>updates=1
<span class="token namespace">[mysql]</span>
prompt=db02 <span class="token punctuation">[</span>\\d<span class="token punctuation">]</span>>
EOF

slave2<span class="token punctuation">(</span>db03<span class="token punctuation">)</span>：
<span class="token function">mv</span> <span class="token operator">/</span>etc<span class="token operator">/</span>my<span class="token punctuation">.</span>cnf <span class="token operator">/</span>tmp
<span class="token function">cat</span> > <span class="token operator">/</span>etc<span class="token operator">/</span>my<span class="token punctuation">.</span>cnf &lt;&lt;EOF
<span class="token namespace">[mysqld]</span>
basedir=<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>app<span class="token operator">/</span>mysql
datadir=<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mysql<span class="token operator">/</span><span class="token keyword">data</span>
socket=<span class="token operator">/</span>tmp<span class="token operator">/</span>mysql<span class="token punctuation">.</span>sock
server_id=53
port=3306
secure<span class="token operator">-</span>file<span class="token operator">-</span>priv=<span class="token operator">/</span>tmp
autocommit=0
log_bin=<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>binlog<span class="token operator">/</span>mysql<span class="token operator">-</span>bin
binlog_format=row
gtid<span class="token operator">-</span>mode=on
enforce<span class="token operator">-</span>gtid<span class="token operator">-</span>consistency=true
log<span class="token operator">-</span>slave<span class="token operator">-</span>updates=1
<span class="token namespace">[mysql]</span>
prompt=db03 <span class="token punctuation">[</span>\\d<span class="token punctuation">]</span>>
EOF<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-初始化数据-三个节点都做"><a href="#3-初始化数据-三个节点都做" class="headerlink" title="3-初始化数据(三个节点都做)"></a>3-初始化数据(三个节点都做)</h3><pre class="line-numbers language-powershell"><code class="language-powershell">mysqld <span class="token operator">--</span>initialize<span class="token operator">-</span>insecure <span class="token operator">--</span>user=mysql <span class="token operator">--</span>basedir=<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>app<span class="token operator">/</span>mysql  <span class="token operator">--</span>datadir=<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mysql<span class="token operator">/</span><span class="token keyword">data</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="4-启动数据库"><a href="#4-启动数据库" class="headerlink" title="4-启动数据库"></a>4-启动数据库</h3><pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token operator">/</span>etc<span class="token operator">/</span>init<span class="token punctuation">.</span>d<span class="token operator">/</span>mysqld <span class="token function">start</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="5-构建主从："><a href="#5-构建主从：" class="headerlink" title="5-构建主从："></a>5-构建主从：</h3><pre class="line-numbers language-powershell"><code class="language-powershell">主库创建用户（db01）
db01 <span class="token namespace">[mysql]</span>>grant replication slave on <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> to repl@<span class="token string">'10.1.0.%'</span> identified by <span class="token string">'123'</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="6-从库开启主从"><a href="#6-从库开启主从" class="headerlink" title="6-从库开启主从"></a>6-从库开启主从</h3><pre class="line-numbers language-powershell"><code class="language-powershell">52\53:

change master to 
master_host=<span class="token string">'10.0.1.51'</span><span class="token punctuation">,</span>
master_user=<span class="token string">'repl'</span><span class="token punctuation">,</span>
master_password=<span class="token string">'123'</span> <span class="token punctuation">,</span>
MASTER_AUTO_POSITION=1<span class="token punctuation">;</span>
<span class="token function">start</span> slave<span class="token punctuation">;</span>

说明：
gtid的主从复制  ，第一次开启的时候，读取relaylog的最后gtid<span class="token operator">+</span>读取gtid_purge参数，确认复制起点。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="5-MHA高可用技术"><a href="#5-MHA高可用技术" class="headerlink" title="5- MHA高可用技术"></a>5- MHA高可用技术</h1><h2 id="数据损坏的类型"><a href="#数据损坏的类型" class="headerlink" title="数据损坏的类型"></a>数据损坏的类型</h2><pre class="line-numbers language-powershell"><code class="language-powershell">物理损坏 ：磁盘、主机、程序、数据文件
逻辑损坏 ：drop <span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="2-高可用解决方案选型依据：-全年无故障率"><a href="#2-高可用解决方案选型依据：-全年无故障率" class="headerlink" title="2. 高可用解决方案选型依据： 全年无故障率"></a>2. 高可用解决方案选型依据： 全年无故障率</h4><hr>
<pre class="line-numbers language-powershell"><code class="language-powershell">无故障时间           故障时间                     解决方案
99<span class="token punctuation">.</span>9<span class="token operator">%</span>                0<span class="token punctuation">.</span>1<span class="token operator">%</span>     = 525<span class="token punctuation">.</span>6  min        KA<span class="token operator">+</span>双主 ：人为干预 
99<span class="token punctuation">.</span>99<span class="token operator">%</span>               0<span class="token punctuation">.</span>01<span class="token operator">%</span>    = 52<span class="token punctuation">.</span>56  min        MHA  ：半自动化  
应用场景：比较适合非金融类互联网公司。 facebook MHA ，淘宝 TMHA  <span class="token operator">--</span>》polardb。 替代产品：  ORCH go语言。
99<span class="token punctuation">.</span>999<span class="token operator">%</span>              0<span class="token punctuation">.</span>001<span class="token operator">%</span>   = 5<span class="token punctuation">.</span>256  min        PXC 、 MGR 、MGC
应用场景： 金融类业务。
99<span class="token punctuation">.</span>9999<span class="token operator">%</span>             0<span class="token punctuation">.</span>0001<span class="token operator">%</span>  = 0<span class="token punctuation">.</span>5256 min        自动化、云化、平台化
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<p> <strong>MHA 软件结构</strong></p>
<hr>
<h2 id="1-manager-组件"><a href="#1-manager-组件" class="headerlink" title="1-manager 组件"></a>1-manager 组件</h2><pre class="line-numbers language-powershell"><code class="language-powershell">masterha_manger             启动MHA 
masterha_check_ssh          检查MHA的SSH配置状况 
masterha_check_repl         检查MySQL复制状况，配置信息
masterha_master_monitor     检测master是否宕机 
masterha_check_status       检测当前MHA运行状态 
masterha_master_switch      控制故障转移（自动或者手动）
masterha_conf_host          添加或删除配置的server信息
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-node-组件"><a href="#2-node-组件" class="headerlink" title="2-node 组件"></a>2-node 组件</h2><pre class="line-numbers language-powershell"><code class="language-powershell">node 组件
save_binary_logs            保存和复制master的二进制日志 
apply_diff_relay_logs       识别差异的中继日志事件并将其差异的事件应用于其他的
purge_relay_logs            清除中继日志（不会阻塞SQL线程）
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="3-MHA基础架构规划和实施"><a href="#3-MHA基础架构规划和实施" class="headerlink" title="3-MHA基础架构规划和实施"></a>3-MHA基础架构规划和实施</h2><h3 id="1-规划"><a href="#1-规划" class="headerlink" title="1-规划:"></a>1-规划:</h3><table>
<thead>
<tr>
<th>主库</th>
<th>10.0.1.51</th>
<th>node</th>
</tr>
</thead>
<tbody><tr>
<td><strong>从库</strong>:</td>
<td><strong>10.0.1.52</strong></td>
<td><strong>node</strong></td>
</tr>
<tr>
<td><strong>从库:_兼  _管理节点</strong></td>
<td>10.0.1.53</td>
<td><strong>node    manager</strong></td>
</tr>
</tbody></table>
<hr>
<hr>
<p>==准备环境（略。1主2从GTID）==</p>
<h3 id="2-配置关键程序软连接（所有节点）"><a href="#2-配置关键程序软连接（所有节点）" class="headerlink" title="2.配置关键程序软连接（所有节点）"></a>2.配置关键程序软连接（所有节点）</h3><pre class="line-numbers language-powershell"><code class="language-powershell">ln <span class="token operator">-</span>s <span class="token operator">/</span>app<span class="token operator">/</span>database<span class="token operator">/</span>mysql<span class="token operator">/</span>bin<span class="token operator">/</span>mysqlbinlog    <span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>mysqlbinlog
ln <span class="token operator">-</span>s <span class="token operator">/</span>app<span class="token operator">/</span>database<span class="token operator">/</span>mysql<span class="token operator">/</span>bin<span class="token operator">/</span>mysql          <span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>mysql

软件写死了必须做软链接<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-配置各节点互信（密钥对）"><a href="#3-配置各节点互信（密钥对）" class="headerlink" title="3- 配置各节点互信（密钥对）"></a>3- 配置各节点互信（密钥对）</h3><pre class="line-numbers language-powershell"><code class="language-powershell">db01：
<span class="token function">rm</span> <span class="token operator">-</span>rf <span class="token operator">/</span>root<span class="token operator">/</span><span class="token punctuation">.</span>ssh 
ssh<span class="token operator">-</span>keygen
cd <span class="token operator">/</span>root<span class="token operator">/</span><span class="token punctuation">.</span>ssh 
<span class="token function">mv</span> id_rsa<span class="token punctuation">.</span>pub authorized_keys  <span class="token comment" spellcheck="true">#必须全部互信，自己链接自己也可以通</span>
scp  <span class="token operator">-</span>r  <span class="token operator">/</span>root<span class="token operator">/</span><span class="token punctuation">.</span>ssh  10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>52:<span class="token operator">/</span>root 
scp  <span class="token operator">-</span>r  <span class="token operator">/</span>root<span class="token operator">/</span><span class="token punctuation">.</span>ssh  10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>53:<span class="token operator">/</span>root 
各节点验证
db01:
ssh 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>51 date
ssh 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>52 date
ssh 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>53 date
db02:
ssh 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>51 date
ssh 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>52 date
ssh 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>53 date
db03:
ssh 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>51 date
ssh 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>52 date
ssh 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>53 date<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-安装软件"><a href="#4-安装软件" class="headerlink" title="4-安装软件"></a>4-安装软件</h3><pre class="line-numbers language-powershell"><code class="language-powershell">下载mha软件
mha官网：https:<span class="token operator">/</span><span class="token operator">/</span>code<span class="token punctuation">.</span>google<span class="token punctuation">.</span>com<span class="token operator">/</span>archive<span class="token operator">/</span>p<span class="token operator">/</span>mysql<span class="token operator">-</span>master<span class="token operator">-</span>ha<span class="token operator">/</span>
github下载地址：https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>yoshinorim<span class="token operator">/</span>mha4mysql<span class="token operator">-</span>manager<span class="token operator">/</span>wiki<span class="token operator">/</span>Downloads


<span class="token comment" spellcheck="true"># 说明： </span>
8<span class="token punctuation">.</span>0 的版本: 
1<span class="token punctuation">.</span> 密码加密模式 sha2  <span class="token operator">--</span><span class="token operator">-</span>> native 
2<span class="token punctuation">.</span> 使用0<span class="token punctuation">.</span>58 版本MHA软件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="所有节点安装Node软件依赖包"><a href="#所有节点安装Node软件依赖包" class="headerlink" title="所有节点安装Node软件依赖包"></a>所有节点安装Node软件依赖包</h5><pre class="line-numbers language-powershell"><code class="language-powershell">yum install perl<span class="token operator">-</span>DBD<span class="token operator">-</span>MySQL <span class="token operator">-</span>y
rpm <span class="token operator">-</span>ivh mha4mysql<span class="token operator">-</span>node<span class="token operator">-</span>0<span class="token punctuation">.</span>56<span class="token operator">-</span>0<span class="token punctuation">.</span>el6<span class="token punctuation">.</span>noarch<span class="token punctuation">.</span>rpm
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="在db01主库中创建mha需要的用户"><a href="#在db01主库中创建mha需要的用户" class="headerlink" title="在db01主库中创建mha需要的用户"></a>在db01主库中创建mha需要的用户</h4><pre class="line-numbers language-powershell"><code class="language-powershell">grant all privileges on <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> to mha@<span class="token string">'10.0.1.%'</span> identified by <span class="token string">'mha'</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="Manager软件安装（db03）"><a href="#Manager软件安装（db03）" class="headerlink" title="Manager软件安装（db03）"></a>Manager软件安装（db03）</h4><pre class="line-numbers language-powershell"><code class="language-powershell">yum install <span class="token operator">-</span>y perl<span class="token operator">-</span>Config<span class="token operator">-</span>Tiny epel<span class="token operator">-</span>release perl<span class="token operator">-</span>Log<span class="token operator">-</span>Dispatch perl<span class="token operator">-</span><span class="token keyword">Parallel</span><span class="token operator">-</span>ForkManager perl<span class="token operator">-</span>Time<span class="token operator">-</span>HiRes
rpm <span class="token operator">-</span>ivh mha4mysql<span class="token operator">-</span>manager<span class="token operator">-</span>0<span class="token punctuation">.</span>56<span class="token operator">-</span>0<span class="token punctuation">.</span>el6<span class="token punctuation">.</span>noarch<span class="token punctuation">.</span>rpm
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="Manager配置文件准备-db03"><a href="#Manager配置文件准备-db03" class="headerlink" title="Manager配置文件准备(db03)"></a>Manager配置文件准备(db03)</h4><pre class="line-numbers language-powershell"><code class="language-powershell">mkdir <span class="token operator">-</span>p <span class="token operator">/</span>etc<span class="token operator">/</span>mha
<span class="token comment" spellcheck="true">#创建日志目录</span>
 mkdir <span class="token operator">-</span>p <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>mha<span class="token operator">/</span>app1
<span class="token comment" spellcheck="true">#编辑mha配置文件</span>
<span class="token function">cat</span> > <span class="token operator">/</span>etc<span class="token operator">/</span>mha<span class="token operator">/</span>app1<span class="token punctuation">.</span>cnf &lt;&lt;EOF
<span class="token namespace">[server default]</span>
manager_log=<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>mha<span class="token operator">/</span>app1<span class="token operator">/</span>manager         <span class="token comment" spellcheck="true"># MHA的工作日志设置</span>
manager_workdir=<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>mha<span class="token operator">/</span>app1             <span class="token comment" spellcheck="true"># MHA工作目录        </span>
master_binlog_dir=<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>binlog                <span class="token comment" spellcheck="true"># 主库的binlog目录</span>
user=mha                                      <span class="token comment" spellcheck="true"># 监控用户                      </span>
password=mha                                  <span class="token comment" spellcheck="true"># 监控密码</span>
ping_interval=2                               <span class="token comment" spellcheck="true"># 心跳检测的间隔时间</span>
repl_password=123                             <span class="token comment" spellcheck="true"># 复制用户</span>
repl_user=repl                                <span class="token comment" spellcheck="true"># 复制密码</span>
ssh_user=root                                 <span class="token comment" spellcheck="true"># ssh互信的用户</span>
<span class="token namespace">[server1]</span>                                     <span class="token comment" spellcheck="true"># 节点信息....</span>
hostname=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>51
port=3306  

<span class="token namespace">[server2]</span>            
hostname=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>52
port=3306
candidate_master=1


<span class="token namespace">[server3]</span>
no_master=1
hostname=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>53
port=3306
EOF<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="状态检查（db03）"><a href="#状态检查（db03）" class="headerlink" title="状态检查（db03）"></a>状态检查（db03）</h4><pre class="line-numbers language-c#"><code class="language-c#">masterha_check_repl  --conf=/etc/mha/app1.cnf 
masterha_check_ssh   --conf=/etc/mha/app1.cnf <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<hr>
<pre class="line-numbers language-powershell"><code class="language-powershell">-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span>
masterha_check_ssh   <span class="token operator">--</span>conf=<span class="token operator">/</span>etc<span class="token operator">/</span>mha<span class="token operator">/</span>app1<span class="token punctuation">.</span>cnf 
<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>

Mon May 18 12:45:26 2020 <span class="token operator">-</span> <span class="token namespace">[debug]</span>   ok<span class="token punctuation">.</span>
Mon May 18 12:45:27 2020 <span class="token operator">-</span> <span class="token namespace">[info]</span> All SSH connection tests passed successfully<span class="token punctuation">.</span>
<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span><span class="token operator">-</span>
masterha_check_repl  <span class="token operator">--</span>conf=<span class="token operator">/</span>etc<span class="token operator">/</span>mha<span class="token operator">/</span>app1<span class="token punctuation">.</span>cnf 
<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>
 <span class="token operator">+</span>-<span class="token operator">-</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">.</span>62<span class="token punctuation">(</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">.</span>62:3306<span class="token punctuation">)</span>
 <span class="token operator">+</span>-<span class="token operator">-</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">.</span>63<span class="token punctuation">(</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">.</span>63:3306<span class="token punctuation">)</span>

Mon May 18 12:45:58 2020 <span class="token operator">-</span> <span class="token namespace">[info]</span> Checking replication health on 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">.</span>62<span class="token punctuation">.</span><span class="token punctuation">.</span>
Mon May 18 12:45:58 2020 <span class="token operator">-</span> <span class="token namespace">[info]</span>  ok<span class="token punctuation">.</span>
Mon May 18 12:45:58 2020 <span class="token operator">-</span> <span class="token namespace">[info]</span> Checking replication health on 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">.</span>63<span class="token punctuation">.</span><span class="token punctuation">.</span>
Mon May 18 12:45:58 2020 <span class="token operator">-</span> <span class="token namespace">[info]</span>  ok<span class="token punctuation">.</span>
Mon May 18 12:45:58 2020 <span class="token operator">-</span> <span class="token namespace">[warning]</span> master_ip_failover_script is not defined<span class="token punctuation">.</span>
Mon May 18 12:45:58 2020 <span class="token operator">-</span> <span class="token namespace">[warning]</span> shutdown_script is not defined<span class="token punctuation">.</span>
Mon May 18 12:45:58 2020 <span class="token operator">-</span> <span class="token namespace">[info]</span> Got <span class="token keyword">exit</span> code 0 <span class="token punctuation">(</span>Not master dead<span class="token punctuation">)</span><span class="token punctuation">.</span>

MySQL Replication Health is OK<span class="token punctuation">.</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="5-开启MHA-manager"><a href="#5-开启MHA-manager" class="headerlink" title="5-开启MHA-manager"></a>5-开启MHA-manager</h3><pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token operator">!</span><span class="token namespace">[QQ图片20200518150423]</span><span class="token punctuation">(</span>tup<span class="token operator">/</span>QQ<span class="token operator">%</span>E5<span class="token operator">%</span>9B<span class="token operator">%</span>BE<span class="token operator">%</span>E7<span class="token operator">%</span>89<span class="token operator">%</span>8720200518150423<span class="token punctuation">.</span>png<span class="token punctuation">)</span>开启MHA<span class="token punctuation">(</span>db03<span class="token punctuation">)</span>：
nohup masterha_manager <span class="token operator">--</span>conf=<span class="token operator">/</span>etc<span class="token operator">/</span>mha<span class="token operator">/</span>app1<span class="token punctuation">.</span>cnf <span class="token operator">--</span>remove_dead_master_conf <span class="token operator">--</span>ignore_last_failover  &lt; <span class="token operator">/</span>dev<span class="token operator">/</span>null> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>mha<span class="token operator">/</span>app1<span class="token operator">/</span>manager<span class="token punctuation">.</span>log 2>&amp;1 &amp;

3<span class="token punctuation">.</span>3<span class="token punctuation">.</span>8 查看MHA状态
<span class="token namespace">[root@db03 ~]</span><span class="token comment" spellcheck="true"># masterha_check_status --conf=/etc/mha/app1.cnf</span>
app1 <span class="token punctuation">(</span>pid:4719<span class="token punctuation">)</span> is running<span class="token punctuation">(</span>0:PING_OK<span class="token punctuation">)</span><span class="token punctuation">,</span> master:10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>51
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="4-MHA工作原理"><a href="#4-MHA工作原理" class="headerlink" title="4-MHA工作原理"></a>4-MHA工作原理</h2><p><img src="G:/%E5%B0%8F%E6%98%8E%E5%90%8C%E5%AD%A6%E4%BD%9C%E4%B8%9A%E8%A1%A8/%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0%E6%96%87%E4%BB%B6.md/05-mysql%E6%95%B0%E6%8D%AE%E5%BA%93/tup/QQ%E5%9B%BE%E7%89%8720200518150423-1590764844474.png" alt="QQ图片20200518150423"></p>
<h3 id="1-MHA的设计原理"><a href="#1-MHA的设计原理" class="headerlink" title="1-MHA的设计原理"></a>1-MHA的设计原理</h3><pre class="line-numbers language-powershell"><code class="language-powershell"> MHA的设计原理（Failover 过程）

<span class="token comment" spellcheck="true"># 1. 启动MHA 软件 </span>
nohup masterha_manager <span class="token operator">--</span>conf=<span class="token operator">/</span>etc<span class="token operator">/</span>mha<span class="token operator">/</span>app1<span class="token punctuation">.</span>cnf <span class="token operator">--</span>remove_dead_master_conf <span class="token operator">--</span>ignore_last_failover  &lt; <span class="token operator">/</span>dev<span class="token operator">/</span>null> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>mha<span class="token operator">/</span>app1<span class="token operator">/</span>manager<span class="token punctuation">.</span>log 2>&amp;1 &amp;

<span class="token comment" spellcheck="true"># 2. 监控  </span>
<span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>masterha_master_monitor ，每隔ping_interval秒探测1次，连续4次还没有，说明主库宕机。

<span class="token comment" spellcheck="true"># 3. 选新主</span>
3<span class="token punctuation">.</span>1 日志量 latest 

3<span class="token punctuation">.</span>2 备选主 pref

3<span class="token punctuation">.</span>3 哪些不被选主 bad
no_master=1
log_bin 二进制日志没开
check_slave_delay，如果从库落后主库100M的日志量（可以关闭）
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code>数组： 
alive   : 存活
latest  ：最新
pref    ：备选
bad     ：不选</code></pre><h3 id="2-选主判断："><a href="#2-选主判断：" class="headerlink" title="2-选主判断："></a>2-选主判断：</h3><pre class="line-numbers language-powershell"><code class="language-powershell">伪代码：
<span class="token keyword">if</span> 情况
=1<span class="token punctuation">.</span> 如果pref和bad数组当中slave的个数为0，则选择latest数组当中的第一个slave为master。
db02没有candidate_master，又没有以下bad三种情况，db02恰好是latest。

=2<span class="token punctuation">.</span> 循环对比latest数组和perf数组的slave，如果存在相同的slave，并且这个slave不在bad数组当中，该slave会被推选为新的master。
db02 pref <span class="token punctuation">,</span> latest  <span class="token punctuation">,</span>又不是bad，会被选主。


=3<span class="token punctuation">.</span> 循环对比slaves数组pref数组当中的slave，如果有一个slave相同并且不在bad数组当中，该就会成为新的master。
db02 <span class="token punctuation">,</span>不是latest<span class="token punctuation">,</span>不是bad<span class="token punctuation">,</span>是pref。会被选择。


=4<span class="token punctuation">.</span> 循环latest数组，如果又循环到的slave不在bad数组当中，这个slave就会成为master。
    也就是说就算添加了candidate_master=1，该slave也不一定会成为主库。

    db02 <span class="token punctuation">,</span> latest  <span class="token punctuation">,</span>不是bad 
    db03 <span class="token punctuation">,</span> pref<span class="token punctuation">,</span>不是latest <span class="token punctuation">,</span>不是bad 

=5<span class="token punctuation">.</span> 从活着的slave当中进行循环，如果循环到的slave不在bad数组当中，那么这个slave就会成为主库。    
    db02 ，slaves <span class="token punctuation">,</span>不是bad 。

<span class="token keyword">else</span> 如果进行了多次选择都找不到主库，那么主库选择失败，failover失败。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-数据补偿-："><a href="#3-数据补偿-：" class="headerlink" title="3-数据补偿 ："></a>3-数据补偿 ：</h3><pre class="line-numbers language-powershell"><code class="language-powershell">4<span class="token punctuation">.</span>1 原主库ssh能连接 
    各个从节点调用： save_binary_logs 脚本，立即保存缺失部分的binlog到各自节点<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>tmp目录。
4<span class="token punctuation">.</span>2 原主库ssh不能连接 
    从节点调用apply_diff_relay_logs  ，进行relay<span class="token operator">-</span>log日志差异补偿。

4<span class="token punctuation">.</span>3<span class="token punctuation">.</span> 额外数据补偿<span class="token punctuation">(</span>主库日志冗余机制<span class="token punctuation">)</span>
     binlog_server<span class="token punctuation">.</span>

5<span class="token punctuation">.</span> 切换 
   所有从库解除主从身份。stop slave <span class="token punctuation">;</span> reset slave<span class="token punctuation">;</span>
   重构新的主从关系。change master to 

6<span class="token punctuation">.</span> 应用透明<span class="token punctuation">(</span>vip<span class="token punctuation">)</span>

7<span class="token punctuation">.</span> 故障提醒

8<span class="token punctuation">.</span> 额外数据补偿


9<span class="token punctuation">.</span> 剔除故障节点

10<span class="token punctuation">.</span> manager 程序<span class="token string">"自杀"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="5-应用透明vip功能"><a href="#5-应用透明vip功能" class="headerlink" title="5-应用透明vip功能"></a>5-应用透明vip功能</h2><pre class="line-numbers language-powershell"><code class="language-powershell">5<span class="token punctuation">.</span>0 vip 介绍 
<span class="token comment" spellcheck="true">#作用网卡：</span>
eth0:1 
ens33:1
<span class="token comment" spellcheck="true"># IP</span>
vip :   10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>55<span class="token operator">/</span>24
一定是一个空闲地址。
一定要和对外提供服务的地址同一网段。
不能跨网段。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="5-1-vip-故障转移脚本"><a href="#5-1-vip-故障转移脚本" class="headerlink" title="5.1 vip 故障转移脚本"></a>5.1 vip 故障转移脚本</h3><pre class="line-numbers language-powershell"><code class="language-powershell">脚本——是故障转移切换脚本

上传脚本文件到<span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin 
<span class="token namespace">[root@db03 mha_script]</span><span class="token comment" spellcheck="true"># \cp -a * /usr/local/bin</span>

5<span class="token punctuation">.</span>2 修改权限 
<span class="token namespace">[root@db03 bin]</span><span class="token comment" spellcheck="true"># chmod +x /usr/local/bin/*</span>

5<span class="token punctuation">.</span>3 修改内容
<span class="token namespace">[root@db03 bin]</span><span class="token comment" spellcheck="true">#vim  /usr/local/bin/master_ip_failover</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>需要修改ip已经网卡</p>
<pre class="line-numbers language-shell"><code class="language-shell">my $vip = '10.0.0.55/24';
my $key = '1';
my $if  = 'ens33';
my $ssh_start_vip = "/sbin/ifconfig $if:$key $vip";
my $ssh_stop_vip = "/sbin/ifconfig  $if:$key down";
my $ssh_Bcast_arp= "/sbin/arping -I $if -c 3 -A 10.0.0.55";
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="5-2-修改Manager-配置文件"><a href="#5-2-修改Manager-配置文件" class="headerlink" title="5.2 修改Manager 配置文件"></a>5.2 修改Manager 配置文件</h3><pre class="line-numbers language-powershell"><code class="language-powershell">vim <span class="token operator">/</span>etc<span class="token operator">/</span>mha<span class="token operator">/</span>app1<span class="token punctuation">.</span>cnf 

master_ip_failover_script=<span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin<span class="token operator">/</span>master_ip_failover
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="5-3-主库上，手工生成第一个vip地址"><a href="#5-3-主库上，手工生成第一个vip地址" class="headerlink" title="5.3-主库上，手工生成第一个vip地址"></a>5.3-主库上，手工生成第一个vip地址</h3><pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@db02 ~]</span><span class="token comment" spellcheck="true"># ifconfig eth0:1 10.0.0.55/24</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="6-故障提醒功能"><a href="#6-故障提醒功能" class="headerlink" title="6.故障提醒功能"></a>6.故障提醒功能</h2><h3 id="6-1-准备脚本"><a href="#6-1-准备脚本" class="headerlink" title="6.1 准备脚本"></a>6.1 准备脚本</h3><pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@db03 bin]</span><span class="token comment" spellcheck="true"># vim  send_report </span>
my <span class="token variable">$smtp</span>=<span class="token string">'smtp.qq.com'</span><span class="token punctuation">;</span>             <span class="token comment" spellcheck="true"># smtp服务器</span>
my <span class="token variable">$mail_from</span>=<span class="token string">'22654481@qq.com'</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true"># 发件箱</span>
my <span class="token variable">$mail_user</span>=<span class="token string">'22654481'</span><span class="token punctuation">;</span>           <span class="token comment" spellcheck="true"># 用户名 QQ号</span>
my <span class="token variable">$mail_pass</span>=<span class="token string">'gemghsvgkeyzcagh'</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true"># 授权码</span>
my <span class="token variable">$mail_to</span>=<span class="token punctuation">[</span><span class="token string">'22654481@qq.com'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true"># 收件箱</span>

<span class="token comment" spellcheck="true">#my $mail_to=['to1@qq.com','to2@qq.com']; #多个发送</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="6-2-修改配置文件"><a href="#6-2-修改配置文件" class="headerlink" title="6.2 修改配置文件"></a>6.2 修改配置文件</h3><pre class="line-numbers language-powershell"><code class="language-powershell">vim <span class="token operator">/</span>etc<span class="token operator">/</span>mha<span class="token operator">/</span>app1<span class="token punctuation">.</span>cnf 
<span class="token comment" spellcheck="true"># 添加一行： </span>
report_script=<span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin<span class="token operator">/</span>send_report
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="6-3-重启MHA-db03"><a href="#6-3-重启MHA-db03" class="headerlink" title="6.3 重启MHA(db03)"></a>6.3 重启MHA(db03)</h3><pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@db03 bin]</span><span class="token comment" spellcheck="true"># masterha_stop  --conf=/etc/mha/app1.cnf </span>

<span class="token namespace">[root@db03 bin]</span><span class="token comment" spellcheck="true"># nohup masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover  &lt; /dev/null> /var/log/mha/app1/manager.log 2>&amp;1 &amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="6-4检测状态："><a href="#6-4检测状态：" class="headerlink" title="6.4检测状态："></a>6.4检测状态：</h3><pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@db03 data]</span><span class="token comment" spellcheck="true"># masterha_check_status --conf=/etc/mha/app1.cnf</span>
app1 <span class="token punctuation">(</span>pid:6640<span class="token punctuation">)</span> is running<span class="token punctuation">(</span>0:PING_OK<span class="token punctuation">)</span><span class="token punctuation">,</span> master:10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>51

<span class="token comment" spellcheck="true"># 注意：</span>
keepAlive的话 ，需要 candidate_master=1和check_repl_delay=0进行配合。防止vip和主库选择不在一个节点。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="6-日志补偿的冗余方案–binlog-server"><a href="#6-日志补偿的冗余方案–binlog-server" class="headerlink" title="6-日志补偿的冗余方案–binlog_server"></a>6-日志补偿的冗余方案–binlog_server</h1><h2 id="6-1创建必要目录-db03"><a href="#6-1创建必要目录-db03" class="headerlink" title="6.1创建必要目录(db03)"></a>6.1创建必要目录(db03)</h2><pre class="line-numbers language-powershell"><code class="language-powershell">mkdir <span class="token operator">-</span>p <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>binlog_server<span class="token operator">/</span>

chown <span class="token operator">-</span>R mysql<span class="token punctuation">.</span>mysql <span class="token operator">/</span><span class="token keyword">data</span>/<span class="token operator">*</span>
cd  <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>binlog_server<span class="token operator">/</span>

<span class="token namespace">[root@db03 ~]</span><span class="token comment" spellcheck="true"># mysql -e "show slave status \G"|grep "Master_Log"</span>
mysqlbinlog  <span class="token operator">-</span>R <span class="token operator">--</span>host=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>51 <span class="token operator">--</span>user=mha <span class="token operator">--</span>password=mha <span class="token operator">--</span>raw  <span class="token operator">--</span>stop<span class="token operator">-</span>never mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span>000002 &amp;

cd  <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>binlog_server<span class="token operator">/</span>   <span class="token operator">--</span>-<span class="token operator">--</span>》必须进入到自己创建好的目录<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-powershell"><code class="language-powershell">注意：
拉取日志的起点<span class="token punctuation">,</span>需要按照目前从库的已经获取到的二进制日志点为起点
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="6-2-配置文件设置"><a href="#6-2-配置文件设置" class="headerlink" title="6.2-配置文件设置"></a>6.2-配置文件设置</h2><pre class="line-numbers language-powershell"><code class="language-powershell">vim <span class="token operator">/</span>etc<span class="token operator">/</span>mha<span class="token operator">/</span>app1<span class="token punctuation">.</span>cnf 
<span class="token namespace">[binlog1]</span>
no_master=1
hostname=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>53
master_binlog_dir=<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>binlog_server<span class="token operator">/</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="6-3-重启MHA"><a href="#6-3-重启MHA" class="headerlink" title="6.3 重启MHA"></a>6.3 重启MHA</h2><pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@db03 bin]</span><span class="token comment" spellcheck="true"># masterha_stop  --conf=/etc/mha/app1.cnf </span>
<span class="token namespace">[root@db03 bin]</span><span class="token comment" spellcheck="true"># nohup masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover  &lt; /dev/null> /var/log/mha/app1/manager.log 2>&amp;1 &amp;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="6-4测试MHA-Failover的功能"><a href="#6-4测试MHA-Failover的功能" class="headerlink" title="6.4测试MHA Failover的功能"></a>6.4测试MHA Failover的功能</h2><pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token punctuation">.</span> 测试MHA Failover的功能
<span class="token comment" spellcheck="true"># 宕掉主库测试</span>
测试查看  vip
查看邮件  
故障库是否剔除
切换日志<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>mha<span class="token operator">/</span>app1<span class="token operator">/</span>manager
主从状态<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="7-MHA高可用，故障模拟及恢复演练"><a href="#7-MHA高可用，故障模拟及恢复演练" class="headerlink" title="7. MHA高可用，故障模拟及恢复演练"></a>7. MHA高可用，故障模拟及恢复演练</h1><pre class="line-numbers language-powershell"><code class="language-powershell">主库  <span class="token operator">/</span>etc<span class="token operator">/</span>initd<span class="token operator">/</span>mysql stop <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="1-排查进程状态"><a href="#1-排查进程状态" class="headerlink" title="1. 排查进程状态"></a>1. 排查进程状态</h2><hr>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@db03 bin]</span><span class="token comment" spellcheck="true"># ps -ef |grep manager</span>
root      13087   2813  0 16:33 pts<span class="token operator">/</span>1    00:00:00 grep <span class="token operator">--</span>color=auto manager


<span class="token namespace">[root@db03 bin]</span><span class="token comment" spellcheck="true"># masterha_check_status --conf=/etc/mha/app1.cnf</span>
app1 is stopped<span class="token punctuation">(</span>2:NOT_RUNNING<span class="token punctuation">)</span><span class="token punctuation">.</span>



<span class="token namespace">[root@db03 /data/binlog_server]</span> <span class="token comment" spellcheck="true"># masterha_check_repl --conf=/etc/mha/app1.cnf</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-检查配置文件中节点"><a href="#2-检查配置文件中节点" class="headerlink" title="2. 检查配置文件中节点"></a>2. 检查配置文件中节点</h2><pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@db03 bin]</span><span class="token comment" spellcheck="true"># cat /etc/mha/app1.cnf </span>
如果节点已经被移除，说明切换过程已经大部分成功。
如果节点还在，证明切换过程在中间卡住。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="3-看日志"><a href="#3-看日志" class="headerlink" title="3. 看日志"></a>3. 看日志</h2><pre class="line-numbers language-CQL"><code class="language-CQL">vim /var/log/mha/app1/manager
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="4-修复故障库"><a href="#4-修复故障库" class="headerlink" title="4. 修复故障库"></a>4. 修复故障库</h2><pre><code>[root@db01 ~]# /etc/init.d/mysqld start
Starting MySQL.. SUCCESS! </code></pre><h2 id="5-修复主从（主从是好的，可略过）"><a href="#5-修复主从（主从是好的，可略过）" class="headerlink" title="5. 修复主从（主从是好的，可略过）"></a>5. 修复主从（主从是好的，可略过）</h2><pre class="line-numbers language-powershell"><code class="language-powershell">将故障库修好后，手工加入已有的主从中，作为从库。
change master to 
master_host=<span class="token string">'10.0.1.61'</span><span class="token punctuation">,</span>
master_user=<span class="token string">'repl'</span><span class="token punctuation">,</span>
master_password=<span class="token string">'123'</span> <span class="token punctuation">,</span>
MASTER_AUTO_POSITION=1<span class="token punctuation">;</span>
<span class="token function">start</span> slave<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="6-将配置文件修复（配置文件节点信息还在，可忽略）"><a href="#6-将配置文件修复（配置文件节点信息还在，可忽略）" class="headerlink" title="6. 将配置文件修复（配置文件节点信息还在，可忽略）"></a>6. 将配置文件修复（配置文件节点信息还在，可忽略）</h2><pre><code>添加: 
[server1]
hostname=10.0.0.61
port=3306
</code></pre><h2 id="7-检查ssh互信和repl的主从关系"><a href="#7-检查ssh互信和repl的主从关系" class="headerlink" title="7. 检查ssh互信和repl的主从关系"></a>7. 检查ssh互信和repl的主从关系</h2><pre><code>masterha_check_ssh   --conf=/etc/mha/app1.cnf 
masterha_check_repl  --conf=/etc/mha/app1.cnf 
</code></pre><h2 id="8-修复binlogserver（注意拉去当前主库）"><a href="#8-修复binlogserver（注意拉去当前主库）" class="headerlink" title="8. 修复binlogserver（注意拉去当前主库）"></a>8. 修复binlogserver（注意拉去当前主库）</h2><pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@db03 ~]</span><span class="token comment" spellcheck="true"># cd /data/mysql/binlog/</span>
<span class="token namespace">[root@db03 binlog]</span><span class="token comment" spellcheck="true"># rm -rf *</span>
<span class="token namespace">[root@db03 binlog]</span><span class="token comment" spellcheck="true"># mysqlbinlog  -R --host=10.0.1.61 --user=mha --password=mha --raw  --stop-never mysql-bin.000004 &amp;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="9-检查主节点vip的状态"><a href="#9-检查主节点vip的状态" class="headerlink" title="9.检查主节点vip的状态"></a>9.检查主节点vip的状态</h2><pre><code> 如果不在，再手工生成一下。</code></pre><h2 id="10-启动MHA"><a href="#10-启动MHA" class="headerlink" title="10. 启动MHA"></a>10. 启动MHA</h2><pre class="line-numbers language-powershell"><code class="language-powershell">nohup masterha_manager <span class="token operator">--</span>conf=<span class="token operator">/</span>etc<span class="token operator">/</span>mha<span class="token operator">/</span>app1<span class="token punctuation">.</span>cnf <span class="token operator">--</span>remove_dead_master_conf <span class="token operator">--</span>ignore_last_failover &lt; <span class="token operator">/</span>dev<span class="token operator">/</span>null > <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>mha<span class="token operator">/</span>app1<span class="token operator">/</span>manager<span class="token punctuation">.</span>log 2>&amp;1 &amp;

<span class="token namespace">[root@db03 binlog]</span><span class="token comment" spellcheck="true"># masterha_check_status --conf=/etc/mha/app1.cnf </span>
app1 <span class="token punctuation">(</span>pid:13189<span class="token punctuation">)</span> is running<span class="token punctuation">(</span>0:PING_OK<span class="token punctuation">)</span><span class="token punctuation">,</span> master:10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>52

mysqlbinlog  <span class="token operator">-</span>R <span class="token operator">--</span>host=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>51 <span class="token operator">--</span>user=mha <span class="token operator">--</span>password=mha <span class="token operator">--</span>raw  <span class="token operator">--</span>stop<span class="token operator">-</span>never mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span>000001 &amp;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="11-快速恢复"><a href="#11-快速恢复" class="headerlink" title="11.快速恢复"></a>11.快速恢复</h2><pre class="line-numbers language-powershell"><code class="language-powershell">1主2从：
<span class="token namespace">[root@db03 binlog_server]</span><span class="token comment" spellcheck="true"># mysql -e "show slave status\G" |grep "Master_Host"</span>
Master_Host: 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>52
<span class="token namespace">[root@db01 data]</span><span class="token comment" spellcheck="true">#  mysql -e "show slave status\G" |grep "Master_Host"</span>

修复1主从：
db01: 

change master to 
master_host=<span class="token string">'10.0.0.52'</span><span class="token punctuation">,</span>
master_user=<span class="token string">'repl'</span><span class="token punctuation">,</span>
master_password=<span class="token string">'123'</span> <span class="token punctuation">,</span>
MASTER_AUTO_POSITION=1<span class="token punctuation">;</span>
<span class="token function">start</span> slave<span class="token punctuation">;</span>

<span class="token namespace">[root@db01 data]</span><span class="token comment" spellcheck="true">#  mysql -e "show slave status\G" |grep "Master_Host"</span>
                  Master_Host: 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>52


9<span class="token punctuation">.</span>2 检查vip是否在主库
<span class="token namespace">[root@db02 data]</span><span class="token comment" spellcheck="true"># ip a</span>

9<span class="token punctuation">.</span>3 检查binlog_server状态 
<span class="token namespace">[root@db03 binlog_server]</span><span class="token comment" spellcheck="true"># ps -ef |grep mysqlbinlog</span>
root      77828  39593  0 17:53 pts<span class="token operator">/</span>2    00:00:00 grep <span class="token operator">--</span>color=auto mysqlbinlog
<span class="token namespace">[root@db03 binlog_server]</span><span class="token comment" spellcheck="true"># </span>

修复binlog_server: 
<span class="token namespace">[root@db03 binlog_server]</span><span class="token comment" spellcheck="true"># rm -rf /data/binlog_server/*</span>

<span class="token namespace">[root@db03 binlog_server]</span><span class="token comment" spellcheck="true"># cd /data/binlog_server/</span>
<span class="token namespace">[root@db03 ~]</span><span class="token comment" spellcheck="true"># mysql -e "show slave status \G"|grep "Master_Log"</span>
<span class="token namespace">[root@db03 ~]</span><span class="token comment" spellcheck="true"># mysqlbinlog  -R --host=10.0.0.52 --user=mha --password=mha --raw  --stop-never mysql-bin.000002 &amp;</span>


9<span class="token punctuation">.</span>4 检查配置文件 
三个节点是否存在：
<span class="token namespace">[root@db03 binlog_server]</span><span class="token comment" spellcheck="true"># cat /etc/mha/app1.cnf </span>

添加新节点到配置文件： 
masterha_conf_host <span class="token operator">--</span>command=add <span class="token operator">--</span>conf=<span class="token operator">/</span>etc<span class="token operator">/</span>mha<span class="token operator">/</span>app1<span class="token punctuation">.</span>cnf <span class="token operator">--</span>hostname=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">.</span>62 <span class="token operator">--</span>block=server1 <span class="token operator">--</span>params=<span class="token string">"port=3306"</span>

<span class="token operator">++</span>+<span class="token operator">++</span>+<span class="token operator">++</span>
masterha_conf_host <span class="token operator">--</span>command=delete <span class="token operator">--</span>conf=<span class="token operator">/</span>etc<span class="token operator">/</span>mha<span class="token operator">/</span>app1<span class="token punctuation">.</span>cnf <span class="token operator">--</span>block=server1
<span class="token operator">++</span>+<span class="token operator">++</span>+<span class="token operator">++</span>


9<span class="token punctuation">.</span>5 检查ssh互信和repl

<span class="token namespace">[root@db03 ~]</span><span class="token comment" spellcheck="true"># masterha_check_ssh  --conf=/etc/mha/app1.cnf</span>
<span class="token namespace">[root@db03 ~]</span><span class="token comment" spellcheck="true"># masterha_check_repl  --conf=/etc/mha/app1.cnf </span>


9<span class="token punctuation">.</span>6 启动MHA 
<span class="token namespace">[root@db03 bin]</span><span class="token comment" spellcheck="true"># nohup masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover  &lt; /dev/null> /var/log/mha/app1/manager.log 2>&amp;1 &amp;</span>

<span class="token namespace">[root@db03 ~]</span><span class="token comment" spellcheck="true"># masterha_check_status   --conf=/etc/mha/app1.cnf </span>
app1 <span class="token punctuation">(</span>pid:78201<span class="token punctuation">)</span> is running<span class="token punctuation">(</span>0:PING_OK<span class="token punctuation">)</span><span class="token punctuation">,</span> master:10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>52
<span class="token namespace">[root@db03 ~]</span><span class="token comment" spellcheck="true">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="8-MHA的维护操作-在线切换功能"><a href="#8-MHA的维护操作-在线切换功能" class="headerlink" title="8-MHA的维护操作 - 在线切换功能"></a>8-MHA的维护操作 - 在线切换功能</h1><h2 id="8-1-只切换角色"><a href="#8-1-只切换角色" class="headerlink" title="8.1 只切换角色"></a>8.1 只切换角色</h2><pre class="line-numbers language-powershell"><code class="language-powershell">masterha_master_switch  <span class="token operator">--</span>conf=<span class="token operator">/</span>etc<span class="token operator">/</span>mha<span class="token operator">/</span>app1<span class="token punctuation">.</span>cnf <span class="token operator">--</span>master_state=alive <span class="token operator">--</span>new_master_host=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">.</span>61 <span class="token operator">--</span>orig_master_is_new_slave <span class="token operator">--</span>running_updates_limit=10000

注意： 
master_ip_online_change_script is not defined<span class="token punctuation">.</span> <span class="token keyword">If</span> you <span class="token keyword">do</span> not disable writes on the current master manually<span class="token punctuation">,</span> applications keep writing on the current master<span class="token punctuation">.</span> Is it ok to proceed? <span class="token punctuation">(</span>yes<span class="token operator">/</span>NO<span class="token punctuation">)</span>: yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-CQL"><code class="language-CQL">9.6 启动MHA 
[root@db03 bin]# nohup masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover  < /dev/null> /var/log/mha/app1/manager.log 2>&1 &<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<blockquote>
<ol>
<li><p>此种方法切换，要注意将原主库，FTWRL（Flush table with read lock），否则会造成主从不一致。</p>
</li>
<li><p>手工切换vip</p>
</li>
<li><p>重新拉去新主库的binlog</p>
</li>
</ol>
</blockquote>
<p>8.2 master_ip_online_change_script功能实现</p>
<p>功能: 在线切换时，自动锁原主库，VIP自动切换</p>
<p>8.2.1 准备切换脚本</p>
<p>vim /usr/local/bin/master_ip_online_change</p>
<pre><code>my $vip = &quot;10.0.0.55/24&quot;;
my $key = &quot;1&quot;;
my $ssh_start_vip = &quot;/sbin/ifconfig ens33:$key $vip&quot;;
my $ssh_stop_vip = &quot;/sbin/ifconfig ens33:$key $vip down&quot;;
my $ssh_Bcast_arp= &quot;/sbin/arping -I ens33 -c 3 -A 10.0.0.55&quot;;</code></pre><p>8.2.2 修改MHA配置文件 </p>
<pre><code>vim /etc/mha/app1.cnf
master_ip_online_change_script=/usr/local/bin/master_ip_online_change</code></pre><p>8.2.3 停 MHA</p>
<pre><code>[root@db03 bin]# masterha_stop  --conf=/etc/mha/app1.cnf </code></pre><p>8.2.4 检查repl</p>
<pre><code>[root@db03 bin]# masterha_check_repl   --conf=/etc/mha/app1.cnf </code></pre><p>8.2.4 在线切换 </p>
<pre><code>masterha_master_switch  --conf=/etc/mha/app1.cnf --master_state=alive --new_master_host=10.0.1.61 --orig_master_is_new_slave --running_updates_limit=10000</code></pre><p>8.2.5 重构binlogserver</p>
<pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@db03 bin]</span><span class="token comment" spellcheck="true"># ps -ef |grep mysqlbinlog</span>
root      28144  16272  0 17:50 pts<span class="token operator">/</span>1    00:00:00 mysqlbinlog <span class="token operator">-</span>R <span class="token operator">--</span>host=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>52 <span class="token operator">--</span>user=mha <span class="token operator">--</span>password=x x <span class="token operator">--</span>raw <span class="token operator">--</span>stop<span class="token operator">-</span>never mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span>000004
root      28529  16272  0 18:03 pts<span class="token operator">/</span>1    00:00:00 grep <span class="token operator">--</span>color=auto mysqlbinlog
<span class="token namespace">[root@db03 bin]</span><span class="token comment" spellcheck="true"># kill -9 28144</span>
<span class="token namespace">[root@db03 bin]</span><span class="token comment" spellcheck="true"># cd /data/binlog_server/</span>
<span class="token namespace">[root@db03 binlog_server]</span><span class="token comment" spellcheck="true"># ll</span>
total 4
<span class="token operator">-</span>rw<span class="token operator">-</span>r-<span class="token operator">--</span>-<span class="token operator">-</span> 1 root root 194 Apr  1 17:50 mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span>000005
<span class="token namespace">[root@db03 binlog_server]</span><span class="token comment" spellcheck="true"># rm -rf *</span>
<span class="token namespace">[root@db03 binlog_server]</span><span class="token comment" spellcheck="true"># mysqlbinlog  -R --host=10.0.1.62 --user=mha --password=mha --raw  --stop-never mysql-bin.000004 &amp;</span>
<span class="token punctuation">[</span>1<span class="token punctuation">]</span> 28534<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>8.2.6 启动MHA </p>
<pre class="line-numbers language-CQL"><code class="language-CQL">[root@db03 bin]# nohup masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover  < /dev/null> /var/log/mha/app1/manager.log 2>&1 &

[root@db03 binlog_server]# masterha_check_status   --conf=/etc/mha/app1.cnf 
app1 (pid:28535) is running(0:PING_OK), master:10.0.0.51<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="9-Atlas读写分离中间件应用"><a href="#9-Atlas读写分离中间件应用" class="headerlink" title="9-Atlas读写分离中间件应用"></a>9-Atlas读写分离中间件应用</h1><pre class="line-numbers language-powershell"><code class="language-powershell">1<span class="token punctuation">.</span> 介绍
Atlas是由 Qihoo 360<span class="token punctuation">,</span> Web平台部基础架构团队开发维护的一个基于MySQL协议的数据中间层项目。
它是在mysql<span class="token operator">-</span>proxy 0<span class="token punctuation">.</span>8<span class="token punctuation">.</span>2版本的基础上，对其进行了优化，增加了一些新的功能特性。
360内部使用Atlas运行的mysql业务，每天承载的读写请求数达几十亿条。
下载地址
https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Qihoo360<span class="token operator">/</span>Atlas<span class="token operator">/</span>releases<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意：</p>
<pre class="line-numbers language-powershell"><code class="language-powershell">1、Atlas只能安装运行在64位的系统上
2、Centos 5<span class="token punctuation">.</span>X安装 Atlas<span class="token operator">-</span>XX<span class="token punctuation">.</span>el5<span class="token punctuation">.</span>x86_64<span class="token punctuation">.</span>rpm，Centos 6<span class="token punctuation">.</span>X安装Atlas<span class="token operator">-</span>XX<span class="token punctuation">.</span>el6<span class="token punctuation">.</span>x86_64<span class="token punctuation">.</span>rpm。
3、后端mysql版本应大于5<span class="token punctuation">.</span>1，建议使用Mysql 5<span class="token punctuation">.</span>6以上<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h2><pre class="line-numbers language-powershell"><code class="language-powershell">https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>Qihoo360<span class="token operator">/</span>Atlas<span class="token operator">/</span>releases

<span class="token namespace">[root@db03 data]</span><span class="token comment" spellcheck="true"># rpm -ivh Atlas-2.2.1.el6.x86_64.rpm </span>
Preparing<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                          <span class="token comment" spellcheck="true">################################# [100%]</span>
Updating <span class="token operator">/</span> installing<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   1:Atlas<span class="token operator">-</span>2<span class="token punctuation">.</span>2<span class="token punctuation">.</span>1<span class="token operator">-</span>1                    <span class="token comment" spellcheck="true">################################# [100%]</span>
<span class="token namespace">[root@db03 data]</span><span class="token comment" spellcheck="true"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-配置-1"><a href="#2-配置-1" class="headerlink" title="2. 配置"></a>2. 配置</h3><pre class="line-numbers language-CQL"><code class="language-CQL">cd /usr/local/mysql-proxy/conf
mv test.cnf test.cnf.bak
cat > test.cnf <<EOF
[mysql-proxy]
admin-username = user
admin-password = pwd
proxy-backend-addresses = 10.0.1.55:3306
proxy-read-only-backend-addresses = 10.0.1.52:3306,10.0.1.53:3306
pwds = repl:3yb5jEku5h4=,mha:O2jBXONX098=
daemon = true
keepalive = true
event-threads = 8
log-level = message
log-path = /usr/local/mysql-proxy/log
sql-log=ON
proxy-address = 0.0.0.0:33060
admin-address = 0.0.0.0:2345
charset=utf8
EOF<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-启动atlas"><a href="#3-启动atlas" class="headerlink" title="3-启动atlas"></a>3-启动atlas</h3><pre class="line-numbers language-CQL"><code class="language-CQL">/usr/local/mysql-proxy/bin/mysql-proxyd test restart
ps -ef |grep proxy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="2-Atlas功能测试"><a href="#2-Atlas功能测试" class="headerlink" title="2-Atlas功能测试"></a>2-Atlas功能测试</h2><h3 id="测试读操作："><a href="#测试读操作：" class="headerlink" title="测试读操作："></a>测试读操作：</h3><pre><code>mysql -umha -pmha  -h 10.0.0.53 -P 33060 
db03 [(none)]&gt;select @@server_id;
</code></pre><h3 id="测试写操作："><a href="#测试写操作：" class="headerlink" title="测试写操作："></a>测试写操作：</h3><pre><code>mysql&gt; begin;select @@server_id;commit;
</code></pre><blockquote>
<p>注意:<br>DDL建议不要再Atlas触发，最好是到主库触发（Online DDL或者PT-OSC）。<br>DML建议begin; DML;  commit;</p>
</blockquote>
<h2 id="3-Atlas-的管理操作"><a href="#3-Atlas-的管理操作" class="headerlink" title="3-Atlas 的管理操作"></a>3-Atlas 的管理操作</h2><pre><code>[root@db03 conf]# mysql -uuser -ppwd -h 10.0.0.53 -P2345
db03 [(none)]&gt;select * from help;</code></pre><h3 id="查看所有节点"><a href="#查看所有节点" class="headerlink" title="查看所有节点"></a>查看所有节点</h3><pre class="line-numbers language-powershell"><code class="language-powershell">db03 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span>><span class="token function">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> backends<span class="token punctuation">;</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span><span class="token operator">+</span>
<span class="token punctuation">|</span> backend_ndx <span class="token punctuation">|</span> address        <span class="token punctuation">|</span> state <span class="token punctuation">|</span> <span class="token function">type</span> <span class="token punctuation">|</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span><span class="token operator">+</span>
<span class="token punctuation">|</span>           1 <span class="token punctuation">|</span> 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>55:3306 <span class="token punctuation">|</span> up    <span class="token punctuation">|</span> rw   <span class="token punctuation">|</span>
<span class="token punctuation">|</span>           2 <span class="token punctuation">|</span> 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>52:3306 <span class="token punctuation">|</span> up    <span class="token punctuation">|</span> ro   <span class="token punctuation">|</span>
<span class="token punctuation">|</span>           3 <span class="token punctuation">|</span> 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>53:3306 <span class="token punctuation">|</span> up    <span class="token punctuation">|</span> ro   <span class="token punctuation">|</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span><span class="token operator">+</span>
3 rows in <span class="token function">set</span> <span class="token punctuation">(</span>0<span class="token punctuation">.</span>00 sec<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="节点的上线和下线"><a href="#节点的上线和下线" class="headerlink" title="节点的上线和下线"></a>节点的上线和下线</h3><pre class="line-numbers language-CQL"><code class="language-CQL">db03 [(none)]>SET OFFLINE 1;
+-------------+----------------+---------+------+
| backend_ndx | address        | state   | type |
+-------------+----------------+---------+------+
|           1 | 10.0.0.55:3306 | offline | rw   |
+-------------+----------------+---------+------+
1 row in set (0.01 sec)

db03 [(none)]>SELECT * FROM backends;
+-------------+----------------+---------+------+
| backend_ndx | address        | state   | type |
+-------------+----------------+---------+------+
|           1 | 10.0.0.55:3306 | offline | rw   |
|           2 | 10.0.0.52:3306 | up      | ro   |
|           3 | 10.0.0.53:3306 | up      | ro   |
+-------------+----------------+---------+------+

db03 [(none)]>SET ONLINE 1;
+-------------+----------------+---------+------+
| backend_ndx | address        | state   | type |
+-------------+----------------+---------+------+
|           1 | 10.0.0.55:3306 | unknown | rw   |
+-------------+----------------+---------+------+
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="删除和添加节点"><a href="#删除和添加节点" class="headerlink" title="删除和添加节点"></a>删除和添加节点</h3><pre class="line-numbers language-CQL"><code class="language-CQL">db03 [(none)]>REMOVE BACKEND  3;
db03 [(none)]>ADD SLAVE  10.0.1.63:3306;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="用户管理"><a href="#用户管理" class="headerlink" title="用户管理"></a>用户管理</h3><p>主库添加跟后台添加</p>
<pre class="line-numbers language-CQL"><code class="language-CQL">db01 [(none)]>grant all on *.* to oldguo@'10.0.0.%' identified by '123';  
db03 [(none)]>SELECT * FROM pwds;
db03 [(none)]>add pwd oldguo:123;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="持久化配置文件"><a href="#持久化配置文件" class="headerlink" title="持久化配置文件"></a>持久化配置文件</h3><pre><code>db03 [(none)]&gt;save config;</code></pre>
            </div>
            <hr />

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">写作不易，客官能否打赏一杯奶茶？</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《11-mysql-主从复制高级进阶》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/2020/05/19/11-mysql-zhu-cong-fu-zhi-gao-ji-jin-jie/" property="cc:attributionName"
               rel="cc:attributionURL">
                小明
            </a> 采用
            <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    
    <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '',
        clientSecret: '',
        repo: 'godweiyang.github.io',
        owner: 'godweiyang',
        admin: "godweiyang",
        id: '2020/05/19/11-mysql-zhu-cong-fu-zhi-gao-ji-jin-jie/',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    
    <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script> -->

<script>
    new Valine({
        el: '#vcomments',
        appId: '',
        appKey: '',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'false' === 'true',
        avatar: 'wavatar',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '如果你没有GitHub账号，还可以在这里评论啦！'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-dot-circle-o"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/2020/05/19/11-mysql-zhu-cong-fu-zhi-gao-ji-jin-jie/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/3.jpg" class="responsive-img" alt="11-mysql-主从复制高级进阶">
                        
                        <span class="card-title">11-mysql-主从复制高级进阶</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            1-延时从库1-介绍
普通的主从复制，处理物理故障损坏比较擅长。
如果主库出现了DROP DATABASE操作。
延时从库： 主库做了某项操作之后，从库延时多长时间回放（SQL）。可以处理逻辑损坏。
2-配置mysql>stop slave
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-05-19
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/mysql/" class="post-category" target="_blank">
                                    mysql
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/leetcode/" target="_blank">
                        <span class="chip bg-color">leetcode</span>
                    </a>
                    
                    <a href="/tags/mysql/" target="_blank">
                        <span class="chip bg-color">mysql</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/05/18/01-yun-ji-suan-kvm-openstack/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/17.jpg" class="responsive-img" alt="13-MySQL 全面优化+故障+PT工具使用">
                        
                        <span class="card-title">13-MySQL 全面优化+故障+PT工具使用</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            简介1. 优化的哲学

1.1 什么时候优化 ？
优化有风险，涉足请谨慎！！
优化一定是由业务需求触发的。

1.2 数据库的优化谁来参与 ？ 
硬件工程师 
网落管理员
系统管理员
开发人员
DBA 
领导



1.3 数据库优化的思路
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-05-18
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/kvm-openstack/" class="post-category" target="_blank">
                                    kvm openstack
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/leetcode/" target="_blank">
                        <span class="chip bg-color">leetcode</span>
                    </a>
                    
                    <a href="/tags/云计算/" target="_blank">
                        <span class="chip bg-color">云计算</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('5')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 小明同学<br />'
            + '作者: 小明<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
    });
</script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>

<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>


    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            &copy; 2019-2020 小明. 版权所有

            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
            <span class="white-color">72.2k</span>
            

            <br>
            <span id="sitetime"></span>

            
            
            <br>
            
            <span id="busuanzi_container_site_pv" style='display:none'>
                <i class="fa fa-heart-o"></i>
                本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
            <span id="busuanzi_container_site_uv" style='display:none'>
                人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
            </span>
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/xiaoming" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:ye33445200@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="https://zhihu.com/people/xiaoming" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-inverse">知</i>
    </a>



    <a href="http://wpa.qq.com/msgrd?v=3&uin=970740860&site=qq&menu=yes" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>



    <a href="https://weibo.com/xiaoming" class="tooltipped" target="_blank" data-tooltip="关注我的微博" data-position="top" data-delay="50">
        <i class="fa fa-weibo"></i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 不蒜子计数初始值纠正 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);
        var pvcountOffset = 80000;
        var uvcountOffset = 20000;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int);
            }
        }
    });
</script>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2019, 04, 22, 00, 00, 00); //北京时间2020-04-22 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <script type="text/javascript"> var OriginTitile = document.title, st; document.addEventListener("visibilitychange", function () { document.hidden ? (document.title = "Σ(っ °Д °;)っ喔哟，崩溃啦！", clearTimeout(st)) : (document.title = "φ(゜▽゜*)♪咦，又好了！", st = setTimeout(function () { document.title = OriginTitile }, 3e3)) })
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', '');
</script>



    
    <script src="/libs/others/clicklove.js"></script>
    

    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 雪花特效 -->
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":200,"height":400},"mobile":{"show":true},"react":{"opacity":0.7}});</script></body>

</html>