<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="13-MySQL 全面优化+故障+PT工具使用, 自然语言处理 深度学习 算法码上来">
    <meta name="baidu-site-verification" content="fmlEuI34ir">
    <meta name="google-site-verification" content="yCy2azpds5XSuGZvis6OuA-XIGF5GuGpYRAaGfD6o48">
    <meta name="360-site-verification" content="b7c11a830ef90fd1464ad6206bb7b6e7">
    <meta name="description" content="简介1. 优化的哲学

1.1 什么时候优化 ？
优化有风险，涉足请谨慎！！
优化一定是由业务需求触发的。

1.2 数据库的优化谁来参与 ？ 
硬件工程师 
网落管理员
系统管理员
开发人员
DBA 
领导



1.3 数据库优化的思路">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>13-MySQL 全面优化+故障+PT工具使用 | 小明同学</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?46e79e71af0709a5b9106bf20cecc493";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

    
        <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
        </script>
    

    <script>
        (function(){
        var src = "https://jspassport.ssl.qhimg.com/11.0.1.js?d182b3f28525f2db83acfaaf6e696dba";
        document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">小明同学</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <i class="fa fa-comments"></i>
            
            <span>留言板</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">小明同学</div>
        <div class="logo-desc">
            
            计算机科学与技术 | 自然语言处理
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-comments"></i>
                
                留言板
            </a>
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/17.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        13-MySQL 全面优化+故障+PT工具使用
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                        <a href="/tags/leetcode/" target="_blank">
                            <span class="chip bg-color">leetcode</span>
                        </a>
                        
                        <a href="/tags/云计算/" target="_blank">
                            <span class="chip bg-color">云计算</span>
                        </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                        <a href="/categories/kvm-openstack/" class="post-category" target="_blank">
                            kvm openstack
                        </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-05-18
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                    小明
                    
                </div>

                
                
                <div class="info-break-policy">
                    <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                    3.8k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    16 分
                </div>
                
                

                
                <div id="busuanzi_container_page_pv" class="info-break-policy">
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv"></span>
                </div>
                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><pre class="line-numbers language-powershell"><code class="language-powershell">1<span class="token punctuation">.</span> 优化的哲学

1<span class="token punctuation">.</span>1 什么时候优化 ？
优化有风险，涉足请谨慎！！
优化一定是由业务需求触发的。

1<span class="token punctuation">.</span>2 数据库的优化谁来参与 ？ 
硬件工程师 
网落管理员
系统管理员
开发人员
DBA 
领导



1<span class="token punctuation">.</span>3 数据库优化的思路
1<span class="token punctuation">.</span>3<span class="token punctuation">.</span>1 大面 
性能  
安全 
1<span class="token punctuation">.</span>3<span class="token punctuation">.</span>2 框架
（1）硬件、网络、存储
（2）操作系统、文件系统
（3）数据库实例 （链接层、SQL层、存储引擎层）
（4）业务应用（库、表、索引、SQL语句、锁等）
（5）架构选型（高可用、读写分离、分布式、NoSQL）

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-工具介绍"><a href="#2-工具介绍" class="headerlink" title="2. 工具介绍"></a>2. 工具介绍</h2><pre class="line-numbers language-powershell"><code class="language-powershell">2<span class="token punctuation">.</span>1 操作系统和硬件层面 
cpu             : top 、htop 、sar 、vmstat 
mem、swap         ：top 、 free  、vmstat 、sar 
IO（disk、net） ：iotop、iostat 


2<span class="token punctuation">.</span>3 高级工具 
PT 
压测工具 ： FIO、mysqlslap、sysbench、tpc<span class="token operator">-</span>C mysql tpc<span class="token operator">-</span>H mysql <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
IS、<span class="token function">PS</span>、SYS

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="3-0-数据库实例"><a href="#3-0-数据库实例" class="headerlink" title="3.0 数据库实例"></a>3.0 数据库实例</h2><pre><code>show processlist;
db01 [(none)]&gt;show status\G;
show engine innodb status \G</code></pre><ol start="3">
<li>优化细节</li>
</ol>
<pre class="line-numbers language-powershell"><code class="language-powershell">3<span class="token punctuation">.</span>1  硬件选型建议
3<span class="token punctuation">.</span>1<span class="token punctuation">.</span>1 服务器 ：
<span class="token comment" spellcheck="true"># MySQL  :  </span>
PC Server: 
        OLTP: 在线事务处理系统。IO密集性，高并发。
            CPU ： 志强 16核<span class="token operator">+</span> 
            MEM :  64G<span class="token operator">+</span>
            IO  :  
                磁盘IO: 
                    硬盘：   SAS 、 PCI<span class="token operator">-</span>E SSD 、Flash 
                    RAID卡： RAID 5 、RAID 10
                网络IO： 网卡。单口单卡。bound网卡绑定（主备、轮询）。网络交换机要做堆叠。

阿里（RDS、DRDS 、PolarDB\PolarDB box<span class="token punctuation">)</span>        

<span class="token operator">++</span>+<span class="token operator">++</span>+<span class="token operator">++</span>+<span class="token operator">++</span>+<span class="token operator">++</span>+<span class="token operator">++</span>+<span class="token operator">++</span>+<span class="token operator">++</span><span class="token operator">+</span>                    
OLAP：计算类的业务。CPU密集型。
            CPU:   I系列 主频高
阿里（RDS、DRDS 、PolarDB\PolarDB box<span class="token punctuation">)</span>
腾讯云：     
<span class="token comment" spellcheck="true"># Oracle :  小机 （IBM PowerPC\HP小机）、PC Server、Oracle 一体机</span>

<span class="token operator">++</span>+<span class="token operator">++</span>+<span class="token operator">++</span>+<span class="token operator">++</span>+<span class="token operator">++</span>+<span class="token operator">++</span>+<span class="token operator">++</span>+<span class="token operator">++</span>+<span class="token operator">++</span><span class="token operator">+</span>
<span class="token comment" spellcheck="true"># 网络设备 </span>
        网络交换机  ： vlan
        光纤交换机  ： zone
堆叠。




<span class="token comment" spellcheck="true"># 存储设备 </span>
RAID 10。
注意： 不要过度条带化。可能导致IOPS过高，甚至被打满。
IOPS： 一块硬盘，最高每秒的IO次数。是个定值。

一般情况下，新规划架构时，一定要考虑好。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="1-系统工具应用"><a href="#1-系统工具应用" class="headerlink" title="1-系统工具应用"></a>1-系统工具应用</h1><h2 id="1-CPU"><a href="#1-CPU" class="headerlink" title="1-CPU"></a>1-CPU</h2><pre class="line-numbers language-powershell"><code class="language-powershell">top 
<span class="token operator">%</span>Cpu<span class="token punctuation">(</span>s<span class="token punctuation">)</span>: CPU的平均值使用率，按“1”会展开看到每颗cpu占比。
    us ：用户进程占用的CPU时间。我们希望看到这个越多越好。
    sy ：系统、内核工作时候占用的CPU比例。资源监控、分配、回收、系统调用。我们希望越低越好。
    id ：空闲CPU的时间。  
    wa ：花在等待上的时间。等资源：处理队列、IO。

数据库服务器： 
    如果： wa很高， 大几率 ： 大事务、全表扫描、随机IO过多、锁等待
    锁等待也会导致 sys过高。全表扫描也会导致us过高。
    wa ：花在等待上的时间。等资源：处理队列、IO<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-mysql"><code class="language-mysql"> mysqlslap --defaults-file=/etc/my.cnf --concurrency=10 --iterations=1 --create-schema='test' --query="select * from test.t100w where k2='FGCD'" engine=innodb --number-of-queries=1000 -uroot -p123 -verbose
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="2-MySQL-服务器-，CPU-暴涨，排查思路"><a href="#2-MySQL-服务器-，CPU-暴涨，排查思路" class="headerlink" title="2-MySQL 服务器 ，CPU 暴涨，排查思路"></a>2-MySQL 服务器 ，CPU 暴涨，排查思路</h2><pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token comment" spellcheck="true"># 1. 找 mysql 的进程号</span>
<span class="token namespace">[root@db01 data]</span><span class="token comment" spellcheck="true"># cat /data/3306/data/db01.pid  #数据目录下或者ps</span>
97798

<span class="token comment" spellcheck="true"># 2. 通过 进程找问题线程</span>
top <span class="token operator">-</span>Hp 97798  
 PID USER      PR  <span class="token function">NI</span>    VIRT    RES    SHR S <span class="token operator">%</span>CPU <span class="token operator">%</span>MEM     TIME<span class="token operator">+</span> COMMAND                                                                
 13974 mysql     20   0 1163280 254104  12948 R 10<span class="token punctuation">.</span>9 12<span class="token punctuation">.</span>5   1:03<span class="token punctuation">.</span>22 mysqld        


OS_thread_ID  24331

<span class="token comment" spellcheck="true"># 3. 通过OS thread找到数据库内部线程</span>

mysql> <span class="token function">select</span> thread_id<span class="token punctuation">,</span>PROCESSLIST_ID <span class="token punctuation">,</span>THREAD_OS_ID  <span class="token keyword">from</span> performance_schema<span class="token punctuation">.</span>threads where THREAD_OS_ID=24331<span class="token punctuation">;</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span>+<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span>+<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span><span class="token operator">+</span>
<span class="token punctuation">|</span> thread_id <span class="token punctuation">|</span> PROCESSLIST_ID <span class="token punctuation">|</span> THREAD_OS_ID <span class="token punctuation">|</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span>+<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span>+<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span><span class="token operator">+</span>
<span class="token punctuation">|</span>        82 <span class="token punctuation">|</span>             57 <span class="token punctuation">|</span>       121855 <span class="token punctuation">|</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span>+<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span>+<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span><span class="token operator">+</span>


<span class="token comment" spellcheck="true"># 4. 通过 thread_id找到问题SQL语句 </span>

mysql> <span class="token function">select</span> THREAD_ID <span class="token punctuation">,</span>SQL_TEXT <span class="token keyword">from</span> performance_schema<span class="token punctuation">.</span>events_statements_history where THREAD_ID=82<span class="token punctuation">;</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span>+<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>
<span class="token punctuation">|</span> THREAD_ID <span class="token punctuation">|</span> SQL_TEXT                                 <span class="token punctuation">|</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span>+<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>
<span class="token punctuation">|</span>        82 <span class="token punctuation">|</span> <span class="token function">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>t100w where k2=<span class="token string">'FGCD'</span> <span class="token punctuation">|</span>
<span class="token punctuation">|</span>        82 <span class="token punctuation">|</span> <span class="token function">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>t100w where k2=<span class="token string">'FGCD'</span> <span class="token punctuation">|</span>
<span class="token punctuation">|</span>        82 <span class="token punctuation">|</span> <span class="token function">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>t100w where k2=<span class="token string">'FGCD'</span> <span class="token punctuation">|</span>
<span class="token punctuation">|</span>        82 <span class="token punctuation">|</span> <span class="token function">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>t100w where k2=<span class="token string">'FGCD'</span> <span class="token punctuation">|</span>
<span class="token punctuation">|</span>        82 <span class="token punctuation">|</span> <span class="token function">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>t100w where k2=<span class="token string">'FGCD'</span> <span class="token punctuation">|</span>
<span class="token punctuation">|</span>        82 <span class="token punctuation">|</span> <span class="token function">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>t100w where k2=<span class="token string">'FGCD'</span> <span class="token punctuation">|</span>
<span class="token punctuation">|</span>        82 <span class="token punctuation">|</span> <span class="token function">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>t100w where k2=<span class="token string">'FGCD'</span> <span class="token punctuation">|</span>
<span class="token punctuation">|</span>        82 <span class="token punctuation">|</span> <span class="token function">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>t100w where k2=<span class="token string">'FGCD'</span> <span class="token punctuation">|</span>
<span class="token punctuation">|</span>        82 <span class="token punctuation">|</span> <span class="token function">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>t100w where k2=<span class="token string">'FGCD'</span> <span class="token punctuation">|</span>
<span class="token punctuation">|</span>        82 <span class="token punctuation">|</span> <span class="token function">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>t100w where k2=<span class="token string">'FGCD'</span> <span class="token punctuation">|</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span>+<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>

<span class="token comment" spellcheck="true"># MEM、SWAP </span>
MEM 主要看 avail Mem  、 buff<span class="token operator">/</span>cache
64G  
不会超过90<span class="token operator">%</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="3-SWAP-：-MySQL建议不使用。"><a href="#3-SWAP-：-MySQL建议不使用。" class="headerlink" title="3-SWAP ： MySQL建议不使用。"></a>3-SWAP ： MySQL建议不使用。</h2><pre class="line-numbers language-powershell"><code class="language-powershell">什么时候算不

centos7 中默认物理内存70<span class="token operator">%</span><span class="token punctuation">,</span> 时会使用swap。
centos6 中默认物理内存40<span class="token operator">%</span> <span class="token punctuation">,</span>时会使用swap。


<span class="token namespace">[root@db01 data]</span><span class="token comment" spellcheck="true"># cat /proc/sys/vm/swappiness </span>
30
<span class="token namespace">[root@db01 data]</span><span class="token comment" spellcheck="true"># echo 0 >/proc/sys/vm/swappiness </span>
<span class="token namespace">[root@db01 data]</span><span class="token comment" spellcheck="true"># cat /proc/sys/vm/swappiness </span>
0

<span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>conf
上添加vm<span class="token punctuation">.</span>swappiness=0（永久）
sysctl <span class="token operator">-</span>p
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="4-IO"><a href="#4-IO" class="headerlink" title="4-IO"></a>4-IO</h2><pre class="line-numbers language-powershell"><code class="language-powershell">说明： 
deadline<span class="token punctuation">(</span>适合SAS盘<span class="token punctuation">)</span>
noop    <span class="token punctuation">(</span>适合ssd<span class="token punctuation">,</span>flash<span class="token punctuation">)</span>
centos 7 默认是 deadline

查看：
<span class="token function">cat</span>   <span class="token operator">/</span>sys<span class="token operator">/</span>block<span class="token operator">/</span>sda<span class="token operator">/</span>queue<span class="token operator">/</span>scheduler

修改： 
<span class="token comment" spellcheck="true"># 临时</span>
<span class="token function">echo</span> deadline ><span class="token operator">/</span>sys<span class="token operator">/</span>block<span class="token operator">/</span>sda<span class="token operator">/</span>queue<span class="token operator">/</span>scheduler 

<span class="token comment" spellcheck="true"># 永久</span>
vi <span class="token operator">/</span>boot<span class="token operator">/</span>grub<span class="token operator">/</span>grub<span class="token punctuation">.</span>conf
更改到如下内容:
kernel <span class="token operator">/</span>boot<span class="token operator">/</span>vmlinuz<span class="token operator">-</span>2<span class="token punctuation">.</span>6<span class="token punctuation">.</span>18<span class="token operator">-</span>8<span class="token punctuation">.</span>el5 ro root=LABEL=<span class="token operator">/</span> elevator=deadline rhgb quiet

其他建议：
    raid
    no lvm
    ext4或xfs
    ssd
提前规划好以上所有问题，减轻MySQL优化的难度。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="5-实例层面优化-参数"><a href="#5-实例层面优化-参数" class="headerlink" title="5-实例层面优化(参数)"></a>5-实例层面优化(参数)</h2><pre class="line-numbers language-powershell"><code class="language-powershell">连接层 
<span class="token operator">--</span>skip<span class="token operator">-</span>networking   <span class="token comment" spellcheck="true"># 跳过网络TCP连接协议，如果你的应用和数据放在一起。</span>
<span class="token operator">--</span>skip<span class="token operator">-</span>grant<span class="token operator">-</span>tables <span class="token comment" spellcheck="true"># 跳过授权表</span>
<span class="token operator">--</span>skip<span class="token operator">-</span>name<span class="token operator">-</span>resolve <span class="token comment" spellcheck="true"># 跳过域名解析</span>

vim <span class="token operator">/</span>etc<span class="token operator">/</span>my<span class="token punctuation">.</span>cnf  
<span class="token namespace">[mysqld]</span>
skip<span class="token operator">-</span>name<span class="token operator">-</span>resolve
或者： 
skip<span class="token operator">-</span>name<span class="token operator">-</span>resolve=1

<span class="token comment" spellcheck="true"># 连接数：</span>
mysql> <span class="token function">select</span> @@max_connections<span class="token punctuation">;</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>
<span class="token punctuation">|</span> @@max_connections <span class="token punctuation">|</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>
<span class="token punctuation">|</span>               151 <span class="token punctuation">|</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>
1 row in <span class="token function">set</span> <span class="token punctuation">(</span>0<span class="token punctuation">.</span>00 sec<span class="token punctuation">)</span>

建议： 单节点阈值，3000<span class="token operator">-</span>4000 

设置依据：
    show processlist<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true"># 当前正在并发的。</span>

    <span class="token comment" spellcheck="true">#历史最高最大连接数</span>
    mysql> show status like <span class="token string">'%Max_used_connect%'</span><span class="token punctuation">;</span>


故障  ： too many  connections
IE  409错误。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="6-连接线程回收"><a href="#6-连接线程回收" class="headerlink" title="6-连接线程回收"></a>6-连接线程回收</h2><pre class="line-numbers language-powershell"><code class="language-powershell">mysql> <span class="token function">select</span> @@wait_timeout<span class="token punctuation">;</span>
作用： 非交互式链接，连接超时时间。

mysql> <span class="token function">select</span> @@interactive_timeout<span class="token punctuation">;</span>
作用：交互式链接，连接超时时间。



彩蛋： 

案例1： 文件句柄
连接数设置不生效的问题，214问题。
<span class="token operator">/</span>etc<span class="token operator">/</span>security<span class="token operator">/</span>limits<span class="token punctuation">.</span>conf 
<span class="token operator">*</span>　　soft　　nofile　　65536
<span class="token operator">*</span>　　hard　　nofile　　65536



案例2：MySQL 连接长时间<span class="token punctuation">(</span>7200和1200秒<span class="token punctuation">)</span>无法释放 <span class="token comment" spellcheck="true">#备份原因</span>
场景： MySQL 5<span class="token punctuation">.</span>7  ， DELL730 E5<span class="token operator">-</span>2650  96G内存  1主2从
Keepalive <span class="token operator">+</span> LVS <span class="token operator">+</span> 1主 2从 


处理方法：
ipvsadmin <span class="token operator">-</span>l <span class="token operator">-</span>timeout    <span class="token comment" spellcheck="true">#心跳检查时间</span>
Timeout <span class="token punctuation">(</span>tcp  tcpfin  udp <span class="token punctuation">)</span>:  90 120 300  <span class="token comment" spellcheck="true">#心跳检查时间</span>


net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>tcp_keepalive_time = 60   <span class="token comment" spellcheck="true">#心跳检查时间</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="7-会话级别的参数（每个连接都有关）"><a href="#7-会话级别的参数（每个连接都有关）" class="headerlink" title="7-会话级别的参数（每个连接都有关）"></a>7-会话级别的参数（每个连接都有关）</h2><pre class="line-numbers language-powershell"><code class="language-powershell"> thread_cache_size=100  （单位:个数）

拿内存换CPU时间。

依据： 
mysql>  show status like <span class="token string">'threads_%'</span><span class="token punctuation">;</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>
<span class="token punctuation">|</span> Variable_name     <span class="token punctuation">|</span> Value <span class="token punctuation">|</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>
<span class="token punctuation">|</span> Threads_cached    <span class="token punctuation">|</span> 8     <span class="token punctuation">|</span>     <span class="token comment" spellcheck="true"># 剩余的个数</span>
<span class="token punctuation">|</span> Threads_connected <span class="token punctuation">|</span> 2     <span class="token punctuation">|</span>     <span class="token comment" spellcheck="true"># 已经产生的线程</span>
<span class="token punctuation">|</span> Threads_created   <span class="token punctuation">|</span> 4783  <span class="token punctuation">|</span>     <span class="token comment" spellcheck="true"># 全新创建的线程个数</span>
<span class="token punctuation">|</span> Threads_running   <span class="token punctuation">|</span> 1     <span class="token punctuation">|</span>     <span class="token comment" spellcheck="true">#  </span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>

另外关注1：内存的剩余量。
另外关注2： CPU的 SYS
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="8-彩蛋：-CPU-SYS-暴增。"><a href="#8-彩蛋：-CPU-SYS-暴增。" class="headerlink" title="8-彩蛋：  CPU  SYS 暴增。"></a>8-彩蛋：  CPU  SYS 暴增。</h2><pre><code>show processlist ; 
mysql&gt;  show status like &#39;threads_%&#39;;

建议调大，不断观察、监控  show status like &#39;threads_%&#39;、CPU  SYS、内存的剩余量。
</code></pre><h2 id="9-innodb-thread-concurrenc-y-线程并发"><a href="#9-innodb-thread-concurrenc-y-线程并发" class="headerlink" title="9- innodb_thread_concurrenc==y  线程并发=="></a>9- innodb_thread_concurrenc==y  线程并发==</h2><pre class="line-numbers language-powershell"><code class="language-powershell">依据：  
1<span class="token punctuation">.</span> 
在官方doc上，对于innodb_thread_concurrency的使用，也给出了一些建议，如下：
如果一个工作负载中，并发用户线程的数量小于64，建议设置innodb_thread_concurrency=0；
如果工作负载一直较为严重甚至偶尔达到顶峰，建议先设置innodb_thread_concurrency=128，
并通过不断的降低这个参数，96<span class="token punctuation">,</span> 80<span class="token punctuation">,</span> 64等等，直到发现能够提供最佳性能的线程数，
例如，假设系统通常有40到50个用户，但定期的数量增加至60，70，甚至200。你会发现，
性能在80个并发用户设置时表现稳定，如果高于这个数，性能反而下降。在这种情况下，
建议设置innodb_thread_concurrency参数为80，以避免影响性能。
如果你不希望InnoDB使用的虚拟CPU数量比用户线程使用的虚拟CPU更多（比如20个虚拟CPU），
建议通过设置innodb_thread_concurrency 参数为这个值（也可能更低，这取决于性能体现），
如果你的目标是将MySQL与其他应用隔离，你可以l考虑绑定mysqld进程到专有的虚拟CPU。
但是需 要注意的是，这种绑定，在myslqd进程一直不是很忙的情况下，可能会导致非最优的硬件使用率。在这种情况下，
你可能会设置mysqld进程绑定的虚拟 CPU，允许其他应用程序使用虚拟CPU的一部分或全部。
在某些情况下，最佳的innodb_thread_concurrency参数设置可以比虚拟CPU的数量小。
定期检测和分析系统，负载量、用户数或者工作环境的改变可能都需要对innodb_thread_concurrency参数的设置进行调整。

2<span class="token punctuation">.</span> show processlist<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true"># 查看当前的并发连接数据队列。</span>
建议： 先设置较小值。8 ，不断观察队列。

3<span class="token punctuation">.</span> 观察 TOP中，每颗CPU的负载情况。
案例： top cpu负载十分不均匀<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="key-buffer-size"><a href="#key-buffer-size" class="headerlink" title="key_buffer_size"></a>key_buffer_size</h4><pre class="line-numbers language-powershell"><code class="language-powershell">功能： 
     1<span class="token punctuation">.</span> MyISAM索引缓冲。XXX
     2<span class="token punctuation">.</span> 内存临时表缓冲。（join  <span class="token function">group</span> by   disticnt   union ）
     临时表： 
           1<span class="token punctuation">.</span> 磁盘，ibtmpN
           2<span class="token punctuation">.</span> 缓冲区
设定依据：  
mysql> show status like <span class="token string">"created_tmp%"</span><span class="token punctuation">;</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>
<span class="token punctuation">|</span> Variable_name           <span class="token punctuation">|</span> Value <span class="token punctuation">|</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>
<span class="token punctuation">|</span> Created_tmp_disk_tables <span class="token punctuation">|</span> 10    <span class="token punctuation">|</span>
<span class="token punctuation">|</span> Created_tmp_files       <span class="token punctuation">|</span> 6     <span class="token punctuation">|</span>
<span class="token punctuation">|</span> Created_tmp_tables      <span class="token punctuation">|</span> 100   <span class="token punctuation">|</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>
磁盘临时表控制在10<span class="token operator">%</span>以内， 如果超过，两种方案优化

1<span class="token punctuation">.</span> 加大 key_buffer_size
tmp_table_size=200M

2<span class="token punctuation">.</span> 业务上减少结果集大小。尽量控制查询条件，精细化。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="糗事："><a href="#糗事：" class="headerlink" title="糗事："></a>糗事：</h3><pre class="line-numbers language-powershell"><code class="language-powershell">学员添加了监控项，监控：磁盘临时表百分比。告警。
每到夜黑风高的时候，都会手机告警。组里也有领导。
mysqldump 备份时，会大量使用磁盘临时表。

在调用mysqldump备份数据时，大概执行步骤如下：
180322 17:39:33       7 Connect     root@localhost on
7 Query       <span class="token operator">/</span>*<span class="token operator">!</span>40100 <span class="token function">SET</span> @@SQL_MODE=<span class="token string">''</span> <span class="token operator">*</span><span class="token operator">/</span>
7 Init DB     guo
7 Query       SHOW TABLES LIKE <span class="token string">'guo'</span>
7 Query       LOCK TABLES `guo` READ <span class="token operator">/</span>*<span class="token operator">!</span>32311 LOCAL <span class="token operator">*</span><span class="token operator">/</span>
7 Query       <span class="token function">SET</span> OPTION SQL_QUOTE_SHOW_CREATE=1
7 Query       show create table `guo`
7 Query       show fields <span class="token keyword">from</span> `guo`
7 Query       show table status like <span class="token string">'guo'</span>
7 Query       <span class="token function">SELECT</span> <span class="token operator">/</span>*<span class="token operator">!</span>40001 SQL_NO_CACHE <span class="token operator">*</span><span class="token operator">/</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> `guo`
7 Query       UNLOCK TABLES

sort_buffer_size     ： 排序缓冲区。 索引设计不好。    order by  desc <span class="token punctuation">(</span>8<span class="token punctuation">.</span>0解决<span class="token punctuation">)</span> 、<span class="token function">group</span> by 自动排序<span class="token punctuation">(</span>8<span class="token punctuation">.</span>0解决<span class="token punctuation">)</span> 
join_buffer_size     :  BNL  BKA 。  索引设计不好。   
read_rnd_buffer_size :  MRR 


优化目标： 越小越好。
方式： 1<span class="token punctuation">.</span> 减少排序结果集  2<span class="token punctuation">.</span> 优化索引<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="2-SQL层面"><a href="#2-SQL层面" class="headerlink" title="2-SQL层面"></a>2-SQL层面</h1><pre class="line-numbers language-powershell"><code class="language-powershell">query_cache_size :
作用：SQL层查询缓存，<span class="token function">select</span> HASH_ID <span class="token operator">+</span> 结果。

学员案例： 
案例 ： 开QC ，导致性能降低。 QPS ，TPS降低。
没开起的时候。QPS 2000 TPS 500 
开了之后直接降低到 800，200 

为什么呢？
分区表。Query Cache 不支持。
<span class="token function">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city where id=10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="1-InnoDB参数"><a href="#1-InnoDB参数" class="headerlink" title="1- InnoDB参数"></a>1- InnoDB参数</h2><pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token comment" spellcheck="true"># innodb_adaptive_hash_index （AHI） </span>
<span class="token comment" spellcheck="true"># innodb_buffer_pool_instances=4-8个</span>
<span class="token comment" spellcheck="true"># innodb_buffer_pool_size =50%-80%，建议不要超过75% </span>
<span class="token comment" spellcheck="true"># innodb_file_per_table  # 独立表空间</span>
<span class="token comment" spellcheck="true"># innodb_data_file_path # 共享表空间，建议2-3个  512M-4G</span>
<span class="token comment" spellcheck="true"># innodb_doublewrite    </span>
<span class="token comment" spellcheck="true"># 双写。8.0.20之前在，ibdataN ,2M空间。checkpoint时，分两次，每次1M写入DWB。然后刷脏页到ibd</span>
<span class="token comment" spellcheck="true"># innodb_flush_log_at_trx_commit</span>
<span class="token comment" spellcheck="true"># 双一之一： </span>
    1<span class="token punctuation">.</span> 每次事务提交，立即触发刷写，立即fsync<span class="token punctuation">(</span><span class="token punctuation">)</span>将redo落盘。
    0<span class="token punctuation">.</span> 每秒事务提交，立即触发刷写，立即fsync<span class="token punctuation">(</span><span class="token punctuation">)</span>将redo落盘。 
    2<span class="token punctuation">.</span> 每次事务提交，立即触发刷写OS cache，每秒fsync<span class="token punctuation">(</span><span class="token punctuation">)</span>将redo落盘。 

<span class="token comment" spellcheck="true"># innodb_flush_method</span>
  fsync   :  redo和数据刷盘都经历OS cache，再到磁盘
  O_Direct： 数据直接刷盘，日志经历OS cache ，再到磁盘<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-看磁盘类型设置"><a href="#2-看磁盘类型设置" class="headerlink" title="2-看磁盘类型设置"></a>2-看磁盘类型设置</h2><pre><code>innodb_io_capacity  #一次性写多少到磁盘 并发多少数据也
innodb_io_capacity_max

| innodb_io_capacity                                       | 200                                                                                      |
| innodb_io_capacity_max                                   | 2000   </code></pre><h2 id="3-锁等待时间。"><a href="#3-锁等待时间。" class="headerlink" title="3-锁等待时间。"></a>3-锁等待时间。</h2><pre><code>innodb_lock_wait_timeout=10</code></pre><h2 id="4-redo有关-，TPS有关"><a href="#4-redo有关-，TPS有关" class="headerlink" title="4- redo有关 ，TPS有关"></a>4- redo有关 ，TPS有关</h2><pre class="line-numbers language-powershell"><code class="language-powershell">innodb_log_buffer_size=文件倍数   
innodb_log_file_size=512M<span class="token operator">-</span>4G
innodb_log_files_in_group=2<span class="token operator">-</span>4组         



<span class="token comment" spellcheck="true"># checkpoint 相关机制</span>
<span class="token comment" spellcheck="true"># 1. sharp ckpt （必然发生的）</span>
数据库关机触发。

<span class="token comment" spellcheck="true"># 2. fuzzy ckpt （可能发生的）</span>
<span class="token comment" spellcheck="true"># master thread checkpoint</span>
每1秒有可能
每10秒有可能

<span class="token comment" spellcheck="true"># flush_lru_list checkpoint</span>
innodb_lru_scan_depth=1024

<span class="token comment" spellcheck="true"># async/sync flush checkpoint</span>
2个redo <span class="token punctuation">,</span>1G ==>    2G
75<span class="token operator">%</span>    1<span class="token punctuation">.</span>5G    <span class="token operator">--</span><span class="token operator">-</span>》 可能发生的
90<span class="token operator">%</span>    1<span class="token punctuation">.</span>8G    <span class="token operator">--</span><span class="token operator">-</span>》 必然


<span class="token comment" spellcheck="true"># dirty page too much checkpoint</span>
innodb_max_dirty_pages_pct=75<span class="token operator">%</span>  

<span class="token comment" spellcheck="true"># innodb_open_files   InnoDB能够打开文件句柄。</span>

<span class="token comment" spellcheck="true"># innodb_temp_data_file_path               | ibtmp1:12M:autoextend  |</span>


<span class="token comment" spellcheck="true"># undo 的设置：3-4个,1-4G左右</span>
innodb_max_undo_log_size                  <span class="token punctuation">|</span> 1073741824 <span class="token punctuation">|</span>
innodb_undo_directory                     <span class="token punctuation">|</span> <span class="token punctuation">.</span><span class="token operator">/</span>         <span class="token punctuation">|</span>
innodb_undo_log_truncate                 <span class="token punctuation">|</span> OFF        <span class="token punctuation">|</span>
innodb_undo_logs                        <span class="token punctuation">|</span> 128        <span class="token punctuation">|</span>
innodb_undo_tablespaces                  <span class="token punctuation">|</span> 0          <span class="token punctuation">|</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="3-业务层面优化建议"><a href="#3-业务层面优化建议" class="headerlink" title="3-业务层面优化建议"></a>3-业务层面优化建议</h1><pre class="line-numbers language-powershell"><code class="language-powershell">  用户权限优化建议 
规范： 
     1<span class="token punctuation">.</span> 用户要和业务有关。
     例如：zbx_user  zbx_admin <span class="token punctuation">.</span><span class="token punctuation">.</span>
     2<span class="token punctuation">.</span> 密码复杂度
     建议3种复杂度，12位以上。
     定期进行更改。
     3<span class="token punctuation">.</span>用户密码专人管理，超级管理员多人持有部分。
     4<span class="token punctuation">.</span>开发或业务用户，不直接登陆数据库。经过审计平台、堡垒机等机制。
     5<span class="token punctuation">.</span> 权限最小化。
3<span class="token punctuation">.</span>4<span class="token punctuation">.</span>2 SQL规范 
     1<span class="token punctuation">.</span> schema 设计
        库： 大小写、业务相关、字符集、校对规则。
        表： 一大堆规范、范式。    
     2<span class="token punctuation">.</span> DROP操作避免使用
     3<span class="token punctuation">.</span> ON<span class="token operator">-</span>DDL
     4<span class="token punctuation">.</span> SQL 优化
     5<span class="token punctuation">.</span> 合理的优化器算法
     6<span class="token punctuation">.</span> 大事务：批量更新、批量删除、批量的插入，夜里去做，拆分小事务。


3<span class="token punctuation">.</span>4<span class="token punctuation">.</span>3 索引引用
    聚簇索引数字自增
    降低索引树高度
    联合索引覆盖长度
    减少回表。
    创建索引规范。
    不走索引情况。
    慢日志分析。

3<span class="token punctuation">.</span>4<span class="token punctuation">.</span>4 锁方面优化 


3<span class="token punctuation">.</span>5 架构优化 
主从       ：5<span class="token punctuation">.</span>7 以上GTID 。 
高可用     : MHA 、PXC 、ORCH 、InnoDB CLuster（MGR）
读写分离   : ProxySQL  
分布式架构 : Mycat 、 DBLE

NoSQL 架构 ：MongoDB、Redis、ES<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="1-锁的监控及处理思路"><a href="#1-锁的监控及处理思路" class="headerlink" title="1-锁的监控及处理思路"></a>1-锁的监控及处理思路</h2><pre class="line-numbers language-powershell"><code class="language-powershell">背景: 
硬件环境: DELL R720<span class="token punctuation">,</span>E系列16核<span class="token punctuation">,</span>96G MEM<span class="token punctuation">,</span>SAS<span class="token operator">*</span>900G<span class="token operator">*</span>6<span class="token punctuation">,</span>RAID10
在例行巡检时<span class="token punctuation">,</span>发现9<span class="token operator">-</span>11点时间段的CPU压力非常高<span class="token punctuation">(</span>80<span class="token operator">-</span>90<span class="token operator">%</span><span class="token punctuation">)</span>

2<span class="token punctuation">.</span> 项目的职责
    2<span class="token punctuation">.</span>1 通过top详细排查<span class="token punctuation">,</span>发现mysqld进程占比达到了700<span class="token operator">-</span>800<span class="token operator">%</span>
    2<span class="token punctuation">.</span>2 其中有量的CPU是被用作的SYS和WAIT<span class="token punctuation">,</span>us处于正常
    2<span class="token punctuation">.</span>3 怀疑是MySQL 锁 或者SQL语句出了问题
    2<span class="token punctuation">.</span>4 经过排查slowlog及锁等待情况<span class="token punctuation">,</span>发现有大量锁等待及少量慢语句    
    <span class="token punctuation">(</span>1<span class="token punctuation">)</span> pt<span class="token operator">-</span>query<span class="token operator">-</span>diagest 查看慢日志  
    <span class="token punctuation">(</span>2<span class="token punctuation">)</span> 锁等待有没有?
    db03 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span>>show status like <span class="token string">'innodb_row_lock%'</span><span class="token punctuation">;</span>
    <span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>
    <span class="token punctuation">|</span> Variable_name                 <span class="token punctuation">|</span> Value <span class="token punctuation">|</span>
    <span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>
    <span class="token punctuation">|</span> Innodb_row_lock_current_waits <span class="token punctuation">|</span> 0     <span class="token punctuation">|</span>
    <span class="token punctuation">|</span> Innodb_row_lock_time          <span class="token punctuation">|</span> 0     <span class="token punctuation">|</span>
    <span class="token punctuation">|</span> Innodb_row_lock_time_avg      <span class="token punctuation">|</span> 0     <span class="token punctuation">|</span>
    <span class="token punctuation">|</span> Innodb_row_lock_time_max      <span class="token punctuation">|</span> 0     <span class="token punctuation">|</span>
    <span class="token punctuation">|</span> Innodb_row_lock_waits         <span class="token punctuation">|</span> 0     <span class="token punctuation">|</span>
    <span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">+</span>
    情况一:
            有100多个current_waits<span class="token punctuation">,</span>说明当前很多锁等待情况
    情况二:
            1000多个lock_waits<span class="token punctuation">,</span>说明历史上发生过的锁等待很多
    2<span class="token punctuation">.</span>5 查看那个事务在等待<span class="token punctuation">(</span>被阻塞了<span class="token punctuation">)</span>
    2<span class="token punctuation">.</span>6 查看锁源事务信息<span class="token punctuation">(</span>谁锁的我<span class="token punctuation">)</span>
    2<span class="token punctuation">.</span>7 找到锁源的thread_id 
    2<span class="token punctuation">.</span>8 找到锁源的SQL语句
3<span class="token punctuation">.</span> 找到语句之后<span class="token punctuation">,</span>和应用开发人员进行协商   
    <span class="token punctuation">(</span>1<span class="token punctuation">)</span>
    开发人员描述<span class="token punctuation">,</span>此语句是事务挂起导致
    我们提出建议是临时<span class="token function">kill</span> 会话<span class="token punctuation">,</span>最终解决问题
    <span class="token punctuation">(</span>2<span class="token punctuation">)</span> 
    开发人员查看后<span class="token punctuation">,</span>发现是业务逻辑问题导致的死锁<span class="token punctuation">,</span>产生了大量锁等待
    临时解决方案<span class="token punctuation">,</span>将阻塞事务的会话<span class="token function">kill</span>掉<span class="token punctuation">.</span>
    最终解决方案<span class="token punctuation">,</span>修改代码中的业务逻辑
项目结果:
    经过排查处理<span class="token punctuation">,</span>锁等待的个数减少80<span class="token operator">%</span><span class="token punctuation">.</span>解决了CPU持续峰值的问题<span class="token punctuation">.</span>

    锁等待   db01 <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span>>show variables like <span class="token string">'innodb_lock_%'</span><span class="token punctuation">;</span>

    <span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span>+<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span><span class="token operator">+</span>
<span class="token punctuation">|</span> Variable_name                  <span class="token punctuation">|</span> Value <span class="token punctuation">|</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span>+<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span><span class="token operator">+</span>
<span class="token punctuation">|</span> innodb_lock_wait_timeout       <span class="token punctuation">|</span> 50    <span class="token punctuation">|</span>
<span class="token punctuation">|</span> innodb_locks_unsafe_for_binlog <span class="token punctuation">|</span> OFF   <span class="token punctuation">|</span>
<span class="token operator">+</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span>+<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span><span class="token operator">+</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-锁监控设计到的命令"><a href="#2-锁监控设计到的命令" class="headerlink" title="2-锁监控设计到的命令:"></a>2-锁监控设计到的命令:</h2><pre class="line-numbers language-mysql"><code class="language-mysql">db01 [test]>show status like '%Innodb_row_lock%';
| Variable_name                 | Value |
+-------------------------------+-------+
| Innodb_row_lock_current_waits | 1     |
| Innodb_row_lock_time          | 11019 |
| Innodb_row_lock_time_avg      | 5509  |
| Innodb_row_lock_time_max      | 11019 |
| Innodb_row_lock_waits         | 2     |
+-------------------------------+-------+

select * from information_schema.innodb_trx;

select * from sys.innodb_lock_waits;
db01 [information_schema]>select  locked_table,  locked_index , locked_type , waiting_trx_id , waiting_query,blocking_pid,sql_kill_blocking_query,sql_kill_blocking_connection from sys.innodb_lock_waits\G

*************************** 1. row ***************************
                locked_table: `oldboy`.`t_100w`
                locked_index: GEN_CLUST_INDEX
                 locked_type: RECORD
              waiting_trx_id: 36476
               waiting_query: delete from t_100w where id<100
                blocking_pid: 4159
     sql_kill_blocking_query: KILL QUERY 4159
sql_kill_blocking_connection: KILL 4159
1 row in set, 3 warnings (0.00 sec)



select * from performance_schema.threads;
db01 [oldboy]>select * from performance_schema.threads where  PROCESSLIST_ID=4159\G


*************************** 1. row ***************************
          THREAD_ID: 4184
               NAME: thread/sql/one_connection
               TYPE: FOREGROUND
     PROCESSLIST_ID: 4159
   PROCESSLIST_USER: root
   PROCESSLIST_HOST: localhost
     PROCESSLIST_DB: oldboy
PROCESSLIST_COMMAND: Query
   PROCESSLIST_TIME: 0
  PROCESSLIST_STATE: Sending data
   PROCESSLIST_INFO: select * from performance_schema.threads where  PROCESSLIST_ID=4159
   PARENT_THREAD_ID: NULL
               ROLE: NULL
       INSTRUMENTED: YES
            HISTORY: YES
    CONNECTION_TYPE: Socket
       THREAD_OS_ID: 23254
1 row in set (0.00 sec)

select * from performance_schema.events_statements_history;
db01 [oldboy]>select * from performance_schema.events_statements_history where THREAD_ID=4184\G



              THREAD_ID: 28
               EVENT_ID: 7
           END_EVENT_ID: 7
             EVENT_NAME: statement/sql/update
                 SOURCE: 
            TIMER_START: 155851067318000
              TIMER_END: 166897698699000
             TIMER_WAIT: 11046631381000
              LOCK_TIME: 93000000
               SQL_TEXT: NULL
                 DIGEST: ddce0acdde4f229129910fe210d79711
            DIGEST_TEXT: UPDATE `t100w` SET `num` = ? WHERE `id` = ? 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="4-MySQL-PT工具使用"><a href="#4-MySQL-PT工具使用" class="headerlink" title="4- MySQL PT工具使用"></a>4- MySQL PT工具使用</h1><pre><code>[root@db01 ~]# yum install -y percona-toolkit-3.1.0-2.el7.x86_64.rpm
</code></pre><h2 id="1-系统配置总览"><a href="#1-系统配置总览" class="headerlink" title="1. 系统配置总览"></a>1. 系统配置总览</h2><pre class="line-numbers language-powershell"><code class="language-powershell">pt<span class="token operator">-</span>summary 
作用： 系统同状态总览。


2<span class="token punctuation">.</span> 表归档：pt<span class="token operator">-</span>archiver
<span class="token comment" spellcheck="true"># 重要参数</span>
<span class="token operator">--</span>limit 100         每次取100行数据用pt<span class="token operator">-</span>archive处理    
<span class="token operator">--</span>txn<span class="token operator">-</span>size  100     设置100行为一个事务提交一次，    
<span class="token operator">--</span>where <span class="token string">'id&lt;3000'</span>   设置操作条件    
<span class="token operator">--</span>progress 5000     每处理5000行输出一次处理信息    
<span class="token operator">--</span>statistics        输出执行过程及最后的操作统计。
<span class="token operator">--</span>charset=UTF8      指定字符集为UTF8—这个最后加上不然可能出现乱码。    
<span class="token operator">--</span>bulk<span class="token operator">-</span>delete       批量删除source上的旧数据<span class="token punctuation">(</span>例如每次1000行的批量删除操作<span class="token punctuation">)</span>
<span class="token operator">--</span><span class="token keyword">for</span><span class="token operator">-</span>update：      在每个<span class="token function">select</span>语句后面加入<span class="token keyword">for</span> update
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-使用案例："><a href="#2-使用案例：" class="headerlink" title="2-使用案例："></a>2-使用案例：</h2><pre class="line-numbers language-mysql"><code class="language-mysql">归档到数据库(本地)

db01 [test]>grant all on *.* to root@'10.0.1.%' identified by '123';
---------------
db01 [world]>create table city2   like city ;
Query OK, 0 rows affected (0.06 sec)
---------------------------
pt-archiver --source h=10.0.1.51,D=world,t=city,u=root,p=123 --dest h=10.0.0.51,D=world,t=city2,u=root,p=123 --where 'id<1000' --no-check-charset --no-delete --limit=100 --commit-each --progress 200 --statistics

# 归档到数据库(异地) 3307 节点 远程登录用户
pt-archiver --source h=10.0.1.51,D=world,t=city,u=root,p=123 --dest h=10.0.1.51,D=world,t=city2,u=root,P=3307,p=123 --where 'id<1000' --no-check-charset --no-delete --limit=100 --commit-each --progress 200 --statistics

# 只清理数据  删除
pt-archiver --source h=10.0.0.51,D=world,t=city,u=root,p=123 --where 'id<1000' --purge --limit=1 --no-check-charset

# 只把数据导出到外部文件，但是不删除源表里的数据
pt-archiver --source h=10.0.1.51,D=world,t=city,u=root,p=123 --where 'id>900' --no-check-charset --no-delete --file="/tmp/archiver.csv" 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="3-pt-osc-Online-DDL"><a href="#3-pt-osc-Online-DDL" class="headerlink" title="3. pt-osc Online DDL"></a>3. pt-osc Online DDL</h2><pre class="line-numbers language-powershell"><code class="language-powershell">原理： 
1、检查更改表是否有主键或唯一索引，是否有触发器
2、检查修改表的表结构，创建一个临时表，在新表上执行ALTER TABLE语句
3、在源表上创建三个触发器分别对于INSERT UPDATE DELETE操作
4、从源表拷贝数据到临时表，在拷贝过程中，对源表的更新操作会写入到新建表中
5、将临时表和源表rename（需要元数据修改锁，需要短时间锁表）
6、删除源表和触发器，完成表结构的修改。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="4-pt-osc工具限制"><a href="#4-pt-osc工具限制" class="headerlink" title="4-pt-osc工具限制"></a>4-pt-osc工具限制</h2><pre class="line-numbers language-powershell"><code class="language-powershell">1、源表必须有主键或唯一索引，如果没有工具将停止工作
2、如果线上的复制环境过滤器操作过于复杂，工具将无法工作
3、如果开启复制延迟检查，但主从延迟时，工具将暂停数据拷贝工作
4、如果开启主服务器负载检查，但主服务器负载较高时，工具将暂停操作
5、当表使用外键时，如果未使用<span class="token operator">--</span>alter<span class="token operator">-</span>foreign<span class="token operator">-</span>keys<span class="token operator">-</span>method参数，工具将无法执行
6、只支持Innodb存储引擎表，且要求服务器上有该表1倍以上的空闲空间。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="5-pt-osc之alter语句限制"><a href="#5-pt-osc之alter语句限制" class="headerlink" title="5-pt-osc之alter语句限制"></a>5-pt-osc之alter语句限制</h2><pre class="line-numbers language-powershell"><code class="language-powershell">1、不需要包含alter table关键字，可以包含多个修改操作，使用逗号分开，如<span class="token string">"drop clolumn c1, add column c2 int"</span>
2、不支持rename语句来对表进行重命名操作
3、不支持对索引进行重命名操作
4、如果删除外键，需要对外键名加下划线，如删除外键fk_uid<span class="token punctuation">,</span> 修改语句为<span class="token string">"DROP FOREIGN KEY _fk_uid"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="6-pt-osc之命令模板"><a href="#6-pt-osc之命令模板" class="headerlink" title="6-pt-osc之命令模板"></a>6-pt-osc之命令模板</h2><pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token comment" spellcheck="true">## --execute表示执行</span>
<span class="token comment" spellcheck="true">## --dry-run表示只进行模拟测试</span>
<span class="token comment" spellcheck="true">## 表名只能使用参数t来设置，没有长参数</span>
pt<span class="token operator">-</span>online<span class="token operator">-</span>schema<span class="token operator">-</span>change \
<span class="token operator">--</span>host=<span class="token string">"127.0.0.1"</span> \
<span class="token operator">--</span>port=3358 \
<span class="token operator">--</span>user=<span class="token string">"root"</span> \
<span class="token operator">--</span>password=<span class="token string">"root@root"</span> \
<span class="token operator">--</span>charset=<span class="token string">"utf8"</span> \
<span class="token operator">--</span>max<span class="token operator">-</span>lag=10 \
<span class="token operator">--</span>check<span class="token operator">-</span>salve<span class="token operator">-</span>lag=<span class="token string">'xxx.xxx.xxx.xxx'</span> \
<span class="token operator">--</span>recursion<span class="token operator">-</span>method=<span class="token string">"hosts"</span> \
<span class="token operator">--</span>check<span class="token operator">-</span>interval=2 \
<span class="token operator">--</span>database=<span class="token string">"testdb1"</span> \
 t=<span class="token string">"tb001"</span> \
<span class="token operator">--</span>alter=<span class="token string">"add column c4 int"</span> \
<span class="token operator">--</span>execute

例子：
pt<span class="token operator">-</span>online<span class="token operator">-</span>schema<span class="token operator">-</span>change <span class="token operator">--</span>user=root <span class="token operator">--</span>password=123 <span class="token operator">--</span>host=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>51 <span class="token operator">--</span>alter <span class="token string">"add column age int default 0"</span> D=world<span class="token punctuation">,</span>t=city <span class="token operator">--</span>print <span class="token operator">--</span>execute
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="5-主从一致性校验"><a href="#5-主从一致性校验" class="headerlink" title="5-主从一致性校验"></a>5-主从一致性校验</h1><pre class="line-numbers language-powershell"><code class="language-powershell">（1） 创建数据库
Create database pt CHARACTER <span class="token function">SET</span> utf8<span class="token punctuation">;</span>


<span class="token comment" spellcheck="true"># 创建用户checksum并授权</span>
GRANT ALL ON <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> TO <span class="token string">'checksum'</span>@<span class="token string">'10.0.1.%'</span> IDENTIFIED BY <span class="token string">'checksum'</span><span class="token punctuation">;</span>
flush privileges<span class="token punctuation">;</span>

<span class="token operator">--</span><span class="token namespace">[no]</span>check<span class="token operator">-</span>replication<span class="token operator">-</span>filters：是否检查复制的过滤器，默认是yes，建议启用不检查模式。
<span class="token operator">--</span>databases <span class="token punctuation">|</span> <span class="token operator">-</span>d：指定需要被检查的数据库，多个库之间可以用逗号分隔。
<span class="token operator">--</span><span class="token namespace">[no]</span>check<span class="token operator">-</span>binlog<span class="token operator">-</span>format：是否检查binlog文件的格式，默认值yes。建议开启不检查。因为在默认的row格式下会出错。
<span class="token operator">--</span>replicate：把checksum的信息写入到指定表中。
<span class="token operator">--</span>replicate<span class="token operator">-</span>check<span class="token operator">-</span>only：只显示不同步信息
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="1-小坑"><a href="#1-小坑" class="headerlink" title="1-小坑"></a>1-小坑</h2><pre class="line-numbers language-powershell"><code class="language-powershell">所有库： 
autocommit=1

从库 ： 
report_host=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>51
report_port=3309

<span class="token comment" spellcheck="true"># 应用：</span>
针对表校验： 
pt<span class="token operator">-</span>table<span class="token operator">-</span>checksum <span class="token operator">--</span>nocheck<span class="token operator">-</span>replication<span class="token operator">-</span>filters <span class="token operator">--</span>no<span class="token operator">-</span>check<span class="token operator">-</span>binlog<span class="token operator">-</span>format <span class="token operator">--</span>replicate=pt<span class="token punctuation">.</span>checksums <span class="token operator">--</span>create<span class="token operator">-</span>replicate<span class="token operator">-</span>table <span class="token operator">--</span>databases=taobao <span class="token operator">--</span>tables=a h=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>51<span class="token punctuation">,</span>u=checksum<span class="token punctuation">,</span>p=checksum<span class="token punctuation">,</span>P=3307



针对库校验： 
pt<span class="token operator">-</span>table<span class="token operator">-</span>checksum <span class="token operator">--</span>nocheck<span class="token operator">-</span>replication<span class="token operator">-</span>filters <span class="token operator">--</span>no<span class="token operator">-</span>check<span class="token operator">-</span>binlog<span class="token operator">-</span>format <span class="token operator">--</span>replicate=pt<span class="token punctuation">.</span>checksums <span class="token operator">--</span>create<span class="token operator">-</span>replicate<span class="token operator">-</span>table <span class="token operator">--</span>databases=test  h=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">.</span>51<span class="token punctuation">,</span>u=checksum<span class="token punctuation">,</span>p=checksum<span class="token punctuation">,</span>P=3306
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-脚本模板："><a href="#2-脚本模板：" class="headerlink" title="2-脚本模板："></a>2-脚本模板：</h2><pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token comment" spellcheck="true">#!/bin/bash</span>
date >> <span class="token operator">/</span>root<span class="token operator">/</span>db<span class="token operator">/</span>checksum<span class="token punctuation">.</span>log
pt<span class="token operator">-</span>table<span class="token operator">-</span>checksum <span class="token operator">--</span>nocheck<span class="token operator">-</span>binlog<span class="token operator">-</span>format <span class="token operator">--</span>nocheck<span class="token operator">-</span>plan
<span class="token operator">--</span>nocheck<span class="token operator">-</span>replication<span class="token operator">-</span>filters <span class="token operator">--</span>replicate=pt<span class="token punctuation">.</span>checksums <span class="token operator">--</span><span class="token function">set</span><span class="token operator">-</span>vars
innodb_lock_wait_timeout=120 <span class="token operator">--</span>databases test <span class="token operator">-</span>u<span class="token string">'checksum'</span> <span class="token operator">-</span>p<span class="token string">'checksum'</span>
<span class="token operator">-</span>h<span class="token string">'10.0.0.11'</span> >> <span class="token operator">/</span>root<span class="token operator">/</span>db<span class="token operator">/</span>checksum<span class="token punctuation">.</span>log
date >> <span class="token operator">/</span>root<span class="token operator">/</span>db<span class="token operator">/</span>checksum<span class="token punctuation">.</span>log

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="6-pt-table-sync"><a href="#6-pt-table-sync" class="headerlink" title="6-pt-table-sync"></a>6-pt-table-sync</h1><pre class="line-numbers language-powershell"><code class="language-powershell">主要参数介绍
<span class="token operator">--</span>replicate ：指定通过pt<span class="token operator">-</span>table<span class="token operator">-</span>checksum得到的表<span class="token punctuation">.</span>
<span class="token operator">--</span>databases : 指定执行同步的数据库。
<span class="token operator">--</span>tables ：指定执行同步的表，多个用逗号隔开。
<span class="token operator">--</span>sync<span class="token operator">-</span>to<span class="token operator">-</span>master ：指定一个DSN，即从的IP，他会通过show processlist或show slave status 去自动的找主。
h= ：服务器地址，命令里有2个ip，第一次出现的是Master的地址，第2次是Slave的地址。
u= ：帐号。
p= ：密码。
<span class="token operator">--</span>print ：打印，但不执行命令。
<span class="token operator">--</span>execute ：执行命令。
pt<span class="token operator">-</span>table<span class="token operator">-</span>sync <span class="token operator">--</span>replicate=pt<span class="token punctuation">.</span>checksums h=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>51<span class="token punctuation">,</span>u=root<span class="token punctuation">,</span>p=123<span class="token punctuation">,</span>P=3307 <span class="token operator">--</span>print
pt<span class="token operator">-</span>table<span class="token operator">-</span>sync <span class="token operator">--</span>replicate=pt<span class="token punctuation">.</span>checksums h=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>51<span class="token punctuation">,</span>u=root<span class="token punctuation">,</span>p=123<span class="token punctuation">,</span>P=3307 <span class="token operator">--</span>execute
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="1-显示主从结构：pt-slave-find"><a href="#1-显示主从结构：pt-slave-find" class="headerlink" title="1-显示主从结构：pt-slave-find"></a>1-显示主从结构：pt-slave-find</h2><pre class="line-numbers language-powershell"><code class="language-powershell"><span class="token namespace">[root@db01 tmp]</span><span class="token comment" spellcheck="true"># pt-slave-find -h10.0.0.51  -P3307 -uchecksum -pchecksum</span>
10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>51
Version         5<span class="token punctuation">.</span>7<span class="token punctuation">.</span>28<span class="token operator">-</span>log
Server ID       51
Uptime          27:57 <span class="token punctuation">(</span>started 2020<span class="token operator">-</span>05<span class="token operator">-</span>15T13:24:15<span class="token punctuation">)</span>
Replication     Is not a slave<span class="token punctuation">,</span> has 1 slaves connected<span class="token punctuation">,</span> is not read_only
Filters         
Binary logging  ROW
Slave status    
Slave mode      STRICT
Auto<span class="token operator">-</span>increment  increment 1<span class="token punctuation">,</span> offset 1
InnoDB version  5<span class="token punctuation">.</span>7<span class="token punctuation">.</span>28

<span class="token operator">+</span><span class="token operator">-</span> 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>52
   Version         5<span class="token punctuation">.</span>7<span class="token punctuation">.</span>28<span class="token operator">-</span>log
   Server ID       52
   Uptime          28:18 <span class="token punctuation">(</span>started 2020<span class="token operator">-</span>05<span class="token operator">-</span>15T13:23:54<span class="token punctuation">)</span>
   Replication     Is a slave<span class="token punctuation">,</span> has 0 slaves connected<span class="token punctuation">,</span> is not read_only
   Filters         
   Binary logging  ROW
   Slave status    0 seconds behind<span class="token punctuation">,</span> running<span class="token punctuation">,</span> no errors
   Slave mode      STRICT
   Auto<span class="token operator">-</span>increment  increment 1<span class="token punctuation">,</span> offset 1
   InnoDB version  5<span class="token punctuation">.</span>7<span class="token punctuation">.</span>28
<span class="token namespace">[root@db01 tmp]</span><span class="token comment" spellcheck="true"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-检查指定表的重复索引"><a href="#2-检查指定表的重复索引" class="headerlink" title="2-检查指定表的重复索引"></a>2-检查指定表的重复索引</h2><pre class="line-numbers language-powershell"><code class="language-powershell">pt<span class="token operator">-</span>duplicate<span class="token operator">-</span>key<span class="token operator">-</span>checker 

db01 <span class="token namespace">[world]</span>>alter table city add index idx<span class="token punctuation">(</span>countrycode<span class="token punctuation">,</span>population<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token namespace">[root@db01 tmp]</span><span class="token comment" spellcheck="true">#pt-duplicate-key-checker  --host=10.0.1.61 --user='checksum' --password='checksum'  --databases=world --tables=city</span>
<span class="token comment" spellcheck="true"># ########################################################################</span>
<span class="token comment" spellcheck="true"># world.city                                                              </span>
<span class="token comment" spellcheck="true"># ########################################################################</span>


<span class="token comment" spellcheck="true"># CountryCode is a left-prefix of idx</span>
<span class="token comment" spellcheck="true"># Key definitions:</span>
<span class="token comment" spellcheck="true">#   KEY `CountryCode` (`CountryCode`),</span>
<span class="token comment" spellcheck="true">#   KEY `idx` (`CountryCode`,`Population`),</span>
<span class="token comment" spellcheck="true"># Column types:</span>
<span class="token comment" spellcheck="true">#      `countrycode` char(3) not null default ''</span>
<span class="token comment" spellcheck="true">#      `population` int(11) not null default '0'</span>
<span class="token comment" spellcheck="true"># To remove this duplicate index, execute:</span>
ALTER TABLE `world`<span class="token punctuation">.</span>`city` DROP INDEX `CountryCode`<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true"># ########################################################################</span>
<span class="token comment" spellcheck="true"># Summary of indexes                                                      </span>
<span class="token comment" spellcheck="true"># ########################################################################</span>

<span class="token comment" spellcheck="true"># Size Duplicate Indexes   12564</span>
<span class="token comment" spellcheck="true"># Total Duplicate Indexes  1</span>
<span class="token comment" spellcheck="true"># Total Indexes            4</span>
<span class="token namespace">[root@db01 tmp]</span><span class="token comment" spellcheck="true"># </span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="3-监控主从延时"><a href="#3-监控主从延时" class="headerlink" title="3- 监控主从延时"></a>3- 监控主从延时</h2><pre class="line-numbers language-powershell"><code class="language-powershell">pt<span class="token operator">-</span>heartbeat 

主库： 
pt<span class="token operator">-</span>heartbeat <span class="token operator">--</span>user=root <span class="token operator">--</span>ask<span class="token operator">-</span>pass <span class="token operator">--</span>host=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">.</span>61 <span class="token operator">--</span>port=3307   <span class="token operator">--</span>create<span class="token operator">-</span>table <span class="token operator">-</span>D taobao   <span class="token operator">--</span>interval=1  <span class="token operator">--</span>update  <span class="token operator">--</span>replace  <span class="token operator">--</span>daemonize


从库： 

pt<span class="token operator">-</span>heartbeat <span class="token operator">--</span>user=root <span class="token operator">--</span>ask<span class="token operator">-</span>pass <span class="token operator">--</span>host=10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">.</span>61 <span class="token operator">--</span>port=3309  <span class="token operator">-</span>D taobao <span class="token operator">--</span>table=heartbeat <span class="token operator">--</span>monitor 


8<span class="token punctuation">.</span> <span class="token comment" spellcheck="true"># pt-show-grants</span>
pt<span class="token operator">-</span>show<span class="token operator">-</span>grants <span class="token operator">-</span>h10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token punctuation">.</span>51  <span class="token operator">-</span>P3307  <span class="token operator">-</span>uchecksum <span class="token operator">-</span>pchecksum 


<span class="token operator">--</span> Grants dumped by pt<span class="token operator">-</span>show<span class="token operator">-</span>grants
<span class="token operator">--</span> Dumped <span class="token keyword">from</span> server 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>51 via TCP<span class="token operator">/</span>IP<span class="token punctuation">,</span> MySQL 5<span class="token punctuation">.</span>7<span class="token punctuation">.</span>28<span class="token operator">-</span>log at 2020<span class="token operator">-</span>05<span class="token operator">-</span>15 17:11:06
<span class="token operator">--</span> Grants <span class="token keyword">for</span> <span class="token string">'checksum'</span>@<span class="token string">'10.0.0.%'</span>
CREATE USER <span class="token keyword">IF</span> NOT EXISTS <span class="token string">'checksum'</span>@<span class="token string">'10.0.0.%'</span><span class="token punctuation">;</span>
ALTER USER <span class="token string">'checksum'</span>@<span class="token string">'10.0.0.%'</span> IDENTIFIED WITH <span class="token string">'mysql_native_password'</span> AS <span class="token string">'*E5E390AF1BDF241B51D9C0DBBEA262CC9407A2DF'</span> REQUIRE NONE PASSWORD EXPIRE DEFAULT ACCOUNT UNLOCK<span class="token punctuation">;</span>
GRANT ALL PRIVILEGES ON <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> TO <span class="token string">'checksum'</span>@<span class="token string">'10.0.0.%'</span><span class="token punctuation">;</span>
<span class="token operator">--</span> Grants <span class="token keyword">for</span> <span class="token string">'mysql.session'</span>@<span class="token string">'localhost'</span>
CREATE USER <span class="token keyword">IF</span> NOT EXISTS <span class="token string">'mysql.session'</span>@<span class="token string">'localhost'</span><span class="token punctuation">;</span>
ALTER USER <span class="token string">'mysql.session'</span>@<span class="token string">'localhost'</span> IDENTIFIED WITH <span class="token string">'mysql_native_password'</span> AS <span class="token string">'*THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE'</span> REQUIRE NONE PASSWORD EXPIRE DEFAULT ACCOUNT LOCK<span class="token punctuation">;</span>
GRANT <span class="token function">SELECT</span> ON `mysql`<span class="token punctuation">.</span>`user` TO <span class="token string">'mysql.session'</span>@<span class="token string">'localhost'</span><span class="token punctuation">;</span>
GRANT <span class="token function">SELECT</span> ON `performance_schema`<span class="token punctuation">.</span><span class="token operator">*</span> TO <span class="token string">'mysql.session'</span>@<span class="token string">'localhost'</span><span class="token punctuation">;</span>
GRANT SUPER ON <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> TO <span class="token string">'mysql.session'</span>@<span class="token string">'localhost'</span><span class="token punctuation">;</span>
<span class="token operator">--</span> Grants <span class="token keyword">for</span> <span class="token string">'mysql.sys'</span>@<span class="token string">'localhost'</span>
CREATE USER <span class="token keyword">IF</span> NOT EXISTS <span class="token string">'mysql.sys'</span>@<span class="token string">'localhost'</span><span class="token punctuation">;</span>
ALTER USER <span class="token string">'mysql.sys'</span>@<span class="token string">'localhost'</span> IDENTIFIED WITH <span class="token string">'mysql_native_password'</span> AS <span class="token string">'*THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE'</span> REQUIRE NONE PASSWORD EXPIRE DEFAULT ACCOUNT LOCK<span class="token punctuation">;</span>
GRANT <span class="token function">SELECT</span> ON `sys`<span class="token punctuation">.</span>`sys_config` TO <span class="token string">'mysql.sys'</span>@<span class="token string">'localhost'</span><span class="token punctuation">;</span>
GRANT TRIGGER ON `sys`<span class="token punctuation">.</span><span class="token operator">*</span> TO <span class="token string">'mysql.sys'</span>@<span class="token string">'localhost'</span><span class="token punctuation">;</span>
GRANT USAGE ON <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> TO <span class="token string">'mysql.sys'</span>@<span class="token string">'localhost'</span><span class="token punctuation">;</span>
<span class="token operator">--</span> Grants <span class="token keyword">for</span> <span class="token string">'repl'</span>@<span class="token string">'10.0.0.%'</span>
CREATE USER <span class="token keyword">IF</span> NOT EXISTS <span class="token string">'repl'</span>@<span class="token string">'10.0.0.%'</span><span class="token punctuation">;</span>
ALTER USER <span class="token string">'repl'</span>@<span class="token string">'10.0.0.%'</span> IDENTIFIED WITH <span class="token string">'mysql_native_password'</span> AS <span class="token string">'*23AE809DDACAF96AF0FD78ED04B6A265E05AA257'</span> REQUIRE NONE PASSWORD EXPIRE DEFAULT ACCOUNT UNLOCK<span class="token punctuation">;</span>
GRANT REPLICATION SLAVE ON <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> TO <span class="token string">'repl'</span>@<span class="token string">'10.0.0.%'</span><span class="token punctuation">;</span>
<span class="token operator">--</span> Grants <span class="token keyword">for</span> <span class="token string">'root'</span>@<span class="token string">'10.0.0.%'</span>
CREATE USER <span class="token keyword">IF</span> NOT EXISTS <span class="token string">'root'</span>@<span class="token string">'10.0.0.%'</span><span class="token punctuation">;</span>
ALTER USER <span class="token string">'root'</span>@<span class="token string">'10.0.0.%'</span> IDENTIFIED WITH <span class="token string">'mysql_native_password'</span> AS <span class="token string">'*23AE809DDACAF96AF0FD78ED04B6A265E05AA257'</span> REQUIRE NONE PASSWORD EXPIRE DEFAULT ACCOUNT UNLOCK<span class="token punctuation">;</span>
GRANT ALL PRIVILEGES ON <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> TO <span class="token string">'root'</span>@<span class="token string">'10.0.0.%'</span><span class="token punctuation">;</span>
<span class="token operator">--</span> Grants <span class="token keyword">for</span> <span class="token string">'root'</span>@<span class="token string">'localhost'</span>
CREATE USER <span class="token keyword">IF</span> NOT EXISTS <span class="token string">'root'</span>@<span class="token string">'localhost'</span><span class="token punctuation">;</span>
ALTER USER <span class="token string">'root'</span>@<span class="token string">'localhost'</span> IDENTIFIED WITH <span class="token string">'mysql_native_password'</span> AS <span class="token string">'*23AE809DDACAF96AF0FD78ED04B6A265E05AA257'</span> REQUIRE NONE PASSWORD EXPIRE DEFAULT ACCOUNT UNLOCK<span class="token punctuation">;</span>
GRANT ALL PRIVILEGES ON <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> TO <span class="token string">'root'</span>@<span class="token string">'localhost'</span> WITH GRANT OPTION<span class="token punctuation">;</span>
GRANT PROXY ON <span class="token string">''</span>@<span class="token string">''</span> TO <span class="token string">'root'</span>@<span class="token string">'localhost'</span> WITH GRANT OPTION<span class="token punctuation">;</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code>0.00s [ 20.10s,  4.02s,  1.34s ]
0.00s [ 20.10s,  4.02s,  1.34s ]
0.00s [ 20.10s,  4.02s,  1.34s ]
0.00s [ 20.10s,  4.02s,  1.34s ]
0.00s [ 20.10s,  4.02s,  1.34s ]
0.00s [ 20.10s,  4.02s,  1.34s ]
0.00s [ 20.10s,  4.02s,  1.34s ]
0.00s [ 20.10s,  4.02s,  1.34s ]
0.00s [ 20.10s,  4.02s,  1.34s ]
0.00s [ 20.10s,  4.02s,  1.34s ]
0.00s [ 20.10s,  4.02s,  1.34s ]
0.02s [ 20.10s,  4.02s,  1.34s ]
0.00s [ 20.10s,  4.02s,  1.34s ]
0.00s [ 20.10s,  4.02s,  1.34s ]
0.00s [ 20.10s,  4.02s,  1.34s ]
0.00s [ 20.10s,  4.02s,  1.34s ]
0.00s [ 20.10s,  4.02s,  1.34s ]
0.00s [ 20.10s,  4.02s,  1.34s ]
0.00s [ 20.10s,  4.02s,  1.34s ]
0.00s [ 20.10s,  4.02s,  1.34s ]
</code></pre><hr>
<pre><code># 给出参数建议： 
pt-variable-advisor 10.0.0.51 -uchecksum -pchecksum
</code></pre>
            </div>
            <hr />

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">写作不易，客官能否打赏一杯奶茶？</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《13-MySQL 全面优化+故障+PT工具使用》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/2020/05/18/01-yun-ji-suan-kvm-openstack/" property="cc:attributionName"
               rel="cc:attributionURL">
                小明
            </a> 采用
            <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    
    <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '',
        clientSecret: '',
        repo: 'godweiyang.github.io',
        owner: 'godweiyang',
        admin: "godweiyang",
        id: '2020/05/18/01-yun-ji-suan-kvm-openstack/',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    
    <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script> -->

<script>
    new Valine({
        el: '#vcomments',
        appId: '',
        appKey: '',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'false' === 'true',
        avatar: 'wavatar',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '如果你没有GitHub账号，还可以在这里评论啦！'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/05/19/11-mysql-zhu-cong-fu-zhi-gao-ji-jin-jie/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/3.jpg" class="responsive-img" alt="11-mysql-主从复制高级进阶">
                        
                        <span class="card-title">11-mysql-主从复制高级进阶</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            1-延时从库1-介绍
普通的主从复制，处理物理故障损坏比较擅长。
如果主库出现了DROP DATABASE操作。
延时从库： 主库做了某项操作之后，从库延时多长时间回放（SQL）。可以处理逻辑损坏。
2-配置mysql>stop slave
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-05-19
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/mysql/" class="post-category" target="_blank">
                                    mysql
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/leetcode/" target="_blank">
                        <span class="chip bg-color">leetcode</span>
                    </a>
                    
                    <a href="/tags/mysql/" target="_blank">
                        <span class="chip bg-color">mysql</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/05/17/12-fen-bu-shi-jia-gou-mycat/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="12分布式架构-Mycat">
                        
                        <span class="card-title">12分布式架构-Mycat</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            1-分布式架构-Mycat

基础环境准备




1.1 环境准备：两台虚拟机 db01 db02每台创建四个mysql实例：3307 3308 3309 3310


1-搭建开始1.2 删除历史环境：
pkill mysqld
rm 
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-05-17
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/mysql/" class="post-category" target="_blank">
                                    mysql
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/leetcode/" target="_blank">
                        <span class="chip bg-color">leetcode</span>
                    </a>
                    
                    <a href="/tags/mysql/" target="_blank">
                        <span class="chip bg-color">mysql</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('5')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 小明同学<br />'
            + '作者: 小明<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
    });
</script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>

<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>


    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            &copy; 2019-2020 小明. 版权所有

            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
            <span class="white-color">72.2k</span>
            

            <br>
            <span id="sitetime"></span>

            
            
            <br>
            
            <span id="busuanzi_container_site_pv" style='display:none'>
                <i class="fa fa-heart-o"></i>
                本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
            <span id="busuanzi_container_site_uv" style='display:none'>
                人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
            </span>
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/xiaoming" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:ye33445200@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="https://zhihu.com/people/xiaoming" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-inverse">知</i>
    </a>



    <a href="http://wpa.qq.com/msgrd?v=3&uin=970740860&site=qq&menu=yes" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>



    <a href="https://weibo.com/xiaoming" class="tooltipped" target="_blank" data-tooltip="关注我的微博" data-position="top" data-delay="50">
        <i class="fa fa-weibo"></i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 不蒜子计数初始值纠正 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);
        var pvcountOffset = 80000;
        var uvcountOffset = 20000;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int);
            }
        }
    });
</script>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2019, 04, 22, 00, 00, 00); //北京时间2020-04-22 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <script type="text/javascript"> var OriginTitile = document.title, st; document.addEventListener("visibilitychange", function () { document.hidden ? (document.title = "Σ(っ °Д °;)っ喔哟，崩溃啦！", clearTimeout(st)) : (document.title = "φ(゜▽゜*)♪咦，又好了！", st = setTimeout(function () { document.title = OriginTitile }, 3e3)) })
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', '');
</script>



    
    <script src="/libs/others/clicklove.js"></script>
    

    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 雪花特效 -->
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":200,"height":400},"mobile":{"show":true},"react":{"opacity":0.7}});</script></body>

</html>